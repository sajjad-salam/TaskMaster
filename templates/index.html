<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster - Task Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'ArabicCustom';
            src: url('/mainfont.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'ArabicCustom', 'Inter', sans-serif;
        }

        body[data-lang="ar"], body[lang="ar"] {
            direction: rtl;
        }

        body[data-lang="ar"] .header,
        body[data-lang="ar"] .stats-bar,
        body[data-lang="ar"] .folders-header,
        body[data-lang="ar"] .controls,
        body[data-lang="ar"] .filters {
            text-align: right;
        }

        body[data-lang="ar"] .filter-group {
            flex-direction: row;
        }

        body[data-lang="ar"] .todo-header {
            flex-direction: row;
        }

        body[data-lang="ar"] .todo-actions {
            margin-left: 0;
            margin-right: auto;
        }

        body[data-lang="ar"] .move-folder-global-dropdown {
            right: auto;
            left: 0;
        }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fafafa;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #86868b;
            --border-color: #e5e5e7;
            --border-color-light: #f0f0f2;
            --accent-color: #0071e3;
            --accent-hover: #0077ed;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            position: relative;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .language-switcher {
            display: none;
            position: absolute;
            top: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 4px;
        }

        .language-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.15s ease;
        }

        .language-btn:hover {
            color: var(--text-primary);
        }

        .language-btn.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .telegram-enabled {
            color: var(--success-color);
        }

        .telegram-disabled {
            color: var(--danger-color);
        }

        .telegram-pending {
            color: var(--warning-color);
        }

        .view-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 4px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .view-tab {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .view-tab:hover {
            color: var(--text-primary);
        }

        .view-tab.active {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .today-badge {
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .today-badge:empty {
            display: none;
        }

        /* Keyboard shortcuts hint */
        .keyboard-shortcuts-hint {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .shortcut-hint {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .shortcut-hint kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: 500;
            min-width: 20px;
            text-align: center;
        }

        .shortcuts-toggle {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            font-size: 0.8rem;
            opacity: 0.6;
            transition: opacity 0.15s ease;
        }

        .shortcuts-toggle:hover {
            opacity: 1;
        }

        /* RTL support for keyboard shortcuts */
        body[data-lang="ar"] .keyboard-shortcuts-hint {
            flex-direction: row;
        }

        body[data-lang="ar"] .shortcut-hint {
            flex-direction: row;
        }

        .main-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .stats-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 20px 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 24px;
        }

        .stat-item {
            padding: 0;
            background: none;
            text-align: center;
        }

        .stat-number {
            font-size: 1.75rem;
            font-weight: 600;
            display: block;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .controls {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
            font-size: 0.85rem;
        }

        select, input[type="text"], textarea {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            transition: all 0.15s ease;
            background: var(--bg-secondary);
            min-width: 120px;
            max-width: 100%;
            color: var(--text-primary);
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        select:hover, input[type="text"]:hover, textarea:hover {
            border-color: var(--text-tertiary);
        }

        select:focus, input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .add-todo-form {
            display: grid;
            grid-template-columns: repeat(5, 1fr) auto;
            gap: 12px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .folders-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        .folders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .folders-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .folder-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }

        .folder-card:hover {
            border-color: var(--accent-color);
        }

        .folder-card.active {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .folder-card.active .folder-name {
            color: var(--accent-color);
        }

        .folder-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--text-tertiary);
        }

        .folder-card.active .folder-icon {
            color: var(--accent-color);
        }

        .folder-name, .todo-title, .todo-description {
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: unset !important;
            display: block !important;
            word-break: break-word;
            max-width: 100%;
        }
        .folder-name {
            max-width: 180px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        .todo-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .todo-description {
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .folder-count {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .folder-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
        }

        .folder-card:hover .folder-actions {
            display: block;
        }

        .folder-actions button {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--danger-color);
        }

        .folder-actions button:hover {
            border-color: var(--danger-color);
        }

        .add-folder-btn {
            background: var(--bg-secondary);
            border: 1px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .add-folder-btn:hover {
            border-color: var(--text-tertiary);
            color: var(--text-primary);
        }

        .todos-container {
            padding: 24px;
        }

        .todo-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            cursor: grab;
            transition: all 0.15s ease;
            position: relative;
        }

        .todo-item:hover {
            border-color: var(--accent-color);
        }

        .todo-item.completed {
            background: var(--bg-tertiary);
        }

        .todo-item.completed .todo-title {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .todo-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .priority-badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .priority-high {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger-color);
        }

        .priority-medium {
            background: rgba(255, 149, 0, 0.1);
            color: var(--warning-color);
        }

        .priority-low {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
        }

        .category-badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .folder-badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            background: var(--accent-color);
            color: white;
        }

        .todo-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 2px solid var(--border-color-light);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: 10% auto;
            padding: 24px;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 440px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close {
            color: var(--text-tertiary);
            font-size: 24px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all 0.15s ease;
        }

        .close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .add-todo-form {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .todo-header {
                flex-direction: column;
                gap: 8px;
            }

            .todo-actions {
                margin-left: 0;
                justify-content: flex-end;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .folders-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }

            /* Responsive Kanban */
            .kanban-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .suggested-tasks-container {
                flex-direction: column;
            }

            .suggested-task-card {
                min-width: 100%;
                max-width: 100%;
            }

            .kanban-column {
                max-height: none;
            }

            .view-tabs {
                flex-wrap: wrap;
            }

            .view-tab {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 600px) {
            .todo-title, .todo-description {
                font-size: 1rem;
                max-width: 100%;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.info {
            background: var(--accent-color);
        }

        /* Limitar ancho del select de carpetas en el formulario de tareas */
        #todo-folder {
            max-width: 170px;
            min-width: 100px;
            width: 100%;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            display: block;
        }
        /* Truncar visualmente las opciones del select */
        #todo-folder option {
            max-width: 170px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Asegurar que el dropdown de mover tarea esté por encima de la tarjeta y otros elementos */
        .move-folder-dropdown {
            z-index: 9999 !important;
            pointer-events: none;
        }
        .move-folder-dropdown[style*='display: block'],
        .move-folder-dropdown[style*='display:block'] {
            pointer-events: auto;
        }
        /* Evitar que el overflow de la tarjeta o contenedores oculte el menú */
        .todo-item, .todos-container {
            overflow: visible !important;
        }

        /* ============ MULTI-SELECT STYLES ============ */

        /* Selection mode overlay */
        .selection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 1000;
            display: none;
            user-select: none;
        }

        .selection-overlay.active {
            display: block;
        }

        /* Selection box */
        .selection-box {
            position: fixed;
            border: 2px solid var(--accent-color);
            background: rgba(0, 113, 227, 0.1);
            pointer-events: none;
            z-index: 1001;
            display: none;
            border-radius: 4px;
        }

        .selection-box.active {
            display: block;
        }

        /* Checkbox for task selection */
        .todo-checkbox {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .todo-item:hover .todo-checkbox,
        .todo-item.selected .todo-checkbox,
        .selection-mode .todo-checkbox {
            opacity: 1;
        }

        /* Custom checkbox appearance */
        .todo-checkbox-wrapper {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            cursor: pointer;
            z-index: 9;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .todo-checkbox-wrapper:hover {
            border-color: var(--accent-color);
        }

        .todo-checkbox-wrapper.checked {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .todo-checkbox-wrapper.checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 12px;
        }

        /* Selected task styling */
        .todo-item.selected {
            border-color: var(--accent-color);
            background: rgba(0, 113, 227, 0.05);
        }

        .todo-item.selected .todo-checkbox-wrapper {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .todo-item.selected .todo-checkbox-wrapper::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 12px;
        }

        /* Keyboard focused task styling */
        .todo-item.keyboard-focused,
        .kanban-card.keyboard-focused,
        .suggested-task-card.keyboard-focused {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
            z-index: 10;
        }

        .todo-item.keyboard-focused .todo-checkbox-wrapper,
        .kanban-card.keyboard-focused .todo-checkbox-wrapper,
        .suggested-task-card.keyboard-focused .todo-checkbox-wrapper {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.3);
        }

        /* Adjust todo item padding for checkbox */
        .todo-item {
            padding-left: 48px;
        }

        /* Bulk action toolbar */
        .bulk-action-toolbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 1002;
            transition: transform 0.3s ease;
        }

        .bulk-action-toolbar.visible {
            transform: translateX(-50%) translateY(0);
        }

        .bulk-action-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .bulk-action-count {
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .bulk-action-buttons {
            display: flex;
            gap: 8px;
        }

        .bulk-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .bulk-action-btn.move {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .bulk-action-btn.move:hover {
            background: var(--bg-primary);
            border-color: var(--accent-color);
        }

        .bulk-action-btn.delete {
            background: var(--danger-color);
            color: white;
        }

        .bulk-action-btn.delete:hover {
            opacity: 0.9;
        }

        .bulk-action-btn.clear {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 8px;
        }

        .bulk-action-btn.clear:hover {
            color: var(--text-primary);
        }

        /* Bulk move dropdown */
        .bulk-move-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 8px;
            min-width: 200px;
            background: var(--bg-secondary);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            z-index: 1003;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
            display: none;
        }

        .bulk-move-dropdown.visible {
            display: block;
        }

        .bulk-move-dropdown .folder-option {
            padding: 10px 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bulk-move-dropdown .folder-option:hover {
            background: var(--bg-tertiary);
        }

        .bulk-move-dropdown .folder-option .folder-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Selection mode for Kanban */
        .kanban-card .todo-checkbox-wrapper {
            top: 8px;
            left: 8px;
        }

        .kanban-card .todo-checkbox {
            top: 8px;
            left: 8px;
        }

        .kanban-card {
            padding-left: 36px;
        }

        .kanban-card.selected {
            border-color: var(--accent-color);
            background: rgba(0, 113, 227, 0.05);
        }

        /* Suggested task selection */
        .suggested-task-card .todo-checkbox-wrapper {
            top: 8px;
            left: 8px;
        }

        .suggested-task-card .todo-checkbox {
            top: 8px;
            left: 8px;
        }

        .suggested-task-card {
            padding-left: 36px;
        }

        .suggested-task-card.selected {
            border-color: var(--accent-color);
            background: rgba(0, 113, 227, 0.05);
        }

        /* Select all checkbox */
        .select-all-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .select-all-container .todo-checkbox-wrapper {
            position: static;
        }

        .select-all-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
        }

        /* Menú flotante global para mover tarea */
        .move-folder-global-dropdown {
            position: absolute;
            left: 0;
            top: 0;
            min-width: 180px;
            background: var(--bg-secondary);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            z-index: 99999;
            max-height: 260px;
            overflow-y: auto;
            padding: 4px;
            animation: fadeIn 0.15s;
        }
        .move-folder-global-dropdown .move-folder-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: background 0.15s;
            white-space: nowrap;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .move-folder-global-dropdown .move-folder-option:hover {
            background: var(--bg-tertiary);
        }

        /* Kanban Board Styles */
        .kanban-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            padding: 24px;
            background: var(--bg-tertiary);
            align-items: start;
        }

        /* Daily Progress Bar */
        .daily-progress-section {
            grid-column: 1 / -1;
            margin-bottom: 16px;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .daily-progress-section.completed {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
            animation: celebrateCompletion 0.6s ease;
        }

        @keyframes celebrateCompletion {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .daily-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .daily-progress-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .daily-progress-title .icon {
            font-size: 1.1rem;
        }

        .daily-progress-section.completed .daily-progress-title .icon {
            animation: bounce 0.6s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .daily-progress-stats {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .daily-progress-section.completed .daily-progress-stats {
            color: var(--success-color);
        }

        .progress-bar-container {
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color) 0%, #8b5cf6 100%);
            border-radius: 10px;
            transition: width 0.5s ease, background 0.3s ease;
            position: relative;
            min-width: 0;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .daily-progress-section.completed .progress-bar-fill {
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
        }

        .daily-progress-empty {
            text-align: center;
            padding: 12px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .suggested-tasks-section {
            grid-column: 1 / -1;
            margin-bottom: 8px;
        }

        .suggested-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .suggested-tasks-header h3 {
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .suggested-tasks-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 8px 4px;
            min-height: 120px;
        }

        .suggested-task-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px;
            min-width: 240px;
            max-width: 280px;
            cursor: grab;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .suggested-task-card:hover {
            border-color: var(--accent-color);
        }

        .suggested-task-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .suggested-task-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .suggested-task-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .suggested-task-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .suggested-task-badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
        }

        .suggested-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.9rem;
        }

        .kanban-column {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            min-height: 400px;
            overflow: visible;
            position: relative;
        }

        /* Success flash animation for Done column */
        .kanban-column[data-status="done"].task-complete-flash {
            animation: successFlash 0.4s ease-out;
        }

        @keyframes successFlash {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
            30% {
                box-shadow: 0 0 30px 10px rgba(16, 185, 129, 0.4);
                border-color: rgba(16, 185, 129, 0.8);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        /* Confetti burst effect */
        .confetti-burst {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 2px;
            animation: confettiFall 0.6s ease-out forwards;
        }

        @keyframes confettiFall {
            0% {
                opacity: 1;
                transform: translate(0, 0) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), 40px) rotate(360deg);
            }
        }

        .kanban-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .kanban-header h3 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kanban-header .count {
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .kanban-cards {
            padding: 12px;
            background: var(--bg-tertiary);
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }

        .kanban-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px;
            margin-bottom: 0;
            cursor: grab;
            transition: all 0.15s ease;
        }

        .kanban-card:hover {
            border-color: var(--accent-color);
        }

        .kanban-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .todo-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .todo-item.drag-over {
            border-top: 3px solid var(--accent-color);
            margin-top: -3px;
        }

        .kanban-column.drag-over .kanban-cards {
            background: var(--bg-primary);
        }

        .kanban-card-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .kanban-card-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .kanban-card-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .kanban-card-badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Archive View Styles */
        .archive-container {
            padding: 24px;
        }

        .archive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .archive-header h2 {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .archive-actions {
            display: flex;
            gap: 8px;
        }

        .archive-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .archive-empty i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .archive-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--success-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.15s ease;
        }

        .archive-item:hover {
            border-color: var(--success-color);
        }

        .archive-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .archive-item-title {
            font-weight: 500;
            color: var(--text-primary);
            text-decoration: line-through;
            opacity: 0.6;
        }

        .archive-item-actions {
            display: flex;
            gap: 8px;
        }

        .archive-item-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .archive-date-header {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--border-color);
            padding: 12px 16px;
            margin: 24px 0 12px 0;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .archive-date-header:first-of-type {
            margin-top: 0;
        }

        .archive-date-header i {
            color: var(--primary-color);
        }

        /* Notes Styles */
        .notes-container {
            padding: 24px;
        }

        .notes-header {
            margin-bottom: 20px;
        }

        .notes-header h2 {
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .add-note-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 24px;
        }

        .note-input {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 12px;
            font-family: inherit;
            font-size: 0.95rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
        }

        .note-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .note-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            position: relative;
        }

        .note-content {
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 12px;
        }

        .note-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .note-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .note-buttons {
            display: flex;
            gap: 8px;
        }

        .note-buttons-vertical {
            flex-direction: column;
        }

        .note-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
        }

        .note-btn-copy {
            background: #f97316;
            color: white;
        }

        .note-btn-copy:hover {
            background: #ea580c;
        }

        .note-btn-delete {
            background: #ef4444;
            color: white;
        }

        .note-btn-delete:hover {
            background: #dc2626;
        }

        .notes-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .notes-empty i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        /* ============ MICRO-INTERACTIONS ============ */

        /* 1. Satisfying Checkbox Animation - Burst + Scale Effect */
        .checkbox-burst {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
        }

        .burst-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: burstExplode 0.6s ease-out forwards;
        }

        @keyframes burstExplode {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(0);
            }
        }

        /* Checkmark scale animation */
        .checkmark-scale {
            animation: checkmarkPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes checkmarkPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Completion ripple effect on todo item */
        .todo-item.completing {
            animation: completionPulse 0.5s ease-out;
        }

        @keyframes completionPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.7);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 20px 5px rgba(52, 199, 89, 0.3);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(52, 199, 89, 0);
            }
        }

        /* 2. Button Ripple Effects */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0);
            animation: rippleEffect 0.6s ease-out;
            pointer-events: none;
        }

        .btn-primary .ripple {
            background: rgba(255, 255, 255, 0.4);
        }

        .btn-secondary .ripple {
            background: rgba(0, 0, 0, 0.1);
        }

        .btn-danger .ripple {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-success .ripple {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes rippleEffect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* 3. Card Hover Micro-bounce */
        .todo-item {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .todo-item:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .folder-card {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .folder-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        .kanban-card {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .suggested-task-card {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .suggested-task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        /* 4. Progress Bar Fill Animation - Enhanced */
        .progress-bar-fill {
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1),
                        background 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent);
            animation: progressSweep 1.5s ease-in-out infinite;
        }

        @keyframes progressSweep {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .progress-bar-fill.updating {
            animation: progressPulse 0.3s ease-out;
        }

        @keyframes progressPulse {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
            100% { filter: brightness(1); }
        }

        /* 5. Number Counter Animation */
        .stat-number {
            transition: all 0.3s ease;
        }

        .stat-number.counting {
            animation: numberPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes numberPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); color: var(--accent-color); }
            100% { transform: scale(1); }
        }

        .stat-number.increase {
            animation: countUp 0.5s ease-out;
        }

        .stat-number.decrease {
            animation: countDown 0.5s ease-out;
        }

        @keyframes countUp {
            0% {
                transform: translateY(0);
                color: var(--text-primary);
            }
            50% {
                transform: translateY(-10px);
                color: var(--success-color);
            }
            100% {
                transform: translateY(0);
                color: var(--text-primary);
            }
        }

        @keyframes countDown {
            0% {
                transform: translateY(0);
                color: var(--text-primary);
            }
            50% {
                transform: translateY(10px);
                color: var(--warning-color);
            }
            100% {
                transform: translateY(0);
                color: var(--text-primary);
            }
        }

        /* Shake animation for decrease (pending tasks increase) */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .stat-number.shake {
            animation: shake 0.4s ease-in-out;
        }

        /* Folder card bounce on selection */
        .folder-card.selecting {
            animation: folderBounce 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes folderBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Success celebration for task completion */
        .success-stars {
            position: absolute;
            pointer-events: none;
            z-index: 1001;
        }

        .star-particle {
            position: absolute;
            font-size: 20px;
            animation: starFloat 0.8s ease-out forwards;
        }

        @keyframes starFloat {
            0% {
                opacity: 1;
                transform: translate(0, 0) rotate(0deg) scale(0);
            }
            50% {
                opacity: 1;
                transform: translate(var(--tx), var(--ty)) rotate(180deg) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx2), var(--ty2)) rotate(360deg) scale(0);
            }
        }

        /* Button press effect */
        .btn:active {
            transform: scale(0.97);
        }

        .view-tab:active {
            transform: scale(0.97);
        }

        /* Loading skeleton animation for stat updates */
        .stat-number.loading {
            background: linear-gradient(90deg,
                var(--bg-tertiary) 25%,
                var(--border-color-light) 50%,
                var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1s infinite;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent !important;
        }

        @keyframes skeletonShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Enhanced today badge animation */
        .today-badge {
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .today-badge.updated {
            animation: badgePop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes badgePop {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        /* Smooth fade for todo item removal */
        .todo-item.removing {
            animation: slideOut 0.3s ease-out forwards;
        }

        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(100%);
                height: 0;
                margin: 0;
                padding: 0;
            }
        }

        /* Todo item addition animation */
        .todo-item.adding {
            animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ========================================
           SMOOTH TRANSITIONS
           ======================================== */

        /* 1. View Switch Animation - Smooth slide/fade between views */
        .todos-container,
        .kanban-container,
        .archive-container,
        .notes-container {
            transition: opacity 0.3s ease, transform 0.3s ease, filter 0.3s ease;
        }

        .todos-container.fade-out,
        .kanban-container.fade-out,
        .archive-container.fade-out,
        .notes-container.fade-out {
            opacity: 0;
            transform: translateY(10px);
            filter: blur(2px);
            pointer-events: none;
        }

        .todos-container.fade-in,
        .kanban-container.fade-in,
        .archive-container.fade-in,
        .notes-container.fade-in {
            animation: viewFadeIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes viewFadeIn {
            from {
                opacity: 0;
                transform: translateY(-15px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* View tab indicator animation */
        .view-tab {
            position: relative;
            overflow: hidden;
        }

        .view-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--accent-color);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform: translateX(-50%);
        }

        .view-tab.active::after {
            width: 80%;
        }

        /* 2. Task Reorder Animation */
        .todo-item.reordering {
            animation: taskReorder 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes taskReorder {
            0% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
            50% { transform: translateY(2px) scale(0.98); }
            75% { transform: translateY(-1px) scale(1.01); }
            100% { transform: translateY(0) scale(1); }
        }

        .kanban-card.reordering {
            animation: kanbanReorder 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes kanbanReorder {
            0% { transform: scale(1); }
            30% { transform: scale(1.03); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12); }
            60% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }

        .kanban-card.dragging {
            animation: dragLift 0.3s ease forwards;
        }

        @keyframes dragLift {
            to {
                opacity: 0.8;
                transform: scale(1.05) rotate(2deg);
                box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            }
        }

        /* 3. Filter Transition */
        .todo-item.filtering-out {
            animation: filterSlideOut 0.3s ease-out forwards;
        }

        .todo-item.filtering-in {
            animation: filterSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes filterSlideOut {
            to {
                opacity: 0;
                transform: translateX(-30px) scale(0.9);
                height: 0;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
        }

        @keyframes filterSlideIn {
            0% { opacity: 0; transform: translateX(30px) scale(0.9); }
            60% { transform: translateX(-5px) scale(1.02); }
            100% { opacity: 1; transform: translateX(0) scale(1); }
        }

        .todo-item.stagger-1 { animation-delay: 0.05s; }
        .todo-item.stagger-2 { animation-delay: 0.1s; }
        .todo-item.stagger-3 { animation-delay: 0.15s; }
        .todo-item.stagger-4 { animation-delay: 0.2s; }
        .todo-item.stagger-5 { animation-delay: 0.25s; }

        .folder-card.filtering-out {
            animation: folderFilterOut 0.3s ease-out forwards;
        }

        .folder-card.filtering-in {
            animation: folderFilterIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes folderFilterOut {
            to { opacity: 0; transform: scale(0.8); height: 0; margin: 0; padding: 0; overflow: hidden; }
        }

        @keyframes folderFilterIn {
            0% { opacity: 0; transform: scale(0.8); }
            60% { transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* 4. Modal Backdrop Blur */
        .modal {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: opacity 0.3s ease, backdrop-filter 0.3s ease;
        }

        .modal.showing {
            animation: modalBackdropFadeIn 0.3s ease forwards;
        }

        .modal.hiding {
            animation: modalBackdropFadeOut 0.2s ease forwards;
        }

        @keyframes modalBackdropFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
                -webkit-backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
            }
        }

        @keyframes modalBackdropFadeOut {
            from {
                opacity: 1;
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
            }
            to {
                opacity: 0;
                backdrop-filter: blur(0px);
                -webkit-backdrop-filter: blur(0px);
            }
        }

        .modal.showing .modal-content {
            animation: modalContentSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .modal.hiding .modal-content {
            animation: modalContentSlideOut 0.2s ease forwards;
        }

        @keyframes modalContentSlideIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes modalContentSlideOut {
            to { opacity: 0; transform: translateY(-20px) scale(0.95); }
        }

        /* 5. Folder Switch Animation */
        .folder-card.switching-out {
            animation: folderSwitchOut 0.3s ease forwards;
        }

        .folder-card.switching-in {
            animation: folderSwitchIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes folderSwitchOut {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.5; }
        }

        @keyframes folderSwitchIn {
            0% { transform: scale(0.95); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        .folder-card.active {
            animation: folderActivePulse 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes folderActivePulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 113, 227, 0); }
            50% { box-shadow: 0 0 0 8px rgba(0, 113, 227, 0.15); }
            100% { box-shadow: 0 4px 12px rgba(0, 113, 227, 0.2); }
        }

        .folder-count.updating {
            animation: countPulse 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes countPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .todos-container.filter-transition .todo-item {
            animation-delay: calc(var(--item-index, 0) * 0.05s);
        }

        .main-content {
            transition: height 0.3s ease;
        }

        /* ========================================
           VISUAL POLISH FEATURES
           ======================================== */

        /* 1. LOADING SKELETONS */
        .skeleton {
            background: linear-gradient(90deg,
                var(--bg-tertiary) 25%,
                var(--border-color-light) 50%,
                var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s infinite;
            border-radius: var(--radius-sm);
            color: transparent !important;
            pointer-events: none;
        }

        .skeleton-text {
            height: 1em;
            margin: 0.5em 0;
            border-radius: 4px;
        }

        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 100%; }

        .skeleton-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
        }

        .skeleton-card .skeleton-title {
            height: 20px;
            width: 70%;
            margin-bottom: 12px;
            border-radius: var(--radius-sm);
        }

        .skeleton-card .skeleton-meta {
            display: flex;
            gap: 8px;
        }

        .skeleton-card .skeleton-badge {
            height: 24px;
            width: 60px;
            border-radius: var(--radius-sm);
        }

        .skeleton-folder {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .skeleton-folder-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-bottom: 8px;
        }

        .skeleton-folder-name {
            width: 80%;
            height: 16px;
            border-radius: 4px;
        }

        .skeleton-stat {
            width: 100%;
            text-align: center;
        }

        .skeleton-stat-number {
            height: 32px;
            width: 60px;
            margin: 0 auto 8px;
            border-radius: var(--radius-sm);
        }

        .skeleton-stat-label {
            height: 14px;
            width: 80%;
            margin: 0 auto;
            border-radius: 4px;
        }

        @keyframes skeletonShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* 2. EMPTY STATE ANIMATION */
        .empty-state-animated {
            text-align: center;
            padding: 80px 40px;
            position: relative;
        }

        .empty-state-illustration {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 32px;
        }

        .empty-state-illustration::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(0, 113, 227, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: emptyPulse 3s ease-in-out infinite;
        }

        .empty-state-icon {
            font-size: 5rem;
            color: var(--text-tertiary);
            position: relative;
            z-index: 1;
            animation: emptyFloat 4s ease-in-out infinite;
        }

        .empty-state-icon i {
            display: block;
        }

        .empty-state-icon::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            width: 60px;
            height: 8px;
            background: radial-gradient(ellipse, rgba(0, 0, 0, 0.1) 0%, transparent 70%);
            transform: translateX(-50%);
            animation: emptyShadow 4s ease-in-out infinite;
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            animation: emptyFadeIn 0.6s ease-out 0.2s both;
        }

        .empty-state-message {
            font-size: 1rem;
            color: var(--text-secondary);
            max-width: 400px;
            margin: 0 auto;
            animation: emptyFadeIn 0.6s ease-out 0.4s both;
        }

        .empty-state-decoration {
            position: absolute;
            font-size: 1rem;
            color: var(--accent-color);
            opacity: 0.3;
        }

        .empty-state-decoration:nth-child(1) {
            top: 20%;
            left: 10%;
            animation: decorationFloat 5s ease-in-out infinite;
        }

        .empty-state-decoration:nth-child(2) {
            top: 30%;
            right: 15%;
            animation: decorationFloat 6s ease-in-out infinite 1s;
        }

        .empty-state-decoration:nth-child(3) {
            bottom: 25%;
            left: 15%;
            animation: decorationFloat 5.5s ease-in-out infinite 2s;
        }

        .empty-state-decoration:nth-child(4) {
            bottom: 35%;
            right: 10%;
            animation: decorationFloat 6.5s ease-in-out infinite 0.5s;
        }

        @keyframes emptyPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
        }

        @keyframes emptyFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        @keyframes emptyShadow {
            0%, 100% { transform: translateX(-50%) scale(1); opacity: 0.3; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 0.15; }
        }

        @keyframes emptyFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes decorationFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(5deg); }
            75% { transform: translateY(5px) rotate(-5deg); }
        }

        /* 3. ENHANCED TOAST NOTIFICATIONS */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 20px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            font-size: 0.95rem;
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.hiding {
            transform: translateX(120%);
        }

        .notification-icon {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #28a745 100%);
        }

        .notification.success .notification-icon::before {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .notification.error {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc3545 100%);
        }

        .notification.error .notification-icon::before {
            content: '\f06a';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .notification.info {
            background: linear-gradient(135deg, var(--accent-color) 0%, #0056b3 100%);
        }

        .notification.info .notification-icon::before {
            content: '\f05a';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #fd7e14 100%);
        }

        .notification.warning .notification-icon::before {
            content: '\f071';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .notification.progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            width: 100%;
            transform-origin: left;
        }

        .notification.progress-bar .progress-fill {
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            animation: notificationProgress 3s linear forwards;
        }

        @keyframes notificationProgress {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }

        /* RTL support for notifications */
        body[data-lang="ar"] .notification {
            right: auto;
            left: 24px;
            transform: translateX(-120%);
        }

        body[data-lang="ar"] .notification.show {
            transform: translateX(0);
        }

        body[data-lang="ar"] .notification.hiding {
            transform: translateX(-120%);
        }

        /* 4. SUBTLE PARTICLE EFFECTS */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            background: var(--accent-color);
            opacity: 0.03;
            animation: particleFloat linear infinite;
        }

        .particle:nth-child(odd) {
            background: var(--success-color);
        }

        .particle:nth-child(3n) {
            background: var(--warning-color);
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.05;
            }
            90% {
                opacity: 0.05;
            }
            100% {
                transform: translateY(-100px) rotate(720deg);
                opacity: 0;
            }
        }

        /* 5. FOCUS GLOW EFFECT */
        select:focus, input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15),
                        0 0 20px rgba(0, 113, 227, 0.1);
        }

        select:focus, input[type="text"]:focus, textarea:focus {
            animation: focusGlow 0.3s ease-out;
        }

        @keyframes focusGlow {
            from {
                box-shadow: 0 0 0 0 rgba(0, 113, 227, 0.4),
                            0 0 0 0 rgba(0, 113, 227, 0.2);
            }
            to {
                box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15),
                            0 0 20px rgba(0, 113, 227, 0.1);
            }
        }

        /* Enhanced button focus states */
        .btn:focus-visible, .view-tab:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.3);
        }

        .btn-primary:focus {
            background: var(--accent-hover);
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.3),
                        0 4px 12px rgba(0, 113, 227, 0.2);
        }

        .btn-success:focus {
            box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.3),
                        0 4px 12px rgba(52, 199, 89, 0.2);
        }

        .btn-danger:focus {
            box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.3),
                        0 4px 12px rgba(255, 59, 48, 0.2);
        }

        /* Checkbox focus glow */
        .todo-checkbox:focus-visible + .todo-checkbox-wrapper,
        .todo-checkbox-wrapper:focus {
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.3);
        }

        /* ============================================
           MASCOT CHARACTER
        ============================================ */
        .mascot-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }

        body[data-lang="ar"] .mascot-container {
            right: auto;
            left: 24px;
        }

        .mascot {
            width: 80px;
            height: 80px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .mascot:hover {
            transform: scale(1.1);
        }

        .mascot-body {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50% 50% 45% 45%;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            animation: mascotBounce 2s ease-in-out infinite;
        }

        @keyframes mascotBounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }

        .mascot-face {
            position: absolute;
            top: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 25px;
        }

        .mascot-eyes {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .mascot-eye {
            width: 10px;
            height: 10px;
            background: #2d3748;
            border-radius: 50%;
            position: relative;
            animation: mascotBlink 4s infinite;
        }

        .mascot-eye::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            top: 2px;
            right: 2px;
        }

        @keyframes mascotBlink {
            0%, 96%, 100% { transform: scaleY(1); }
            98% { transform: scaleY(0.1); }
        }

        .mascot-mouth {
            width: 12px;
            height: 6px;
            background: #2d3748;
            border-radius: 0 0 10px 10px;
            margin: 8px auto 0;
            transition: all 0.3s ease;
        }

        /* Mascot emotions */
        .mascot.happy .mascot-mouth {
            width: 16px;
            height: 8px;
            border-radius: 0 0 16px 16px;
        }

        .mascot.excited .mascot-body {
            animation: mascotExcited 0.3s ease-in-out infinite;
        }

        @keyframes mascotExcited {
            0%, 100% { transform: translateX(-50%) translateY(0) rotate(-3deg); }
            50% { transform: translateX(-50%) translateY(-8px) rotate(3deg); }
        }

        .mascot.excited .mascot-mouth {
            width: 18px;
            height: 10px;
            border-radius: 0 0 18px 18px;
        }

        .mascot.excited .mascot-eye {
            animation: none;
            height: 4px;
            border-radius: 2px;
            top: 3px;
        }

        .mascot.thinking .mascot-body {
            animation: mascotThinking 1s ease-in-out infinite;
        }

        @keyframes mascotThinking {
            0%, 100% { transform: translateX(-50%) rotate(-5deg); }
            50% { transform: translateX(-50%) rotate(5deg); }
        }

        .mascot.thinking .mascot-mouth {
            width: 8px;
            height: 4px;
            border-radius: 4px 4px 0 0;
            margin-top: 10px;
        }

        .mascot.sleepy .mascot-body {
            animation: none;
            transform: translateX(-50%) scale(0.95);
        }

        .mascot.sleepy .mascot-eye {
            height: 2px;
            border-radius: 1px;
            top: 4px;
            animation: none;
        }

        .mascot.sleepy .mascot-mouth {
            width: 6px;
            height: 3px;
        }

        /* Mascot speech bubble */
        .mascot-speech {
            background: white;
            padding: 12px 16px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: var(--text-primary);
            max-width: 200px;
            text-align: center;
            position: relative;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .mascot-speech.show {
            opacity: 1;
            transform: translateY(0);
        }

        .mascot-speech::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid white;
        }

        .mascot-toggle {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            z-index: 10;
        }

        .mascot-toggle:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .mascot-container.hidden .mascot {
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }

        .mascot-container.hidden .mascot-toggle {
            opacity: 0.5;
        }

        /* Mascot hearts */
        .mascot-heart {
            position: absolute;
            font-size: 20px;
            pointer-events: none;
            animation: mascotHeartFloat 1s ease-out forwards;
            z-index: 1001;
        }

        @keyframes mascotHeartFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0);
            }
            50% {
                opacity: 1;
                transform: translateY(-30px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.5);
            }
        }

        /* ============================================
           ENHANCED CELEBRATION ANIMATIONS
        ============================================ */

        /* Emoji burst container */
        .emoji-burst-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        /* Floating emoji particle */
        .emoji-particle {
            position: absolute;
            font-size: 24px;
            pointer-events: none;
            animation: emojiFloat 1.5s ease-out forwards;
        }

        @keyframes emojiFloat {
            0% {
                opacity: 1;
                transform: translateY(0) rotate(0deg) scale(0);
            }
            20% {
                opacity: 1;
                transform: translateY(-20px) rotate(45deg) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-150px) rotate(360deg) scale(0.5);
            }
        }

        /* Day complete celebration overlay */
        .day-complete-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        .day-complete-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .day-complete-content {
            text-align: center;
            color: white;
            transform: scale(0.5);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .day-complete-overlay.show .day-complete-content {
            transform: scale(1);
        }

        .day-complete-emoji {
            font-size: 120px;
            animation: emojiBounce 0.6s ease-out;
            margin-bottom: 20px;
        }

        @keyframes emojiBounce {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .day-complete-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #fbbf24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .day-complete-subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
        }

        .day-complete-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
        }

        .day-complete-stat {
            text-align: center;
        }

        .day-complete-stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #10b981;
        }

        .day-complete-stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .day-complete-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 40px;
            font-size: 1.1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .day-complete-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        /* Rainbow confetti */
        .rainbow-confetti {
            position: fixed;
            width: 15px;
            height: 15px;
            pointer-events: none;
            z-index: 10001;
            opacity: 0;
        }

        .rainbow-confetti.animate {
            animation: rainbowFall 3s ease-out forwards;
        }

        @keyframes rainbowFall {
            0% {
                opacity: 1;
                transform: translateY(-100px) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg);
            }
        }

        /* Streak counter */
        .streak-counter {
            position: fixed;
            top: 24px;
            right: 24px;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 152, 0, 0.2) 100%);
            border: 2px solid rgba(255, 193, 7, 0.4);
            border-radius: 20px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
            animation: streakPulse 2s ease-in-out infinite;
        }

        body[data-lang="ar"] .streak-counter {
            right: auto;
            left: 24px;
        }

        @keyframes streakPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 193, 7, 0.3); }
            50% { box-shadow: 0 0 20px rgba(255, 193, 7, 0.5); }
        }

        .streak-fire {
            font-size: 1.5rem;
            animation: fireDance 0.5s ease-in-out infinite;
        }

        @keyframes fireDance {
            0%, 100% { transform: scale(1) rotate(-5deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        .streak-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffc107;
        }

        .streak-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body data-lang="ar">
    <!-- Particle Background -->
    <div class="particles-container" id="particles-container"></div>

    <!-- Emoji Burst Container for celebrations -->
    <div class="emoji-burst-container" id="emoji-burst-container"></div>

    <!-- Streak Counter -->
    <div class="streak-counter" id="streak-counter" style="display: none;">
        <span class="streak-fire">🔥</span>
        <span class="streak-number" id="streak-number">0</span>
        <span class="streak-label" data-i18n="streak.label">day streak</span>
    </div>

    <!-- Mascot Character -->
    <div class="mascot-container" id="mascot-container">
        <div class="mascot-speech" id="mascot-speech">Hello! Let's be productive! 💪</div>
        <div class="mascot" id="mascot">
            <div class="mascot-body">
                <div class="mascot-face">
                    <div class="mascot-eyes">
                        <div class="mascot-eye"></div>
                        <div class="mascot-eye"></div>
                    </div>
                    <div class="mascot-mouth"></div>
                </div>
            </div>
        </div>
        <button class="mascot-toggle" id="mascot-toggle" title="Toggle mascot">
            <i class="fas fa-eye"></i>
        </button>
    </div>

    <!-- Day Complete Celebration Overlay -->
    <div class="day-complete-overlay" id="day-complete-overlay">
        <div class="day-complete-content">
            <div class="day-complete-emoji">🎉</div>
            <div class="day-complete-title" data-i18n="day_complete.title">Amazing Work!</div>
            <div class="day-complete-subtitle" data-i18n="day_complete.subtitle">You completed all your tasks today!</div>
            <div class="day-complete-stats">
                <div class="day-complete-stat">
                    <div class="day-complete-stat-value" id="day-complete-tasks">0</div>
                    <div class="day-complete-stat-label" data-i18n="day_complete.tasks">Tasks Done</div>
                </div>
                <div class="day-complete-stat">
                    <div class="day-complete-stat-value" id="day-complete-streak">0</div>
                    <div class="day-complete-stat-label" data-i18n="day_complete.streak">Day Streak</div>
                </div>
            </div>
            <button class="day-complete-btn" id="day-complete-btn" data-i18n="day_complete.button">Keep it up!</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="language-switcher">
                <button class="language-btn" data-lang="en">EN</button>
                <button class="language-btn active" data-lang="ar">عربي</button>
            </div>
            <h1><i class="fas fa-tasks"></i> <span data-i18n="title">برنامج المهندس</span></h1>
            <div class="keyboard-shortcuts-hint" id="keyboard-shortcuts-hint">
                <span class="shortcut-hint"><kbd>N</kbd> <span data-i18n="shortcuts.new_task">New Task</span></span>
                <span class="shortcut-hint"><kbd>↑↓</kbd> <span data-i18n="shortcuts.navigate">Navigate</span></span>
                <span class="shortcut-hint"><kbd>Space</kbd> <span data-i18n="shortcuts.complete">Complete</span></span>
                <span class="shortcut-hint"><kbd>Del</kbd> <span data-i18n="shortcuts.delete">Delete</span></span>
                <button class="shortcuts-toggle" onclick="document.getElementById('keyboard-shortcuts-hint').classList.toggle('expanded')">
                    <i class="fas fa-keyboard"></i>
                </button>
            </div>
        </div>

        <div class="view-tabs">
            <button class="view-tab" data-view="all-tasks" onclick="todoApp.switchView('all-tasks')">
                <i class="fas fa-list"></i>
                <span data-i18n="views.all_tasks">All Tasks</span>
            </button>
            <button class="view-tab active" data-view="today" onclick="todoApp.switchView('today')">
                <i class="fas fa-calendar-day"></i>
                <span data-i18n="views.today">Today</span>
                <span class="today-badge" id="today-badge">0</span>
            </button>
            <button class="view-tab" data-view="archive" onclick="todoApp.switchView('archive')">
                <i class="fas fa-archive"></i>
                <span data-i18n="views.archive">Archive</span>
            </button>
            <button class="view-tab" data-view="notes" onclick="todoApp.switchView('notes')">
                <i class="fas fa-sticky-note"></i>
                <span data-i18n="views.notes">Notes</span>
            </button>
        </div>

        <div class="main-content">
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-number" id="total-todos">0</span>
                    <span class="stat-label" data-i18n="stats.total">Total</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="completed-todos">0</span>
                    <span class="stat-label" data-i18n="stats.completed">Completed</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="pending-todos">0</span>
                    <span class="stat-label" data-i18n="stats.pending">Pending</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="completion-rate">0%</span>
                    <span class="stat-label" data-i18n="stats.progress">Progress</span>
                </div>
            </div>

            <div class="folders-section">
                <div class="folders-header">
                    <h3 data-i18n="folders.title">Folders</h3>
                    <button class="btn btn-primary" onclick="todoApp.showAddFolderModal()">
                        <i class="fas fa-folder-plus"></i>
                        <span data-i18n="folders.add">Add Folder</span>
                    </button>
                </div>
                <div class="folders-grid" id="folders-grid">
                    <!-- Folders will be loaded here -->
                </div>
            </div>

            <div class="controls">
                <div class="filters">
                    <div class="filter-group">
                        <label data-i18n="filters.status">Status:</label>
                        <select id="status-filter">
                            <option value="all" data-i18n="filters.all">All</option>
                            <option value="pending" data-i18n="filters.pending">Pending</option>
                            <option value="completed" data-i18n="filters.completed">Completed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label data-i18n="filters.category">Category:</label>
                        <select id="category-filter">
                            <option value="all" data-i18n="filters.all">All</option>
                            <option value="work" data-i18n="categories.work">Work</option>
                            <option value="personal" data-i18n="categories.personal">Personal</option>
                            <option value="study" data-i18n="categories.study">Study</option>
                            <option value="health" data-i18n="categories.health">Health</option>
                            <option value="general" data-i18n="categories.general">General</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label data-i18n="filters.folder">Folder:</label>
                        <select id="folder-filter">
                            <option value="all" data-i18n="filters.all">All</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label data-i18n="filters.search">Search:</label>
                        <input type="text" id="search-input" data-i18n-placeholder="filters.search_placeholder">
                    </div>
                </div>

                <form class="add-todo-form" id="add-todo-form">
                    <div class="form-group">
                        <label data-i18n="form.title">Title</label>
                        <textarea id="todo-title" rows="1" data-i18n-placeholder="form.title_placeholder" required maxlength="500" style="resize: none; overflow: hidden; min-height: 38px;"></textarea>
                    </div>
                    <div class="form-group">
                        <label data-i18n="form.description">Description</label>
                        <textarea id="todo-description" rows="3" data-i18n-placeholder="form.description_placeholder" maxlength="5000"></textarea>
                    </div>
                    <div class="form-group">
                        <label data-i18n="form.priority">Priority</label>
                        <select id="todo-priority">
                            <option value="low" data-i18n="priority.low">Low</option>
                            <option value="medium" selected data-i18n="priority.medium">Medium</option>
                            <option value="high" data-i18n="priority.high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="form.category">Category</label>
                        <select id="todo-category">
                            <option value="general" selected data-i18n="categories.general">General</option>
                            <option value="work" data-i18n="categories.work">Work</option>
                            <option value="personal" data-i18n="categories.personal">Personal</option>
                            <option value="study" data-i18n="categories.study">Study</option>
                            <option value="health" data-i18n="categories.health">Health</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="form.folder">Folder</label>
                        <select id="todo-folder">
                            <option value="1" selected>General</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        <span data-i18n="form.add">Add</span>
                    </button>
                </form>
            </div>

            <div class="todos-container" id="todos-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p data-i18n="loading">Loading tasks...</p>
                </div>
            </div>

            <!-- Kanban Board for Today View -->
            <div class="kanban-container" id="kanban-container" style="display: none;">
                <!-- Daily Progress Bar -->
                <div class="daily-progress-section" id="daily-progress-section">
                    <div class="daily-progress-header">
                        <div class="daily-progress-title">
                            <i class="fas fa-sun icon" style="color: var(--warning-color);"></i>
                            <span data-i18n="daily_progress.title">Today's Progress</span>
                        </div>
                        <div class="daily-progress-stats" id="daily-progress-stats">
                            0 / 0
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="daily-progress-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Suggested Tasks Section -->
                <div class="suggested-tasks-section">
                    <div class="suggested-tasks-header">
                        <h3><i class="fas fa-lightbulb" style="color: var(--warning-color);"></i> <span data-i18n="suggested.title">Suggested Tasks</span></h3>
                        <small style="color: var(--text-secondary);"><i class="fas fa-info-circle"></i> <span data-i18n="suggested.hint">Drag tasks to Kanban columns to add them to Today</span></small>
                    </div>
                    <div class="suggested-tasks-container" id="suggested-tasks-container">
                        <!-- Suggested tasks will be loaded here -->
                    </div>
                </div>

                <!-- Kanban Columns -->
                <div class="kanban-column" data-status="todo">
                    <div class="kanban-header">
                        <h3><i class="fas fa-clipboard-list"></i> <span data-i18n="kanban.todo">To Do</span></h3>
                        <span class="count" id="kanban-todo-count">0</span>
                    </div>
                    <div class="kanban-cards" id="kanban-todo">
                        <!-- Kanban cards will be loaded here -->
                    </div>
                </div>
                <div class="kanban-column" data-status="doing">
                    <div class="kanban-header">
                        <h3><i class="fas fa-spinner"></i> <span data-i18n="kanban.doing">Doing</span></h3>
                        <span class="count" id="kanban-doing-count">0</span>
                    </div>
                    <div class="kanban-cards" id="kanban-doing">
                        <!-- Kanban cards will be loaded here -->
                    </div>
                </div>
                <div class="kanban-column" data-status="done">
                    <div class="kanban-header">
                        <h3><i class="fas fa-check-circle"></i> <span data-i18n="kanban.done">Done</span></h3>
                        <span class="count" id="kanban-done-count">0</span>
                    </div>
                    <div class="kanban-cards" id="kanban-done">
                        <!-- Kanban cards will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Archive View -->
            <div class="archive-container" id="archive-container" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p data-i18n="loading">Loading archived tasks...</p>
                </div>
            </div>

            <!-- Notes View -->
            <div class="notes-container" id="notes-container" style="display: none;">
                <div class="notes-header">
                    <h2 data-i18n="notes.title">My Notes</h2>
                </div>

                <!-- Add Note Form -->
                <div class="add-note-section">
                    <textarea id="note-content" class="note-input" rows="4" data-i18n-placeholder="notes.placeholder" maxlength="10000"></textarea>
                    <button class="btn btn-primary" onclick="todoApp.addNote()">
                        <i class="fas fa-plus"></i> <span data-i18n="notes.add">Add Note</span>
                    </button>
                </div>

                <!-- Notes List -->
                <div class="notes-list" id="notes-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p data-i18n="loading">Loading notes...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Folder Modal -->
    <div id="add-folder-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="folders.add_title">Add New Folder</h3>
                <span class="close" onclick="todoApp.closeModal('add-folder-modal')">&times;</span>
            </div>
            <form id="add-folder-form">
                <div class="form-group">
                    <label data-i18n="folders.name">Folder Name</label>
                    <input type="text" id="folder-name" required maxlength="40">
                </div>
                <div class="form-group">
                    <label data-i18n="folders.color">Color</label>
                    <input type="color" id="folder-color" value="#667eea">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="todoApp.closeModal('add-folder-modal')" data-i18n="common.cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-i18n="common.save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification-container"></div>

    <!-- Success Sound -->
    <audio id="success-sound" preload="auto">
        <source src="/static/Successful.wav" type="audio/wav">
    </audio>

    <!-- Multi-Select Elements -->
    <div class="selection-overlay" id="selection-overlay"></div>
    <div class="selection-box" id="selection-box"></div>

    <!-- Bulk Action Toolbar -->
    <div class="bulk-action-toolbar" id="bulk-action-toolbar">
        <div class="bulk-action-info">
            <span class="bulk-action-count" id="selected-count">0</span>
            <span id="selected-text">tasks selected</span>
        </div>
        <div class="bulk-action-buttons">
            <button class="bulk-action-btn move" id="bulk-move-btn">
                <i class="fas fa-folder"></i> Move
            </button>
            <button class="bulk-action-btn delete" id="bulk-delete-btn">
                <i class="fas fa-trash"></i> Delete
            </button>
            <button class="bulk-action-btn clear" id="bulk-clear-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <!-- Bulk Move Dropdown -->
        <div class="bulk-move-dropdown" id="bulk-move-dropdown">
            <!-- Folders will be populated here -->
        </div>
    </div>

    <script>
        // Language translations
        const translations = {
            en: {
                title: "TaskMaster",
                subtitle: "Manage your tasks efficiently and organized",
                views: {
                    all_tasks: "All Tasks",
                    today: "Today",
                    archive: "Archive",
                    notes: "Notes"
                },
                notes: {
                    title: "My Notes",
                    add: "Add Note",
                    placeholder: "Write your note here...",
                    empty: "No notes yet",
                    empty_message: "Create your first note above",
                    copy: "Copy",
                    copied: "Copied!",
                    delete: "Delete"
                },
                kanban: {
                    todo: "To Do",
                    doing: "Doing",
                    done: "Done"
                },
                today: {
                    add: "Add to Today",
                    remove: "Remove"
                },
                daily_progress: {
                    title: "Today's Progress",
                    completed: "Day Completed! Great job!",
                    empty: "No tasks selected for today yet"
                },
                suggested: {
                    title: "Suggested Tasks",
                    hint: "اسحب المهام واضفها الى اليوم في حالة كانت موجودة",
                    empty: "لايوجد مهام لاقتراحها عليك"
                },
                shortcuts: {
                    hint: "Press <strong>Ctrl+N</strong> to add task • <strong>Ctrl+R</strong> to refresh",
                    new_task: "New Task",
                    navigate: "Navigate",
                    complete: "Complete",
                    delete: "Delete"
                },
                archive: {
                    title: "Archived Tasks",
                    empty: "ارشيفك فارغ حاليا",
                    empty_message: "المهام المكتملة سوف تضهر هنا",
                    unarchive: "Unarchive",
                    today: "Today",
                    yesterday: "Yesterday"
                },
                stats: {
                    total: "Total",
                    completed: "Completed",
                    pending: "Pending",
                    progress: "Progress"
                },
                folders: {
                    title: "Folders",
                    add: "Add Folder",
                    add_title: "Add New Folder",
                    name: "Folder Name",
                    color: "Color"
                },
                filters: {
                    status: "Status:",
                    category: "Category:",
                    folder: "Folder:",
                    search: "Search:",
                    search_placeholder: "Search tasks...",
                    all: "All",
                    pending: "Pending",
                    completed: "Completed"
                },
                categories: {
                    work: "Work",
                    personal: "Personal",
                    study: "Study",
                    health: "Health",
                    general: "General"
                },
                priority: {
                    low: "Low",
                    medium: "Medium",
                    high: "High"
                },
                form: {
                    title: "Title",
                    title_placeholder: "What do you need to do?",
                    description: "Description",
                    description_placeholder: "Optional description",
                    priority: "Priority",
                    category: "Category",
                    folder: "Folder",
                    add: "Add"
                },
                actions: {
                    complete: "Complete",
                    uncomplete: "Uncomplete",
                    delete: "Delete",
                    toggle: "Toggle"
                },
                common: {
                    cancel: "Cancel",
                    save: "Save",
                    loading: "Loading tasks...",
                    tasks: "tasks"
                },
                empty: {
                    title: "No tasks",
                    message: "Add your first task to get started!"
                },
                errors: {
                    no_folders: "You must create at least one folder before adding tasks",
                    no_folders_title: "No folders available",
                    no_folders_message: "Create your first folder to start adding tasks!"
                },
                confirmations: {
                    delete_folder: "Are you sure you want to delete this folder? All tasks inside this folder will also be deleted."
                },
                success: {
                    folder_deleted: "Folder and all its tasks deleted successfully"
                },
                mascot: {
                    hello: "Hello! Let's be productive! 💪",
                    task_complete: "Great job! Task completed! 🎉",
                    day_start: "Let's make today count! 🌟",
                    thinking: "What should we focus on? 🤔",
                    happy: "You're doing amazing! ⭐",
                    excited: "WOW! Keep it up! 🔥",
                    sleepy: "Time for a break? ☕"
                },
                day_complete: {
                    title: "Amazing Work!",
                    subtitle: "You completed all your tasks today!",
                    tasks: "Tasks Done",
                    streak: "Day Streak",
                    button: "Keep it up!"
                },
                streak: {
                    label: "day streak"
                }
            },
            ar: {
                title: "المهندس",
                // subtitle: "إدارة مهامك بكفاءة وتنظيم",
                views: {
                    all_tasks: "جميع المهام",
                    today: "اليوم",
                    archive: "الأرشيف",
                    notes: "سكربتات"
                },
                notes: {
                    title: "ملاحظاتي",
                    add: "إضافة ملاحظة",
                    placeholder: "اكتب سكربت الفيديو هنا...",
                    empty: "لا توجد ملاحظات",
                    empty_message: "أنشئ أول ملاحظة أعلاه",
                    copy: "نسخ",
                    copied: "تم النسخ!",
                    delete: "حذف"
                },
                kanban: {
                    todo: "للإنجاز",
                    doing: "قيد التنفيذ",
                    done: "مكتمل"
                },
                today: {
                    add: "إضافة لليوم",
                    remove: "إزالة"
                },
                daily_progress: {
                    title: "تقدم اليوم",
                    completed: "أكملت يومك! أحسنت!",
                    empty: "لم تختر مهام لليوم بعد"
                },
                suggested: {
                    title: "مهام مقترحة",
                    hint: "اسحب المهام إلى أعمدة كانبان لإضافتها إلى اليوم",
                    empty: "لا توجد مهام مقترحة"
                },
                shortcuts: {
                    hint: "اضغط <strong>Ctrl+N</strong> لإضافة مهمة • <strong>Ctrl+R</strong> للتحديث",
                    new_task: "مهمة جديدة",
                    navigate: "تنقل",
                    complete: "إكمال",
                    delete: "حذف"
                },
                archive: {
                    title: "المهام المؤرشفة",
                    empty: "لا توجد مهام مؤرشفة",
                    empty_message: "المهام المكتملة ستظهر هنا",
                    unarchive: "إلغاء الأرشفة",
                    today: "اليوم",
                    yesterday: "أمس"
                },
                stats: {
                    total: "الإجمالي",
                    completed: "مكتمل",
                    pending: "قيد الانتظار",
                    progress: "التقدم"
                },
                folders: {
                    title: "المجلدات",
                    add: "إضافة مجلد",
                    add_title: "إضافة مجلد جديد",
                    name: "اسم المجلد",
                    color: "اللون"
                },
                filters: {
                    status: "الحالة:",
                    category: "الفئة:",
                    folder: "المجلد:",
                    search: "بحث:",
                    search_placeholder: "البحث في المهام...",
                    all: "الكل",
                    pending: "قيد الانتظار",
                    completed: "مكتمل"
                },
                categories: {
                    work: "العمل",
                    personal: "شخصي",
                    study: "دراسة",
                    health: "صحة",
                    general: "عام"
                },
                priority: {
                    low: "منخفض",
                    medium: "متوسط",
                    high: "مرتفع"
                },
                form: {
                    title: "العنوان",
                    title_placeholder: "ماذا تريد إنجازه؟",
                    description: "الوصف",
                    description_placeholder: "وصف اختياري",
                    priority: "الأولوية",
                    category: "الفئة",
                    folder: "المجلد",
                    add: "إضافة"
                },
                actions: {
                    complete: "إكمال",
                    uncomplete: "إلغاء الإكمال",
                    delete: "حذف",
                    toggle: "تبديل"
                },
                common: {
                    cancel: "إلغاء",
                    save: "حفظ",
                    loading: "جاري تحميل المهام...",
                    tasks: "مهام"
                },
                empty: {
                    title: "لا توجد مهام",
                    message: "أضف مهمتك الأولى للبدء!"
                },
                errors: {
                    no_folders: "يجب إنشاء مجلد واحد على الأقل قبل إضافة المهام",
                    no_folders_title: "لا توجد مجلدات",
                    no_folders_message: "أنشئ أول مجلد لك لبدء إضافة المهام!"
                },
                confirmations: {
                    delete_folder: "هل أنت متأكد من حذف هذا المجلد؟ سيتم حذف جميع المهام داخل هذا المجلد أيضاً."
                },
                success: {
                    folder_deleted: "تم حذف المجلد وجميع مهامه بنجاح"
                },
                mascot: {
                    hello: "مرحباً! لنكن منتجين! 💪",
                    task_complete: "عمل رائع! مهمة مكتملة! 🎉",
                    day_start: "لنجعل هذا اليوم ي counted! 🌟",
                    thinking: "على ماذا نركز؟ 🤔",
                    happy: "أنت تعمل بشكل مذهل! ⭐",
                    excited: "رائع! استمر! 🔥",
                    sleepy: "وقت للاستراحة؟ ☕"
                },
                day_complete: {
                    title: "عمل رائع!",
                    subtitle: "أكملت جميع مهامك اليوم!",
                    tasks: "مهام منجزة",
                    streak: "أيام متتالية",
                    button: "استمر!"
                },
                streak: {
                    label: "أيام متتالية"
                }
            }
        };

        class TodoApp {
            constructor() {
                this.todos = [];
                this.folders = [];
                this.currentLanguage = 'ar';
                this.currentView = null; // Will be set to 'today' in init()
                this.lastCreatedFolderId = null;
                this.filters = {
                    status: 'all',
                    category: 'all',
                    folder: 'all',
                    search: ''
                };
                this.quickAddMode = false;
                this.isSubmitting = false;
                // Multi-select properties
                this.selectedTasks = new Set();
                this.isSelecting = false;
                this.selectionStart = { x: 0, y: 0 };
                // Keyboard navigation properties
                this.focusedTaskId = null;
                this.keyboardNavigationEnabled = true;
                this.init();
            }

            init() {
                this.setupLanguageSwitcher();
                this.setLanguage(this.currentLanguage);
                this.bindEvents();
                this.setupKeyboardShortcuts();
                this.setupAutoResizeTextarea();
                this.setupMultiSelect();
                this.setupRippleEffects();
                this.setupParticles();
                this.checkTelegramStatus();
                this.loadFolders();
                this.loadStats();
                // Start with Today view
                this.switchView('today');
            }

            // Setup ripple effects for all buttons
            setupRippleEffects() {
                // Use event delegation for dynamically added buttons
                document.addEventListener('click', (e) => {
                    const button = e.target.closest('.btn, .view-tab, .language-btn');
                    if (button) {
                        this.createRipple(e);
                    }
                });
            }

            setupAutoResizeTextarea() {
                const titleTextarea = document.getElementById('todo-title');

                const autoResize = () => {
                    titleTextarea.style.height = 'auto';
                    titleTextarea.style.height = Math.min(titleTextarea.scrollHeight, 120) + 'px';
                };

                titleTextarea.addEventListener('input', autoResize);

                // Handle Enter key to submit the form, Shift+Enter for new line
                titleTextarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (titleTextarea.value.trim()) {
                            this.addTodo();
                        }
                    }
                });
            }

            async checkTelegramStatus() {
                try {
                    const response = await fetch('/api/telegram/status');
                    const status = await response.json();

                    const icon = document.getElementById('telegram-status-icon');
                    const text = document.getElementById('telegram-status-text');

                    if (status.enabled && status.configured && status.library_installed) {
                        icon.className = 'fas fa-robot telegram-enabled';
                        text.textContent = 'Telegram bot connected';
                    } else if (!status.enabled) {
                        icon.className = 'fas fa-robot telegram-disabled';
                        text.textContent = 'Telegram bot disabled (see telegram_config.json)';
                    } else if (!status.configured) {
                        icon.className = 'fas fa-robot telegram-pending';
                        text.textContent = 'Configure bot token in telegram_config.json';
                    } else if (!status.library_installed) {
                        icon.className = 'fas fa-robot telegram-pending';
                        text.textContent = 'Install: pip install pyTelegramBotAPI';
                    }
                } catch (error) {
                    console.log('Could not check Telegram status');
                }
            }

            async refreshCurrentView() {
                // Show loading notification
                this.showNotification('Refreshing...', 'info');

                // Import Telegram tasks first
                try {
                    const response = await fetch('/api/telegram/import', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    if (result.imported > 0) {
                        this.showNotification(`Imported ${result.imported} tasks from Telegram!`, 'success');
                    }
                } catch (error) {
                    console.log('Could not import Telegram tasks');
                }

                // Reload current view
                if (this.currentView === 'today') {
                    await this.loadTodayTodos();
                } else if (this.currentView === 'archive') {
                    await this.loadArchivedTodos();
                } else {
                    await this.loadTodos();
                }

                // Reload stats and folders
                await this.loadStats();
                await this.loadFolders();

                this.showNotification('Refreshed!', 'success');
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Ignore if user is typing in an input, textarea, or select
                    const isTyping = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName);
                    const isModalOpen = document.querySelector('.modal-overlay.active');

                    // ============ N Key - Quick Task Creation ============
                    if (e.code === 'KeyN' && !e.ctrlKey && !e.metaKey && !e.altKey && !isTyping) {
                        e.preventDefault();
                        this.focusNewTaskInput();
                        return;
                    }

                    // ============ Ctrl+N - Quick Add Task (existing) ============
                    if (e.ctrlKey && e.code === 'KeyN') {
                        e.preventDefault();
                        this.openQuickAdd();
                        return;
                    }

                    // ============ Ctrl+R - Refresh (existing) ============
                    if (e.ctrlKey && e.code === 'KeyR') {
                        e.preventDefault();
                        this.refreshCurrentView();
                        return;
                    }

                    // ============ Escape - Close modals / clear selection ============
                    if (e.key === 'Escape') {
                        if (this.quickAddMode) {
                            this.closeQuickAdd();
                        }
                        if (this.selectedTasks.size > 0) {
                            this.clearSelection();
                        }
                        if (this.focusedTaskId) {
                            this.clearKeyboardFocus();
                        }
                        // Close any open modals
                        if (isModalOpen) {
                            const modal = document.querySelector('.modal-overlay.active');
                            if (modal) {
                                modal.classList.remove('active');
                            }
                        }
                        return;
                    }

                    // ============ Arrow Keys - Navigation ============
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key) && !isTyping && !isModalOpen) {
                        e.preventDefault();
                        this.navigateTasks(e.key);
                        return;
                    }

                    // ============ Space/Enter - Toggle Complete ============
                    if ((e.key === ' ' || e.key === 'Enter') && !isTyping && !isModalOpen && this.focusedTaskId) {
                        e.preventDefault();
                        this.toggleFocusedTask();
                        return;
                    }

                    // ============ Delete/Backspace - Delete Task ============
                    if ((e.key === 'Delete' || e.key === 'Backspace') && !isTyping && !isModalOpen && this.focusedTaskId) {
                        e.preventDefault();
                        this.deleteFocusedTask();
                        return;
                    }
                });
            }

            // ============ KEYBOARD NAVIGATION FUNCTIONS ============

            focusNewTaskInput() {
                // Switch to all tasks view to show the input
                this.switchView('all');
                // Focus on the title input
                setTimeout(() => {
                    const titleInput = document.getElementById('todo-title');
                    if (titleInput) {
                        titleInput.focus();
                        titleInput.select();
                    }
                }, 100);
            }

            getVisibleTaskItems() {
                // Get all visible task items based on current view
                if (this.currentView === 'today') {
                    return Array.from(document.querySelectorAll('.kanban-card:not(.adding):not(.removing)'));
                } else if (this.currentView === 'archive') {
                    return Array.from(document.querySelectorAll('.todo-item:not(.adding):not(.removing)'));
                } else {
                    // All tasks view
                    const todoItems = Array.from(document.querySelectorAll('.todo-item:not(.adding):not(.removing)'));
                    const suggestedItems = Array.from(document.querySelectorAll('.suggested-task-card:not(.adding):not(.removing)'));
                    return [...todoItems, ...suggestedItems];
                }
            }

            navigateTasks(direction) {
                const items = this.getVisibleTaskItems();
                if (items.length === 0) return;

                let currentIndex = -1;
                if (this.focusedTaskId) {
                    currentIndex = items.findIndex(item => item.dataset.todoId === this.focusedTaskId);
                }

                let nextIndex = currentIndex;

                switch (direction) {
                    case 'ArrowDown':
                        nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
                        break;
                    case 'ArrowUp':
                        nextIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
                        break;
                    case 'ArrowRight':
                        // In kanban view, move to next column
                        if (this.currentView === 'today') {
                            const currentItem = items[currentIndex];
                            if (currentItem) {
                                const currentColumn = currentItem.closest('.kanban-column');
                                const columns = Array.from(document.querySelectorAll('.kanban-column'));
                                const currentColIndex = columns.indexOf(currentColumn);
                                if (currentColIndex < columns.length - 1) {
                                    const nextColumn = columns[currentColIndex + 1];
                                    const columnItems = Array.from(nextColumn.querySelectorAll('.kanban-card:not(.adding):not(.removing)'));
                                    if (columnItems.length > 0) {
                                        nextIndex = items.indexOf(columnItems[0]);
                                    }
                                }
                            }
                        } else {
                            nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
                        }
                        break;
                    case 'ArrowLeft':
                        // In kanban view, move to previous column
                        if (this.currentView === 'today') {
                            const currentItem = items[currentIndex];
                            if (currentItem) {
                                const currentColumn = currentItem.closest('.kanban-column');
                                const columns = Array.from(document.querySelectorAll('.kanban-column'));
                                const currentColIndex = columns.indexOf(currentColumn);
                                if (currentColIndex > 0) {
                                    const prevColumn = columns[currentColIndex - 1];
                                    const columnItems = Array.from(prevColumn.querySelectorAll('.kanban-card:not(.adding):not(.removing)'));
                                    if (columnItems.length > 0) {
                                        nextIndex = items.indexOf(columnItems[columnItems.length - 1]);
                                    }
                                }
                            }
                        } else {
                            nextIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
                        }
                        break;
                }

                if (nextIndex >= 0 && nextIndex < items.length) {
                    this.setFocusOnTask(items[nextIndex]);
                }
            }

            setFocusOnTask(item) {
                // Remove focus from previous item
                this.clearKeyboardFocus();

                // Set new focus
                this.focusedTaskId = item.dataset.todoId;
                item.classList.add('keyboard-focused');

                // Scroll into view if needed
                item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            clearKeyboardFocus() {
                if (this.focusedTaskId) {
                    const item = document.querySelector(`[data-todo-id="${this.focusedTaskId}"]`);
                    if (item) {
                        item.classList.remove('keyboard-focused');
                    }
                    this.focusedTaskId = null;
                }
            }

            async toggleFocusedTask() {
                if (!this.focusedTaskId) return;

                const item = document.querySelector(`[data-todo-id="${this.focusedTaskId}"]`);
                if (!item) return;

                // In kanban view, cycle through statuses: todo -> doing -> done -> todo
                if (this.currentView === 'today' && item.classList.contains('kanban-card')) {
                    const currentColumn = item.closest('.kanban-column');
                    if (!currentColumn) return;

                    const currentStatus = currentColumn.dataset.status;
                    const statusCycle = { 'todo': 'doing', 'doing': 'done', 'done': 'todo' };
                    const newStatus = statusCycle[currentStatus];

                    await this.updateKanbanStatus(this.focusedTaskId, newStatus);
                } else {
                    // In other views, toggle completion via checkbox
                    const checkbox = item.querySelector('.todo-checkbox');
                    if (checkbox) {
                        checkbox.click();
                    }
                }
            }

            async deleteFocusedTask() {
                if (!this.focusedTaskId) return;

                const item = document.querySelector(`[data-todo-id="${this.focusedTaskId}"]`);
                if (!item) return;

                // Find the delete button
                const deleteBtn = item.querySelector('.delete-todo-btn');
                if (deleteBtn) {
                    deleteBtn.click();
                } else {
                    // Fallback: call API directly
                    if (confirm('Delete this task?')) {
                        try {
                            await fetch(`/api/todos/${this.focusedTaskId}`, { method: 'DELETE' });
                            this.showNotification('Task deleted', 'success');
                            // Refresh current view
                            if (this.currentView === 'today') {
                                this.loadTodayTodos();
                            } else if (this.currentView === 'archive') {
                                this.loadArchivedTodos();
                            } else {
                                this.loadTodos();
                            }
                            this.loadStats();
                            this.loadFolders();
                        } catch (error) {
                            this.showNotification('Error deleting task', 'error');
                        }
                    }
                }
                this.clearKeyboardFocus();
            }

            // ============ END KEYBOARD NAVIGATION FUNCTIONS ============

            // ============ MULTI-SELECT FUNCTIONS ============

            setupMultiSelect() {
                const selectionOverlay = document.getElementById('selection-overlay');
                const selectionBox = document.getElementById('selection-box');
                const bulkMoveBtn = document.getElementById('bulk-move-btn');
                const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
                const bulkClearBtn = document.getElementById('bulk-clear-btn');
                const bulkMoveDropdown = document.getElementById('bulk-move-dropdown');

                let isDragging = false;
                let dragStart = { x: 0, y: 0 };

                // Mouse down on overlay - start box selection
                selectionOverlay.addEventListener('mousedown', (e) => {
                    if (e.button === 0) { // Left click only
                        isDragging = true;
                        dragStart = { x: e.clientX, y: e.clientY };
                        selectionBox.style.left = e.clientX + 'px';
                        selectionBox.style.top = e.clientY + 'px';
                        selectionBox.style.width = '0px';
                        selectionBox.style.height = '0px';
                        selectionBox.classList.add('active');
                    }
                });

                // Mouse move - update selection box
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const currentX = e.clientX;
                    const currentY = e.clientY;

                    const left = Math.min(dragStart.x, currentX);
                    const top = Math.min(dragStart.y, currentY);
                    const width = Math.abs(currentX - dragStart.x);
                    const height = Math.abs(currentY - dragStart.y);

                    selectionBox.style.left = left + 'px';
                    selectionBox.style.top = top + 'px';
                    selectionBox.style.width = width + 'px';
                    selectionBox.style.height = height + 'px';

                    // Check which tasks are under the selection box
                    this.checkTaskSelection(left, top, width, height);
                });

                // Mouse up - end box selection
                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        selectionBox.classList.remove('active');
                        selectionBox.style.width = '0px';
                        selectionBox.style.height = '0px';
                    }
                });

                // Bulk move button
                bulkMoveBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.showBulkMoveDropdown();
                });

                // Bulk delete button
                bulkDeleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.bulkDeleteSelected();
                });

                // Clear selection button
                bulkClearBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.clearSelection();
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.bulk-action-toolbar')) {
                        bulkMoveDropdown.classList.remove('visible');
                    }
                });

                // Enable selection mode when Ctrl key is held on task containers
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        selectionOverlay.classList.add('active');
                    }
                });

                document.addEventListener('keyup', (e) => {
                    if (!e.ctrlKey && !e.metaKey) {
                        selectionOverlay.classList.remove('active');
                    }
                });
            }

            checkTaskSelection(left, top, width, height) {
                const selectableItems = document.querySelectorAll('.todo-item, .kanban-card, .suggested-task-card');

                selectableItems.forEach(item => {
                    const rect = item.getBoundingClientRect();
                    const itemCenterX = rect.left + rect.width / 2;
                    const itemCenterY = rect.top + rect.height / 2;

                    const isInside = (
                        itemCenterX >= left &&
                        itemCenterX <= left + width &&
                        itemCenterY >= top &&
                        itemCenterY <= top + height
                    );

                    const todoId = item.dataset.todoId;
                    if (todoId) {
                        if (isInside && !this.selectedTasks.has(todoId)) {
                            this.selectTask(todoId, item);
                        } else if (!isInside && this.selectedTasks.has(todoId) && !item.classList.contains('manually-selected')) {
                            this.deselectTask(todoId, item);
                        }
                    }
                });
            }

            toggleTaskSelection(todoId) {
                const item = document.querySelector(`[data-todo-id="${todoId}"]`);
                if (!item) return;

                if (this.selectedTasks.has(todoId)) {
                    this.deselectTask(todoId, item);
                } else {
                    this.selectTask(todoId, item, true);
                }
            }

            selectTask(todoId, item = null, isManual = false) {
                this.selectedTasks.add(todoId);
                if (!item) {
                    item = document.querySelector(`[data-todo-id="${todoId}"]`);
                }
                if (item) {
                    item.classList.add('selected');
                    if (isManual) {
                        item.classList.add('manually-selected');
                    }
                }
                this.updateBulkToolbar();
            }

            deselectTask(todoId, item = null) {
                this.selectedTasks.delete(todoId);
                if (!item) {
                    item = document.querySelector(`[data-todo-id="${todoId}"]`);
                }
                if (item) {
                    item.classList.remove('selected', 'manually-selected');
                    // Uncheck the checkbox
                    const checkbox = item.querySelector('.todo-checkbox');
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                }
                this.updateBulkToolbar();
            }

            clearSelection() {
                this.selectedTasks.forEach(todoId => {
                    const item = document.querySelector(`[data-todo-id="${todoId}"]`);
                    if (item) {
                        item.classList.remove('selected', 'manually-selected');
                        const checkbox = item.querySelector('.todo-checkbox');
                        if (checkbox) {
                            checkbox.checked = false;
                        }
                    }
                });
                this.selectedTasks.clear();
                this.updateBulkToolbar();
            }

            updateBulkToolbar() {
                const toolbar = document.getElementById('bulk-action-toolbar');
                const count = document.getElementById('selected-count');
                const text = document.getElementById('selected-text');

                count.textContent = this.selectedTasks.size;

                if (this.selectedTasks.size > 0) {
                    toolbar.classList.add('visible');
                    text.textContent = this.selectedTasks.size === 1 ? 'task selected' : 'tasks selected';
                } else {
                    toolbar.classList.remove('visible');
                }
            }

            showBulkMoveDropdown() {
                const dropdown = document.getElementById('bulk-move-dropdown');
                dropdown.innerHTML = '';

                if (this.folders.length === 0) {
                    dropdown.innerHTML = '<div style="padding: 12px; color: var(--text-secondary);">No folders available</div>';
                } else {
                    this.folders.forEach(folder => {
                        const option = document.createElement('div');
                        option.className = 'folder-option';
                        option.innerHTML = `
                            <span class="folder-color-dot" style="background: ${folder.color}"></span>
                            <span>${this.escapeHtml(folder.name)}</span>
                        `;
                        option.addEventListener('click', () => {
                            this.bulkMoveSelected(folder.id);
                        });
                        dropdown.appendChild(option);
                    });
                }

                dropdown.classList.add('visible');
            }

            async bulkDeleteSelected() {
                if (this.selectedTasks.size === 0) return;

                const count = this.selectedTasks.size;
                const confirmMsg = count === 1
                    ? 'Are you sure you want to delete this task?'
                    : `Are you sure you want to delete ${count} tasks?`;

                if (!confirm(confirmMsg)) return;

                try {
                    // Use batch delete endpoint
                    const response = await fetch('/api/todos/batch', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: Array.from(this.selectedTasks) })
                    });

                    if (response.ok) {
                        // Play whoosh sound for clearing multiple tasks
                        this.playWhooshSound();

                        this.clearSelection();
                        this.showNotification(`${count} task(s) deleted successfully`, 'success');

                        // Reload current view
                        if (this.currentView === 'today') {
                            this.loadTodayTodos();
                        } else if (this.currentView === 'archive') {
                            this.loadArchivedTodos();
                        } else {
                            this.loadTodos();
                        }

                        this.loadStats();
                        this.loadFolders();
                    } else {
                        throw new Error('Error deleting tasks');
                    }
                } catch (error) {
                    this.showNotification('Error deleting tasks', 'error');
                }
            }

            async bulkMoveSelected(folderId) {
                if (this.selectedTasks.size === 0) return;

                try {
                    // Use batch move endpoint
                    const response = await fetch('/api/todos/batch/move', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ids: Array.from(this.selectedTasks),
                            folder_id: parseInt(folderId)
                        })
                    });

                    if (response.ok) {
                        this.clearSelection();
                        document.getElementById('bulk-move-dropdown').classList.remove('visible');
                        this.showNotification(`${this.selectedTasks.size} task(s) moved successfully`, 'success');

                        // Reload current view
                        if (this.currentView === 'today') {
                            this.loadTodayTodos();
                        } else if (this.currentView === 'archive') {
                            this.loadArchivedTodos();
                        } else {
                            this.loadTodos();
                        }

                        this.loadFolders();
                        this.loadStats();
                    } else {
                        throw new Error('Error moving tasks');
                    }
                } catch (error) {
                    this.showNotification('Error moving tasks', 'error');
                }
            }

            // ============ END MULTI-SELECT FUNCTIONS ============

            openQuickAdd() {
                this.quickAddMode = true;
                const previousView = this.currentView;

                // Show the add form
                const todosContainer = document.getElementById('todos-container');
                const kanbanContainer = document.getElementById('kanban-container');
                const archiveContainer = document.getElementById('archive-container');
                const controlsSection = document.querySelector('.controls');
                const foldersSection = document.querySelector('.folders-section');

                // Hide other views
                kanbanContainer.style.display = 'none';
                archiveContainer.style.display = 'none';

                // Show All Tasks view with controls
                todosContainer.style.display = 'block';
                controlsSection.style.display = 'block';
                foldersSection.style.display = 'block';

                // Clear the form and focus on title
                document.getElementById('add-todo-form').reset();
                document.getElementById('todo-priority').value = 'medium';
                document.getElementById('todo-category').value = 'general';

                const titleInput = document.getElementById('todo-title');
                titleInput.focus();

                // Add enter key listener to submit
                const submitHandler = (e) => {
                    if (e.key === 'Enter' && titleInput.value.trim()) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.addTodo();
                        this.closeQuickAdd();
                        // Return to previous view
                        this.switchView(previousView);
                    }
                };

                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.closeQuickAdd();
                        this.switchView(previousView);
                    }
                };

                titleInput.addEventListener('keydown', submitHandler);
                titleInput.addEventListener('keydown', escapeHandler);

                // Store handlers to remove them later
                this.quickAddHandlers = { submitHandler, escapeHandler, titleInput };
            }

            closeQuickAdd() {
                this.quickAddMode = false;
                if (this.quickAddHandlers) {
                    const { submitHandler, escapeHandler, titleInput } = this.quickAddHandlers;
                    titleInput.removeEventListener('keydown', submitHandler);
                    titleInput.removeEventListener('keydown', escapeHandler);
                    this.quickAddHandlers = null;
                }
            }

            switchView(view) {
                if (this.currentView === view) return; // Don't switch if already on this view
                const previousView = this.currentView;
                this.currentView = view;

                // Clear keyboard focus when switching views
                this.clearKeyboardFocus();

                // Update tab styling
                document.querySelectorAll('.view-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.view === view);
                });

                // Get containers
                const todosContainer = document.getElementById('todos-container');
                const kanbanContainer = document.getElementById('kanban-container');
                const archiveContainer = document.getElementById('archive-container');
                const notesContainer = document.getElementById('notes-container');
                const controlsSection = document.querySelector('.controls');
                const foldersSection = document.querySelector('.folders-section');
                const allContainers = [todosContainer, kanbanContainer, archiveContainer, notesContainer];

                // Fade out current view
                allContainers.forEach(container => {
                    if (container && container.style.display !== 'none') {
                        container.classList.add('fade-out');
                        container.classList.remove('fade-in');
                    }
                });

                // Wait for fade out, then switch views
                setTimeout(() => {
                    if (view === 'today') {
                        // Show Kanban board
                        todosContainer.style.display = 'none';
                        kanbanContainer.style.display = 'grid';
                        archiveContainer.style.display = 'none';
                        notesContainer.style.display = 'none';
                        controlsSection.style.display = 'none';
                        foldersSection.style.display = 'none';
                        kanbanContainer.classList.remove('fade-out');
                        kanbanContainer.classList.add('fade-in');
                        this.loadTodayTodos();
                    } else if (view === 'archive') {
                        // Show archive
                        todosContainer.style.display = 'none';
                        kanbanContainer.style.display = 'none';
                        archiveContainer.style.display = 'block';
                        notesContainer.style.display = 'none';
                        controlsSection.style.display = 'none';
                        foldersSection.style.display = 'none';
                        archiveContainer.classList.remove('fade-out');
                        archiveContainer.classList.add('fade-in');
                        this.loadArchivedTodos();
                    } else if (view === 'notes') {
                        // Show notes
                        todosContainer.style.display = 'none';
                        kanbanContainer.style.display = 'none';
                        archiveContainer.style.display = 'none';
                        notesContainer.style.display = 'block';
                        controlsSection.style.display = 'none';
                        foldersSection.style.display = 'none';
                        notesContainer.classList.remove('fade-out');
                        notesContainer.classList.add('fade-in');
                        this.loadNotes();
                    } else {
                        // Show all tasks
                        todosContainer.style.display = 'block';
                        kanbanContainer.style.display = 'none';
                        archiveContainer.style.display = 'none';
                        notesContainer.style.display = 'none';
                        controlsSection.style.display = 'block';
                        foldersSection.style.display = 'block';
                        todosContainer.classList.remove('fade-out');
                        todosContainer.classList.add('fade-in');
                        this.loadTodos();
                        // Auto-focus on title input for quick task entry
                        setTimeout(() => {
                            const titleInput = document.getElementById('todo-title');
                            if (titleInput) {
                                titleInput.focus();
                            }
                        }, 100);
                    }

                    // Remove animation classes after animation completes
                    setTimeout(() => {
                        allContainers.forEach(container => {
                            container.classList.remove('fade-out', 'fade-in');
                        });
                    }, 400);
                }, 150);
            }

            async loadTodayTodos() {
                // Show skeleton loading for Kanban and suggested tasks
                this.showSkeletonKanban();

                try {
                    // Load Today tasks for Kanban
                    const response = await fetch('/api/todos/today');
                    const todos = await response.json();
                    this.renderKanban(todos);
                    this.updateTodayBadge(todos.length);

                    // Load ALL Today tasks (including completed/archived) for progress bar
                    const allTodayResponse = await fetch('/api/todos/today?include_completed=true');
                    let allTodayTasks = await allTodayResponse.json();
                    this.allTodayTasks = allTodayTasks; // Store for progress calculation

                    // Load suggested tasks (tasks NOT in Today)
                    const suggestedResponse = await fetch('/api/todos?include_archived=false');
                    let allTasks = await suggestedResponse.json();
                    // Filter out tasks that are already in Today
                    const suggestedTasks = allTasks.filter(t => !t.added_to_today && !t.completed && !t.archived);
                    this.renderSuggestedTasks(suggestedTasks);

                    // Update daily progress bar AFTER allTodayTasks is loaded
                    this.updateDailyProgress(allTodayTasks);
                } catch (error) {
                    this.showNotification('Error loading Today tasks', 'error');
                }
            }

            // Show skeleton loading for Kanban columns
            showSkeletonKanban() {
                const columns = document.querySelectorAll('.kanban-column .kanban-cards');
                columns.forEach(column => {
                    column.innerHTML = Array(2).fill(0).map(() => `
                        <div class="skeleton-card">
                            <div class="skeleton skeleton-title"></div>
                            <div class="skeleton skeleton-text short"></div>
                        </div>
                    `).join('');
                });

                // Show skeleton for suggested tasks
                const suggestedContainer = document.getElementById('suggested-tasks-container');
                if (suggestedContainer) {
                    suggestedContainer.innerHTML = Array(3).fill(0).map(() => `
                        <div class="skeleton-card" style="min-width: 200px; max-width: 200px;">
                            <div class="skeleton skeleton-title"></div>
                            <div class="skeleton skeleton-text short"></div>
                        </div>
                    `).join('');
                }
            }

            updateTodayBadge(count) {
                const badge = document.getElementById('today-badge');
                if (badge) {
                    badge.textContent = count;
                    // Hide badge if count is 0
                    if (count === 0) {
                        badge.style.display = 'none';
                    } else {
                        badge.style.display = 'inline-block';
                        // Add animation when badge updates
                        badge.classList.remove('updated');
                        void badge.offsetWidth; // Trigger reflow
                        badge.classList.add('updated');
                    }
                }
            }

            renderSuggestedTasks(tasks) {
                const container = document.getElementById('suggested-tasks-container');

                if (tasks.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state-animated" style="padding: 40px 20px;">
                            <span class="empty-state-decoration"><i class="fas fa-star"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-circle"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-lightbulb"></i></span>
                            <div class="empty-state-illustration" style="width: 120px; height: 120px;">
                                <div class="empty-state-icon" style="font-size: 3rem;">
                                    <i class="fas fa-tasks"></i>
                                </div>
                            </div>
                            <h3 class="empty-state-title" data-i18n="suggested.empty">لايوجد مهام لاقتراحها عليك</h3>
                            <p class="empty-state-message" data-i18n="suggested.hint">اسحب المهام واضفها الى اليوم في حالة كانت موجودة</p>
                        </div>
                    `;
                    this.updateDynamicTranslations();
                    return;
                }

                container.innerHTML = tasks.map(todo => this.createSuggestedTaskCard(todo)).join('');
                this.setupSuggestedTasksDragDrop();
            }

            createSuggestedTaskCard(todo) {
                const priorityClass = `priority-${todo.priority}`;
                const priorityText = {
                    'high': translations[this.currentLanguage].priority.high,
                    'medium': translations[this.currentLanguage].priority.medium,
                    'low': translations[this.currentLanguage].priority.low
                }[todo.priority];

                const isSelected = this.selectedTasks.has(String(todo.id));

                return `
                    <div class="suggested-task-card ${isSelected ? 'selected' : ''}" draggable="true" data-todo-id="${todo.id}">
                        <div class="todo-checkbox-wrapper ${isSelected ? 'checked' : ''}" onclick="event.stopPropagation(); todoApp.toggleTaskSelection(${todo.id})"></div>
                        <input type="checkbox" class="todo-checkbox" ${isSelected ? 'checked' : ''} onchange="event.stopPropagation(); todoApp.toggleTaskSelection(${todo.id})">
                        <div class="suggested-task-title">${this.escapeHtml(todo.title)}</div>
                        ${todo.description ? `<div class="suggested-task-description">${this.escapeHtml(todo.description)}</div>` : ''}
                        <div class="suggested-task-meta">
                            <span class="suggested-task-badge ${priorityClass}">${priorityText}</span>
                            <span class="suggested-task-badge" style="background: ${todo.folder_color}; color: white;">${todo.folder_name}</span>
                        </div>
                    </div>
                `;
            }

            setupSuggestedTasksDragDrop() {
                const cards = document.querySelectorAll('.suggested-task-card');

                cards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        card.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', card.dataset.todoId);
                        e.dataTransfer.setData('suggested-task', 'true');
                    });

                    card.addEventListener('dragend', () => {
                        card.classList.remove('dragging');
                    });
                });
            }

            async loadArchivedTodos() {
                // Show skeleton loading
                const container = document.getElementById('archive-container');
                if (container) {
                    container.innerHTML = Array(3).fill(0).map(() => `
                        <div class="skeleton-card">
                            <div class="skeleton skeleton-title"></div>
                            <div class="skeleton skeleton-text medium"></div>
                        </div>
                    `).join('');
                }

                try {
                    const response = await fetch('/api/todos/archived');
                    const todos = await response.json();
                    this.renderArchived(todos);
                } catch (error) {
                    this.showNotification('Error loading archived tasks', 'error');
                }
            }

            renderKanban(todos) {
                const columns = {
                    todo: document.getElementById('kanban-todo'),
                    doing: document.getElementById('kanban-doing'),
                    done: document.getElementById('kanban-done')
                };

                // Clear columns
                Object.values(columns).forEach(col => col.innerHTML = '');

                // Group todos by kanban_status
                const todosByStatus = {
                    todo: todos.filter(t => t.kanban_status === 'todo'),
                    doing: todos.filter(t => t.kanban_status === 'doing'),
                    done: todos.filter(t => t.kanban_status === 'done')
                };

                // Render cards with stagger animation
                Object.keys(todosByStatus).forEach((status, statusIndex) => {
                    const statusTodos = todosByStatus[status];
                    statusTodos.forEach((todo, cardIndex) => {
                        const card = this.createKanbanCard(todo);
                        // Add staggered animation delay
                        const delay = (statusIndex * 0.1) + (cardIndex * 0.05);
                        card.style.animationDelay = `${delay}s`;
                        card.classList.add('reordering');
                        setTimeout(() => {
                            card.classList.remove('reordering');
                        }, 400 + (delay * 1000));
                        columns[status].appendChild(card);
                    });
                    // Update counts
                    const countEl = document.getElementById(`kanban-${status}-count`);
                    countEl.textContent = statusTodos.length;
                    countEl.classList.add('updating');
                    setTimeout(() => countEl.classList.remove('updating'), 400);
                });

                // Setup drag and drop
                this.setupKanbanDragDrop();

                // Note: updateDailyProgress is called after allTodayTasks is loaded in loadTodayTodos
            }

            updateDailyProgress(todos) {
                const progressSection = document.getElementById('daily-progress-section');
                const progressBar = document.getElementById('daily-progress-bar');
                const progressStats = document.getElementById('daily-progress-stats');

                // Always show the progress bar
                progressSection.style.display = 'block';
                progressSection.classList.remove('completed');

                const t = translations[this.currentLanguage];

                // Use allTodayTasks if available (includes completed tasks)
                const allTasks = this.allTodayTasks || todos;
                const totalTodayTasks = allTasks.length;
                const completedTasks = allTasks.filter(task => task.kanban_status === 'done').length;

                if (totalTodayTasks === 0) {
                    // No tasks yet - show empty state
                    this.updateProgressBar(0);
                    progressStats.textContent = t.daily_progress.empty || 'No tasks selected for today';
                    return;
                }

                const percentage = Math.round((completedTasks / totalTodayTasks) * 100);

                // Use animated progress bar update
                this.updateProgressBar(percentage);

                // Update stats text
                progressStats.textContent = `${completedTasks} / ${totalTodayTasks} · ${percentage}%`;

                // Mascot reacts to progress
                this.mascotReactToProgress(percentage);

                // Handle completion state
                if (percentage === 100) {
                    progressSection.classList.add('completed');
                    progressStats.innerHTML = `<i class="fas fa-check-circle"></i> ${t.daily_progress.completed || 'Today Completed!'}`;

                    // Trigger day complete celebration (only once per session)
                    if (!this.dayCompleteCelebrated) {
                        this.dayCompleteCelebrated = true;
                        // Get streak from localStorage or default to 1
                        const streak = parseInt(localStorage.getItem('dayStreak') || '1');
                        this.showDayCompleteCelebration(completedTasks, streak);
                    }
                } else {
                    this.dayCompleteCelebrated = false;
                }
            }

            createKanbanCard(todo) {
                const card = document.createElement('div');
                card.className = 'kanban-card';
                card.draggable = true;
                card.dataset.todoId = todo.id;

                const isSelected = this.selectedTasks.has(String(todo.id));

                if (isSelected) {
                    card.classList.add('selected');
                }

                const priorityClass = `priority-${todo.priority}`;
                const priorityText = {
                    'high': translations[this.currentLanguage].priority.high,
                    'medium': translations[this.currentLanguage].priority.medium,
                    'low': translations[this.currentLanguage].priority.low
                }[todo.priority];

                card.innerHTML = `
                    <div class="todo-checkbox-wrapper ${isSelected ? 'checked' : ''}" onclick="event.stopPropagation(); todoApp.toggleTaskSelection(${todo.id})"></div>
                    <input type="checkbox" class="todo-checkbox" ${isSelected ? 'checked' : ''} onchange="event.stopPropagation(); todoApp.toggleTaskSelection(${todo.id})">
                    <div class="kanban-card-title">${this.escapeHtml(todo.title)}</div>
                    ${todo.description ? `<div class="kanban-card-description">${this.escapeHtml(todo.description)}</div>` : ''}
                    <div class="kanban-card-meta">
                        <span class="kanban-card-badge ${priorityClass}">${priorityText}</span>
                        <span class="kanban-card-badge" style="background: ${todo.folder_color}; color: white;">${todo.folder_name}</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); todoApp.removeFromToday(${todo.id})" style="font-size: 0.8rem; padding: 4px 10px;">
                            <i class="fas fa-calendar-minus"></i> ${translations[this.currentLanguage].today.remove}
                        </button>
                    </div>
                `;

                return card;
            }

            setupKanbanDragDrop() {
                const cards = document.querySelectorAll('.kanban-card');
                const columnsInner = document.querySelectorAll('.kanban-cards');
                const columns = document.querySelectorAll('.kanban-column');

                cards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        card.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', card.dataset.todoId);
                    });

                    card.addEventListener('dragend', () => {
                        card.classList.remove('dragging');
                        document.querySelectorAll('.kanban-column').forEach(col => {
                            col.classList.remove('drag-over');
                        });
                    });
                });

                // Add drop listeners to both the cards area and the entire column
                columns.forEach(column => {
                    column.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        column.classList.add('drag-over');
                    });

                    column.addEventListener('dragleave', (e) => {
                        // Only remove drag-over if leaving the column entirely
                        if (!column.contains(e.relatedTarget)) {
                            column.classList.remove('drag-over');
                        }
                    });

                    column.addEventListener('drop', (e) => {
                        e.preventDefault();
                        column.classList.remove('drag-over');

                        const todoId = e.dataTransfer.getData('text/plain');
                        const isSuggestedTask = e.dataTransfer.getData('suggested-task') === 'true';
                        const newStatus = column.dataset.status;

                        if (isSuggestedTask) {
                            this.addSuggestedTaskToToday(todoId, newStatus);
                        } else {
                            this.updateKanbanStatus(todoId, newStatus);
                        }
                    });
                });

                // Also keep listeners on the cards area for better coverage
                columnsInner.forEach(columnInner => {
                    columnInner.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        columnInner.closest('.kanban-column').classList.add('drag-over');
                    });

                    columnInner.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation(); // Prevent bubbling to column
                        columnInner.closest('.kanban-column').classList.remove('drag-over');

                        const todoId = e.dataTransfer.getData('text/plain');
                        const isSuggestedTask = e.dataTransfer.getData('suggested-task') === 'true';
                        const newStatus = columnInner.closest('.kanban-column').dataset.status;

                        if (isSuggestedTask) {
                            this.addSuggestedTaskToToday(todoId, newStatus);
                        } else {
                            this.updateKanbanStatus(todoId, newStatus);
                        }
                    });
                });
            }

            setupTodoReorderDragDrop() {
                const container = document.getElementById('todos-container');
                if (!container) return;

                const todoItems = container.querySelectorAll('.todo-item');

                todoItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        item.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', item.dataset.todoId);
                        e.dataTransfer.effectAllowed = 'move';
                    });

                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                        document.querySelectorAll('.todo-item').forEach(i => {
                            i.classList.remove('drag-over');
                        });
                    });

                    item.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        const draggingItem = document.querySelector('.todo-item.dragging');
                        if (draggingItem !== item) {
                            item.classList.add('drag-over');
                        }
                    });

                    item.addEventListener('dragleave', () => {
                        item.classList.remove('drag-over');
                    });

                    item.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        item.classList.remove('drag-over');

                        const draggingItem = document.querySelector('.todo-item.dragging');
                        if (draggingItem && draggingItem !== item) {
                            // Get all todo items
                            const allItems = [...container.querySelectorAll('.todo-item')];
                            const draggedIndex = allItems.indexOf(draggingItem);
                            const targetIndex = allItems.indexOf(item);

                            // Reorder in DOM
                            if (draggedIndex < targetIndex) {
                                item.after(draggingItem);
                            } else {
                                item.before(draggingItem);
                            }

                            // Optional: Show notification
                            // this.showNotification('Task reordered', 'info');
                        }
                    });
                });
            }

            async addSuggestedTaskToToday(todoId, status) {
                try {
                    // First add to Today
                    await fetch(`/api/todos/${todoId}/add-to-today`, {
                        method: 'PUT'
                    });

                    // Then set Kanban status
                    const response = await fetch(`/api/todos/${todoId}/kanban-status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });

                    if (response.ok) {
                        // Play sound and show effect if task added to Done
                        if (status === 'done') {
                            this.playSuccessEffect();
                        }
                        this.loadTodayTodos();
                        this.loadStats();
                        this.showNotification('Task added to Today', 'success');
                    }
                } catch (error) {
                    this.showNotification('Error adding task', 'error');
                }
            }

            async updateKanbanStatus(todoId, status) {
                try {
                    const response = await fetch(`/api/todos/${todoId}/kanban-status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });

                    if (response.ok) {
                        // Play sound and show effect if task moved to Done
                        if (status === 'done') {
                            this.playSuccessEffect();
                        }
                        this.loadTodayTodos();
                        this.loadStats();
                        this.showNotification('Task status updated', 'success');
                    }
                } catch (error) {
                    this.showNotification('Error updating status', 'error');
                }
            }

            playSuccessEffect() {
                // Play success sound
                const sound = document.getElementById('success-sound');
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(() => {}); // Ignore autoplay errors
                }

                // Visual flash on Done column
                const doneColumn = document.querySelector('.kanban-column[data-status="done"]');
                if (doneColumn) {
                    doneColumn.classList.remove('task-complete-flash');
                    void doneColumn.offsetWidth; // Trigger reflow
                    doneColumn.classList.add('task-complete-flash');

                    // Create emoji burst at the done column position
                    const rect = doneColumn.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    this.createEmojiBurst(centerX, centerY);
                }

                // Create confetti burst
                this.createConfettiBurst();

                // Mascot celebrates
                if (this.mascotState?.visible) {
                    this.setMascotEmotion('excited');
                    this.mascotSpeak('task_complete');
                    this.createMascotHearts(2);
                    setTimeout(() => this.setMascotEmotion('happy'), 1500);
                }
            }

            createConfettiBurst() {
                const doneColumn = document.querySelector('.kanban-column[data-status="done"]');
                if (!doneColumn) return;

                const rect = doneColumn.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + 50;

                const colors = ['#10b981', '#34d399', '#6ee7b7', '#fbbf24', '#f472b6'];

                for (let i = 0; i < 12; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'confetti-particle';
                    particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.left = centerX + 'px';
                    particle.style.top = centerY + 'px';

                    const angle = (i / 12) * Math.PI * 2;
                    const distance = 30 + Math.random() * 20;
                    particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');

                    document.body.appendChild(particle);

                    setTimeout(() => particle.remove(), 600);
                }
            }

            renderArchived(todos) {
                const container = document.getElementById('archive-container');

                if (todos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state-animated">
                            <span class="empty-state-decoration"><i class="fas fa-star"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-circle"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-check"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-bolt"></i></span>
                            <div class="empty-state-illustration">
                                <div class="empty-state-icon">
                                    <i class="fas fa-archive"></i>
                                </div>
                            </div>
                            <h3 class="empty-state-title" data-i18n="archive.empty">ارشيفك فارغ حاليا</h3>
                            <p class="empty-state-message" data-i18n="archive.empty_message">المهام المكتملة سوف تضهر هنا</p>
                        </div>
                    `;
                    this.updateDynamicTranslations();
                    return;
                }

                // Group tasks by date
                const groupedTasks = {};
                todos.forEach(todo => {
                    const dateKey = new Date(todo.updated_at).toDateString();
                    if (!groupedTasks[dateKey]) {
                        groupedTasks[dateKey] = {
                            dateLabel: this.getArchiveDateLabel(todo.updated_at),
                            tasks: []
                        };
                    }
                    groupedTasks[dateKey].tasks.push(todo);
                });

                // Build HTML with date headers
                let html = '<div class="archive-header"><h2><i class="fas fa-archive"></i> <span data-i18n="archive.title">Archived Tasks</span></h2></div>';

                // Sort dates (newest first) and render each group
                Object.keys(groupedTasks)
                    .sort((a, b) => new Date(b) - new Date(a))
                    .forEach(dateKey => {
                        const group = groupedTasks[dateKey];

                        // Date header
                        html += `
                            <div class="archive-date-header">
                                <i class="fas fa-calendar-day"></i>
                                ${group.dateLabel}
                            </div>
                        `;

                        // Tasks for this date
                        group.tasks.forEach(todo => {
                            html += `
                                <div class="archive-item">
                                    <div class="archive-item-header">
                                        <div class="archive-item-title">${this.escapeHtml(todo.title)}</div>
                                        <div class="archive-item-actions">
                                            <button class="btn btn-sm btn-success" onclick="todoApp.unarchiveTodo(${todo.id})">
                                                <i class="fas fa-undo"></i> <span data-i18n="archive.unarchive">Unarchive</span>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="todoApp.deleteTodo(${todo.id})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    ${todo.description ? `<div style="color: var(--text-secondary); margin: 8px 0;">${this.escapeHtml(todo.description)}</div>` : ''}
                                    <div class="archive-item-meta">
                                        <span><i class="fas fa-folder"></i> ${todo.folder_name}</span>
                                        <span><i class="fas fa-clock"></i> ${this.formatDate(todo.updated_at)}</span>
                                    </div>
                                </div>
                            `;
                        });
                    });

                container.innerHTML = html;
                this.updateDynamicTranslations();
            }

            async unarchiveTodo(todoId) {
                try {
                    const response = await fetch(`/api/todos/${todoId}/unarchive`, {
                        method: 'PUT'
                    });

                    if (response.ok) {
                        this.loadArchivedTodos();
                        this.showNotification('Task unarchived successfully', 'success');
                    }
                } catch (error) {
                    this.showNotification('Error unarchiving task', 'error');
                }
            }

            async toggleAddToToday(todoId) {
                const todo = this.todos.find(t => t.id === todoId);
                const isAdding = !todo.added_to_today;

                try {
                    const endpoint = isAdding
                        ? `/api/todos/${todoId}/add-to-today`
                        : `/api/todos/${todoId}/remove-from-today`;

                    const response = await fetch(endpoint, { method: 'PUT' });

                    if (response.ok) {
                        this.loadTodos();
                        this.loadStats();
                        this.showNotification(
                            isAdding ? 'Added to Today' : 'Removed from Today',
                            'success'
                        );
                    }
                } catch (error) {
                    this.showNotification('Error updating task', 'error');
                }
            }

            async removeFromToday(todoId) {
                try {
                    const response = await fetch(`/api/todos/${todoId}/remove-from-today`, {
                        method: 'PUT'
                    });

                    if (response.ok) {
                        this.loadTodayTodos();
                        this.loadStats();
                        this.showNotification('Removed from Today', 'success');
                    }
                } catch (error) {
                    this.showNotification('Error removing task', 'error');
                }
            }

            setupLanguageSwitcher() {
                const langButtons = document.querySelectorAll('.language-btn');
                langButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const lang = btn.dataset.lang;
                        this.setLanguage(lang);
                        
                        // Update active button
                        langButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                });
            }

            setLanguage(lang) {
                this.currentLanguage = lang;
                document.documentElement.lang = lang;
                document.body.setAttribute('data-lang', lang);
                
                // Update all translatable elements
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.dataset.i18n;
                    const keys = key.split('.');
                    let value = translations[lang];
                    keys.forEach(k => {
                        value = value[k];
                    });
                    if (value) {
                        element.textContent = value;
                    }
                });

                // Update placeholders
                document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                    const key = element.dataset.i18nPlaceholder;
                    const keys = key.split('.');
                    let value = translations[lang];
                    keys.forEach(k => {
                        value = value[k];
                    });
                    if (value) {
                        element.placeholder = value;
                    }
                });

                // Update dynamic content that was created after page load
                this.updateDynamicTranslations();
            }

            updateDynamicTranslations() {
                // Update "Add Folder" button in folders grid
                const addFolderBtn = document.querySelector('.add-folder-btn div');
                if (addFolderBtn) {
                    addFolderBtn.textContent = translations[this.currentLanguage].folders.add;
                }

                // Update folder count text
                document.querySelectorAll('.folder-count').forEach(element => {
                    const count = element.textContent.split(' ')[0];
                    element.textContent = `${count} ${translations[this.currentLanguage].common.tasks}`;
                });

                // Update empty state messages (both plain and animated)
                const emptyState = document.querySelector('.empty-state') || document.querySelector('.empty-state-animated');
                if (emptyState && this.todos.length === 0 && this.folders.length > 0) {
                    const title = emptyState.querySelector('h3') || emptyState.querySelector('.empty-state-title');
                    const message = emptyState.querySelector('p') || emptyState.querySelector('.empty-state-message');
                    if (title) title.textContent = translations[this.currentLanguage].empty.title;
                    if (message) message.textContent = translations[this.currentLanguage].empty.message;
                }

                // Update no folders message (both plain and animated)
                const noFoldersState = document.querySelector('.empty-state') || document.querySelector('.empty-state-animated');
                if (noFoldersState && this.folders.length === 0) {
                    const title = noFoldersState.querySelector('h3') || noFoldersState.querySelector('.empty-state-title');
                    const message = noFoldersState.querySelector('p') || noFoldersState.querySelector('.empty-state-message');
                    if (title) title.textContent = translations[this.currentLanguage].errors.no_folders_title;
                    if (message) message.textContent = translations[this.currentLanguage].errors.no_folders_message;
                }
            }

            bindEvents() {
                // Form submission (handles both button click and Enter key)
                document.getElementById('add-todo-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTodo();
                });

                // Add folder form
                document.getElementById('add-folder-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addFolder();
                });

                // Filters (EN TIEMPO REAL)
                document.getElementById('status-filter').addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.loadTodos();
                });

                document.getElementById('category-filter').addEventListener('change', (e) => {
                    this.filters.category = e.target.value;
                    this.loadTodos();
                });

                document.getElementById('folder-filter').addEventListener('change', (e) => {
                    this.filters.folder = e.target.value;
                    this.loadTodos();
                });

                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.filters.search = e.target.value;
                    this.loadTodos();
                });

                // Global menu for moving a task between folders
                document.getElementById('todos-container').addEventListener('click', (e) => {
                    if (e.target.classList.contains('move-folder-btn')) {
                        const todoId = e.target.getAttribute('data-todo-id');
                        const btn = e.target;
                        // Remove any open menus
                        document.querySelectorAll('.move-folder-global-dropdown').forEach(d => d.remove());
                        // Build the menu
                        const todo = this.todos.find(t => t.id == todoId);
                        const folders = this.folders.filter(f => f.id !== todo.folder_id);
                        const menu = document.createElement('div');
                        menu.className = 'move-folder-global-dropdown';
                        menu.setAttribute('data-todo-id', todoId); // Store the todoId in the menu
                        if (folders.length === 0) {
                            menu.innerHTML = `<div style='padding:8px 18px; color:#aaa;'>${translations[this.currentLanguage].folders.title}</div>`;
                        } else {
                            menu.innerHTML = folders.map(folder =>
                                `<div class='move-folder-option' data-folder-id='${folder.id}'>${this.escapeHtml(folder.name)}</div>`
                            ).join('');
                        }
                        document.body.appendChild(menu);
                        // Position the menu
                        const rect = btn.getBoundingClientRect();
                        let top = rect.bottom + window.scrollY;
                        let left = rect.left + window.scrollX;
                        // If menu overflows bottom, show above
                        if (top + menu.offsetHeight > window.innerHeight + window.scrollY) {
                            top = rect.top + window.scrollY - menu.offsetHeight;
                        }
                        // If menu overflows right, adjust
                        if (left + menu.offsetWidth > window.innerWidth + window.scrollX) {
                            left = window.innerWidth + window.scrollX - menu.offsetWidth - 10;
                        }
                        menu.style.top = top + 'px';
                        menu.style.left = left + 'px';
                    }
                });
                // Listen globally for clicks on move-folder-option
                document.body.addEventListener('click', (e) => {
                    if (e.target.classList.contains('move-folder-option')) {
                        // Read the todoId directly from the parent menu
                        const menu = e.target.closest('.move-folder-global-dropdown');
                        const todoId = menu ? menu.getAttribute('data-todo-id') : null;
                        const newFolderId = e.target.getAttribute('data-folder-id');
                        if (todoId && newFolderId) {
                            this.moveTodoToFolder(todoId, newFolderId);
                        }
                        document.querySelectorAll('.move-folder-global-dropdown').forEach(d => d.remove());
                        e.stopPropagation();
                    }
                });
                // Removed previousMenuBtnId mousedown event, no longer needed
                // Cerrar menú al hacer click fuera
                document.body.addEventListener('mousedown', (e) => {
                    if (!e.target.classList.contains('move-folder-global-dropdown') && !e.target.classList.contains('move-folder-option') && !e.target.classList.contains('move-folder-btn')) {
                        document.querySelectorAll('.move-folder-global-dropdown').forEach(d => d.remove());
                    }
                });

                // Double-click to complete tasks
                document.getElementById('todos-container').addEventListener('dblclick', (e) => {
                    const todoItem = e.target.closest('.todo-item');
                    if (todoItem && !e.target.closest('button') && !e.target.closest('input') && !e.target.closest('.todo-checkbox-wrapper')) {
                        const todoId = todoItem.getAttribute('data-todo-id');
                        if (todoId) {
                            this.toggleTodo(parseInt(todoId));
                        }
                    }
                });
            }

            async loadFolders() {
                // Show skeleton loading for folders
                this.showSkeletonFolders();

                try {
                    const response = await fetch('/api/folders');
                    this.folders = await response.json();
                    this.renderFolders();
                    this.updateFolderSelects();
                    this.updateDynamicTranslations();
                } catch (error) {
                    this.showNotification('Error loading folders', 'error');
                }
            }

            renderFolders() {
                const grid = document.getElementById('folders-grid');
                grid.innerHTML = '';

                this.folders.forEach(folder => {
                    const folderCard = document.createElement('div');
                    folderCard.className = 'folder-card';
                    folderCard.dataset.folderId = folder.id;
                    folderCard.style.borderLeftColor = folder.color;
                    folderCard.style.borderLeftWidth = '4px';
                    folderCard.onclick = (e) => this.selectFolder(folder.id, e.currentTarget);

                    // Truncar el nombre del folder una letra antes (máx 13) y tooltip
                    let folderNameDisplay = folder.name;
                    if (folderNameDisplay.length > 13) {
                        folderNameDisplay = folderNameDisplay.slice(0, 12) + '...';
                    }

                    // Calcular progreso visual
                    const total = folder.todo_count;
                    const completed = folder.completed_count || 0;
                    const pending = total - completed;
                    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

                    folderCard.innerHTML = `
                        <div class="folder-icon" style="color: ${folder.color}">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="folder-name" title="${this.escapeHtml(folder.name)}">${this.escapeHtml(folderNameDisplay)}</div>
                        <div class="folder-progress-bar" style="background: var(--border-color); border-radius: var(--radius-sm); height: 6px; margin: 8px 0 6px 0; width: 100%; overflow: hidden;">
                            <div style="width: ${percent}%; height: 100%; background: var(--accent-color); border-radius: var(--radius-sm);"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85em;">
                            <span title="${percent}% completed"><i class='fas fa-check-circle' style='color:var(--success-color);'></i> ${percent}%</span>
                            <span title="${pending} pending"><i class='fas fa-tasks' style='color:var(--danger-color);'></i> ${pending}</span>
                        </div>
                        <div class="folder-count">${folder.todo_count} ${translations[this.currentLanguage].common.tasks}</div>
                        <div class="folder-actions">
                            <button onclick="event.stopPropagation(); todoApp.deleteFolder(${folder.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

                    grid.appendChild(folderCard);
                });

                // Add "Add Folder" card
                const addCard = document.createElement('div');
                addCard.className = 'add-folder-btn';
                addCard.onclick = () => this.showAddFolderModal();
                addCard.innerHTML = `
                    <i class="fas fa-plus" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <div>${translations[this.currentLanguage].folders.add}</div>
                `;
                grid.appendChild(addCard);
            }

            updateFolderSelects() {
                const todoFolderSelect = document.getElementById('todo-folder');
                const filterFolderSelect = document.getElementById('folder-filter');
                const addTodoForm = document.getElementById('add-todo-form');

                // Clear existing options except "All" for filter
                todoFolderSelect.innerHTML = '';
                filterFolderSelect.innerHTML = '<option value="all">All</option>';

                if (this.folders.length === 0) {
                    // No folders available
                    todoFolderSelect.innerHTML = '<option value="" disabled>No folders available</option>';
                    filterFolderSelect.innerHTML = '<option value="all">All</option>';
                    
                    // Disable the form
                    addTodoForm.style.opacity = '0.5';
                    addTodoForm.style.pointerEvents = 'none';

                    // Show message in todos container
                    const container = document.getElementById('todos-container');
                    container.innerHTML = `
                        <div class="empty-state-animated">
                            <span class="empty-state-decoration"><i class="fas fa-folder"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-circle"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-plus"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-star"></i></span>
                            <div class="empty-state-illustration">
                                <div class="empty-state-icon">
                                    <i class="fas fa-folder-open"></i>
                                </div>
                            </div>
                            <h3 class="empty-state-title">${translations[this.currentLanguage].errors.no_folders_title}</h3>
                            <p class="empty-state-message">${translations[this.currentLanguage].errors.no_folders_message}</p>
                        </div>
                    `;
                } else {
                    // Enable the form
                    addTodoForm.style.opacity = '1';
                    addTodoForm.style.pointerEvents = 'auto';

                    this.folders.forEach(folder => {
                        const todoOption = document.createElement('option');
                        todoOption.value = folder.id;
                        todoOption.textContent = folder.name;
                        todoFolderSelect.appendChild(todoOption);

                        const filterOption = document.createElement('option');
                        filterOption.value = folder.id;
                        filterOption.textContent = folder.name;
                        filterFolderSelect.appendChild(filterOption);
                    });
                }
            }

            selectFolder(folderId, clickedCard = null) {
                // Animate folder cards
                document.querySelectorAll('.folder-card').forEach(card => {
                    if (card.classList.contains('active')) {
                        card.classList.add('switching-out');
                        setTimeout(() => {
                            card.classList.remove('switching-out', 'active');
                        }, 300);
                    }
                });

                // Update folder filter
                document.getElementById('folder-filter').value = folderId;
                this.filters.folder = folderId;

                // Also update the folder select in the add-todo form
                document.getElementById('todo-folder').value = folderId;

                this.loadTodos();

                // Update visual selection with animation
                setTimeout(() => {
                    document.querySelectorAll('.folder-card').forEach(card => {
                        if (card.dataset.folderId === String(folderId) || (folderId === 'all' && card.dataset.folderId === 'all')) {
                            card.classList.add('switching-in', 'active');
                            setTimeout(() => {
                                card.classList.remove('switching-in');
                            }, 400);
                        }
                    });
                }, 150);
            }

            showAddFolderModal() {
                const modal = document.getElementById('add-folder-modal');
                modal.style.display = 'block';
                modal.classList.remove('hiding');
                modal.classList.add('showing');
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.remove('showing');
                modal.classList.add('hiding');
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.remove('hiding');
                }, 200);
            }

            async addFolder() {
                const name = document.getElementById('folder-name').value.trim();
                const color = document.getElementById('folder-color').value;

                if (!name) return;

                try {
                    const response = await fetch('/api/folders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            color
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.lastCreatedFolderId = data.id; // Store the new folder ID

                        document.getElementById('folder-name').value = '';
                        document.getElementById('folder-color').value = '#667eea';
                        this.closeModal('add-folder-modal');
                        await this.loadFolders();

                        // Auto-select the newly created folder
                        document.getElementById('todo-folder').value = this.lastCreatedFolderId;

                        this.showNotification('Folder created successfully', 'success');
                    } else {
                        throw new Error('Error creating folder');
                    }
                } catch (error) {
                    this.showNotification('Error creating folder', 'error');
                }
            }

            async deleteFolder(folderId) {
                if (!confirm(translations[this.currentLanguage].confirmations.delete_folder)) return;

                try {
                    const response = await fetch(`/api/folders/${folderId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        this.loadFolders();
                        this.loadTodos();
                        this.loadStats();
                        this.showNotification(translations[this.currentLanguage].success.folder_deleted, 'success');
                    } else {
                        throw new Error('Error deleting folder');
                    }
                } catch (error) {
                    this.showNotification('Error deleting folder', 'error');
                }
            }

            async loadTodos() {
                // Show skeleton loading
                const container = document.getElementById('todos-container');
                this.showSkeletonTodos(container);

                try {
                    const params = new URLSearchParams();
                    if (this.filters.status !== 'all') params.append('status', this.filters.status);
                    if (this.filters.category !== 'all') params.append('category', this.filters.category);
                    if (this.filters.folder !== 'all') params.append('folder', this.filters.folder);
                    if (this.filters.search) params.append('search', this.filters.search);

                    const response = await fetch(`/api/todos?${params}`);
                    let todos = await response.json();

                    // Filter out tasks that are in "Today" - they should only show in Today view
                    todos = todos.filter(t => !t.added_to_today);

                    this.todos = todos;
                    this.renderTodos();
                } catch (error) {
                    this.showNotification('Error loading tasks', 'error');
                }
            }

            async loadStats() {
                // Show skeleton stats
                this.showSkeletonStats();

                try {
                    const response = await fetch('/api/stats');
                    const stats = await response.json();

                    // Animate stat numbers with count effect
                    this.animateCounter('total-todos', stats.total);
                    this.animateCounter('completed-todos', stats.completed);
                    this.animateCounter('pending-todos', stats.pending);

                    const completionRate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
                    document.getElementById('completion-rate').textContent = `${completionRate}%`;
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }

            // Show skeleton loading for todos
            showSkeletonTodos(container) {
                if (!container) return;
                container.innerHTML = Array(3).fill(0).map(() => `
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text medium"></div>
                        <div class="skeleton skeleton-meta">
                            <div class="skeleton skeleton-badge"></div>
                            <div class="skeleton skeleton-badge"></div>
                        </div>
                    </div>
                `).join('');
            }

            // Show skeleton loading for stats
            showSkeletonStats() {
                const statNumbers = document.querySelectorAll('.stat-number');
                const statLabels = document.querySelectorAll('.stat-label');
                statNumbers.forEach(el => {
                    el.classList.add('skeleton');
                    el.textContent = '';
                });
                statLabels.forEach(el => {
                    el.classList.add('skeleton');
                    el.textContent = '';
                });
            }

            // Show skeleton loading for folders
            showSkeletonFolders() {
                const container = document.querySelector('.folders-grid');
                if (!container) return;
                container.innerHTML = Array(4).fill(0).map(() => `
                    <div class="skeleton-folder">
                        <div class="skeleton skeleton-folder-icon"></div>
                        <div class="skeleton skeleton-folder-name"></div>
                    </div>
                `).join('');
            }

            // Number counter animation
            animateCounter(elementId, newValue) {
                const element = document.getElementById(elementId);

                // Remove skeleton class if present
                element.classList.remove('skeleton');
                // Also remove skeleton from sibling label
                const labelElement = element.parentElement.querySelector('.stat-label');
                if (labelElement) {
                    labelElement.classList.remove('skeleton');
                }

                const currentValue = parseInt(element.textContent) || 0;
                const oldValue = currentValue;

                if (currentValue === newValue) return;

                // Add appropriate animation class
                element.classList.remove('increase', 'decrease', 'shake');
                void element.offsetWidth; // Trigger reflow

                if (newValue > currentValue) {
                    element.classList.add('increase');
                } else if (newValue < currentValue) {
                    if (elementId === 'pending-todos') {
                        element.classList.add('shake'); // Shake when pending increases
                    } else {
                        element.classList.add('decrease');
                    }
                }

                // Animate the number counting
                const duration = 500;
                const startTime = performance.now();

                const updateCount = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // Easing function for smooth animation
                    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                    const currentCount = Math.round(oldValue + (newValue - oldValue) * easeOutQuart);

                    element.textContent = currentCount;

                    if (progress < 1) {
                        requestAnimationFrame(updateCount);
                    } else {
                        element.textContent = newValue;
                        // Remove animation class after completion
                        setTimeout(() => {
                            element.classList.remove('increase', 'decrease', 'shake');
                        }, 300);
                    }
                };

                requestAnimationFrame(updateCount);
            }

            // Create ripple effect on button click
            createRipple(event) {
                const button = event.currentTarget;

                // Remove existing ripple
                const existingRipple = button.querySelector('.ripple');
                if (existingRipple) {
                    existingRipple.remove();
                }

                const circle = document.createElement('span');
                const diameter = Math.max(button.clientWidth, button.clientHeight);
                const radius = diameter / 2;

                const rect = button.getBoundingClientRect();
                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${event.clientX - rect.left - radius}px`;
                circle.style.top = `${event.clientY - rect.top - radius}px`;
                circle.classList.add('ripple');

                // Remove ripple after animation
                setTimeout(() => circle.remove(), 600);

                button.appendChild(circle);
            }

            // Create burst animation on checkbox/task completion
            createCompletionBurst(element) {
                const rect = element.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                // Create burst container
                const burst = document.createElement('div');
                burst.className = 'checkbox-burst';
                burst.style.left = `${centerX}px`;
                burst.style.top = `${centerY}px`;
                document.body.appendChild(burst);

                // Create particles
                const colors = ['#34c759', '#30d158', '#32d74b', '#4ade80', '#22c55e'];
                const particleCount = 12;

                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'burst-particle';
                    particle.style.backgroundColor = colors[i % colors.length];

                    const angle = (i / particleCount) * 360;
                    const distance = 40 + Math.random() * 30;
                    const tx = Math.cos(angle * Math.PI / 180) * distance;
                    const ty = Math.sin(angle * Math.PI / 180) * distance;

                    particle.style.setProperty('--tx', `${tx}px`);
                    particle.style.setProperty('--ty', `${ty}px`);

                    burst.appendChild(particle);
                }

                // Create star particles
                const starContainer = document.createElement('div');
                starContainer.className = 'success-stars';
                starContainer.style.left = `${centerX}px`;
                starContainer.style.top = `${centerY}px`;
                document.body.appendChild(starContainer);

                const stars = ['⭐', '✨', '🌟', '💫'];
                for (let i = 0; i < 4; i++) {
                    const star = document.createElement('div');
                    star.className = 'star-particle';
                    star.textContent = stars[i];
                    star.style.left = '0';
                    star.style.top = '0';

                    const angle = (i / 4) * 360;
                    const distance1 = 30 + Math.random() * 20;
                    const distance2 = 60 + Math.random() * 30;
                    const tx = Math.cos(angle * Math.PI / 180) * distance1;
                    const ty = Math.sin(angle * Math.PI / 180) * distance1;
                    const tx2 = Math.cos(angle * Math.PI / 180) * distance2;
                    const ty2 = Math.sin(angle * Math.PI / 180) * distance2;

                    star.style.setProperty('--tx', `${tx}px`);
                    star.style.setProperty('--ty', `${ty}px`);
                    star.style.setProperty('--tx2', `${tx2}px`);
                    star.style.setProperty('--ty2', `${ty2}px`);

                    starContainer.appendChild(star);
                }

                // Clean up
                setTimeout(() => {
                    burst.remove();
                    starContainer.remove();
                }, 800);
            }

            // Update progress bar with animation
            updateProgressBar(percentage) {
                const progressBar = document.getElementById('daily-progress-bar');
                if (!progressBar) return;

                // Add updating class for pulse effect
                progressBar.classList.add('updating');

                // Update width after a small delay for animation
                setTimeout(() => {
                    progressBar.style.width = `${percentage}%`;
                }, 50);

                // Remove updating class after animation
                setTimeout(() => {
                    progressBar.classList.remove('updating');
                }, 300);
            }

            async addTodo() {
                // Prevent duplicate submissions
                if (this.isSubmitting) return;
                this.isSubmitting = true;

                const title = document.getElementById('todo-title').value.trim();
                const description = document.getElementById('todo-description').value.trim();
                const priority = document.getElementById('todo-priority').value;
                const category = document.getElementById('todo-category').value;
                const folderId = document.getElementById('todo-folder').value;

                if (!title) {
                    this.isSubmitting = false;
                    return;
                }

                // Validar que existan carpetas
                if (this.folders.length === 0) {
                    this.isSubmitting = false;
                    this.showNotification(translations[this.currentLanguage].errors.no_folders, 'error');
                    return;
                }

                try {
                    const response = await fetch('/api/todos', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title,
                            description,
                            priority,
                            category,
                            folder_id: parseInt(folderId)
                        })
                    });

                    if (response.ok) {
                        // Preserve current folder selection instead of resetting to '1'
                        const currentFolderId = document.getElementById('todo-folder').value;

                        document.getElementById('add-todo-form').reset();
                        document.getElementById('todo-priority').value = 'medium';
                        document.getElementById('todo-category').value = 'general';

                        // Reset title textarea height
                        document.getElementById('todo-title').style.height = 'auto';

                        // Load folders and stats
                        await this.loadTodos();
                        await this.loadStats();
                        await this.loadFolders();

                        // Restore folder selection AFTER loadFolders() rebuilds the dropdown
                        document.getElementById('todo-folder').value = currentFolderId;

                        // Keep focus on title input for quick task entry
                        document.getElementById('todo-title').focus();

                        this.showNotification('Task added successfully', 'success');
                    } else {
                        throw new Error('Error adding task');
                    }
                } catch (error) {
                    this.showNotification('Error adding task', 'error');
                } finally {
                    // Reset submission guard
                    this.isSubmitting = false;
                }
            }

            async toggleTodo(id) {
                // Find the task to check if it's currently completed
                const todo = this.todos.find(t => t.id === id);

                if (!todo || todo.completed) {
                    // If already completed or task not found, use toggle (for unarchive scenario)
                    try {
                        const response = await fetch(`/api/todos/${id}/toggle`, {
                            method: 'PUT'
                        });

                        if (response.ok) {
                            this.loadTodos();
                            this.loadStats();
                            this.loadFolders();
                        } else {
                            throw new Error('Error updating task');
                        }
                    } catch (error) {
                        this.showNotification('Error updating task', 'error');
                    }
                } else {
                    // Task is not completed - mark as completed AND archive
                    // Get the todo element for animation before API call
                    const todoElement = document.querySelector(`[data-todo-id="${id}"]`);
                    const completeButton = todoElement?.querySelector('.btn-success');

                    // Trigger completion burst animation
                    if (completeButton) {
                        this.createCompletionBurst(completeButton);

                        // Also trigger emoji burst at button position
                        const rect = completeButton.getBoundingClientRect();
                        this.createEmojiBurst(rect.left + rect.width / 2, rect.top);
                    }

                    // Mascot celebrates
                    if (this.mascotState?.visible) {
                        this.setMascotEmotion('excited');
                        this.mascotSpeak('task_complete');
                        this.createMascotHearts(2);
                        setTimeout(() => this.setMascotEmotion('happy'), 1500);
                    }

                    // Add completing animation to the todo item
                    if (todoElement) {
                        todoElement.classList.add('completing');
                    }

                    try {
                        const response = await fetch(`/api/todos/${id}/archive`, {
                            method: 'PUT'
                        });

                        if (response.ok) {
                            // Play success sound
                            this.playSuccessSound();

                            this.loadTodos();
                            this.loadStats();
                            this.loadFolders();
                            this.showNotification('Task completed and archived', 'success');
                        } else {
                            throw new Error('Error updating task');
                        }
                    } catch (error) {
                        // Remove animation classes on error
                        if (todoElement) {
                            todoElement.classList.remove('completing');
                        }
                        this.showNotification('Error updating task', 'error');
                    }
                }
            }

            // Play success sound effect
            playSuccessSound() {
                const audio = new Audio('/static/Successful.wav');
                audio.volume = 0.3;
                audio.play().catch(() => {
                    // Ignore autoplay errors
                });
            }

            // Play delete sound effect
            playDeleteSound() {
                const audio = new Audio('/static/delete_task.wav');
                audio.volume = 0.3;
                audio.play().catch(() => {
                    // Ignore autoplay errors
                });
            }

            // Play whoosh sound effect for clearing all tasks
            playWhooshSound() {
                const audio = new Audio('/static/Whoosh.wav');
                audio.volume = 0.3;
                audio.play().catch(() => {
                    // Ignore autoplay errors
                });
            }

            async deleteTodo(id) {
                try {
                    const response = await fetch(`/api/todos/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        // Play delete sound effect
                        this.playDeleteSound();

                        // Refresh the appropriate view based on current view
                        if (this.currentView === 'archive') {
                            this.loadArchivedTodos();
                        } else {
                            this.loadTodos();
                        }
                        this.loadStats();
                        this.loadFolders();
                        this.showNotification('Task deleted successfully', 'success');
                    } else {
                        throw new Error('Error deleting task');
                    }
                } catch (error) {
                    this.showNotification('Error deleting task', 'error');
                }
            }

            // ============= NOTES FUNCTIONS =============

            async loadNotes() {
                // Show skeleton loading for notes
                const container = document.getElementById('notes-list');
                if (container) {
                    container.innerHTML = Array(2).fill(0).map(() => `
                        <div class="skeleton-card" style="min-height: 80px;">
                            <div class="skeleton skeleton-text long"></div>
                            <div class="skeleton skeleton-text medium"></div>
                            <div class="skeleton skeleton-text short"></div>
                        </div>
                    `).join('');
                }

                try {
                    const response = await fetch('/api/notes');
                    const notes = await response.json();
                    this.renderNotes(notes);
                } catch (error) {
                    this.showNotification('Error loading notes', 'error');
                }
            }

            renderNotes(notes) {
                const container = document.getElementById('notes-list');

                if (notes.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state-animated">
                            <span class="empty-state-decoration"><i class="fas fa-star"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-circle"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-pen"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-lightbulb"></i></span>
                            <div class="empty-state-illustration">
                                <div class="empty-state-icon">
                                    <i class="fas fa-sticky-note"></i>
                                </div>
                            </div>
                            <h3 class="empty-state-title" data-i18n="notes.empty">لايوجد ملاحظات هنا</h3>
                            <p class="empty-state-message" data-i18n="notes.empty_message">اظف ملاحظاتك هنا من الاعلى</p>
                        </div>
                    `;
                    this.updateDynamicTranslations();
                    return;
                }

                container.innerHTML = notes.map(note => `
                    <div class="note-card">
                        <div class="note-content">${this.escapeHtml(note.content)}</div>
                        <div class="note-actions">
                            <span class="note-date">${this.formatDate(note.created_at)}</span>
                            <div class="note-buttons note-buttons-vertical">
                                <button class="note-btn note-btn-delete" onclick="todoApp.deleteNote(${note.id})">
                                    <i class="fas fa-trash"></i>
                                    <span data-i18n="notes.delete">Delete</span>
                                </button>
                                <button class="note-btn note-btn-copy" onclick="todoApp.copyNote(${note.id})">
                                    <i class="fas fa-copy"></i>
                                    <span data-i18n="notes.copy">Copy</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                this.updateDynamicTranslations();
            }

            async addNote() {
                const content = document.getElementById('note-content').value.trim();

                if (!content) {
                    this.showNotification('Please enter a note', 'error');
                    return;
                }

                try {
                    const response = await fetch('/api/notes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content })
                    });

                    if (response.ok) {
                        document.getElementById('note-content').value = '';
                        this.loadNotes();
                        this.showNotification('Note added successfully', 'success');
                    } else {
                        throw new Error('Error adding note');
                    }
                } catch (error) {
                    this.showNotification('Error adding note', 'error');
                }
            }

            async deleteNote(id) {
                try {
                    const response = await fetch(`/api/notes/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        this.loadNotes();
                        this.showNotification('Note deleted successfully', 'success');
                    } else {
                        throw new Error('Error deleting note');
                    }
                } catch (error) {
                    this.showNotification('Error deleting note', 'error');
                }
            }

            async copyNote(id, button) {
                // Get the button that was clicked (event target)
                if (!button) {
                    button = event.currentTarget;
                }

                // Get note content from the DOM - the note-content div contains the actual text
                const noteCard = button.closest('.note-card');
                const contentDiv = noteCard.querySelector('.note-content');
                const content = contentDiv.textContent || contentDiv.innerText;

                if (!content) {
                    this.showNotification('Error copying note', 'error');
                    return;
                }

                // Try modern clipboard API first, fallback to older method
                if (navigator.clipboard && window.isSecureContext) {
                    try {
                        await navigator.clipboard.writeText(content);
                        this.showCopyFeedback(button);
                        return;
                    } catch (err) {
                        // Fall through to fallback method
                    }
                }

                // Fallback method using textarea
                this.fallbackCopy(content, button);
            }

            fallbackCopy(text, button) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                textarea.style.top = '-999999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        this.showCopyFeedback(button);
                    } else {
                        this.showNotification('Error copying note', 'error');
                    }
                } catch (err) {
                    this.showNotification('Error copying note', 'error');
                }

                document.body.removeChild(textarea);
            }

            showCopyFeedback(button) {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> <span data-i18n="notes.copied">Copied!</span>';
                button.style.background = '#22c55e';

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
            }

            async moveTodoToFolder(todoId, newFolderId) {
                // Usar el endpoint PUT /api/todos/<id> con folder_id
                try {
                    const response = await fetch(`/api/todos/${todoId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folder_id: parseInt(newFolderId) })
                    });
                    if (response.ok) {
                        this.loadTodos();
                        this.loadFolders();
                        this.loadStats();
                        this.showNotification('Task moved successfully', 'success');
                    } else {
                        throw new Error('Error moving task');
                    }
                } catch (error) {
                    this.showNotification('Error moving task', 'error');
                }
            }

            renderTodos() {
                const container = document.getElementById('todos-container');

                if (this.todos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state-animated">
                            <span class="empty-state-decoration"><i class="fas fa-star"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-circle"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-check"></i></span>
                            <span class="empty-state-decoration"><i class="fas fa-bolt"></i></span>
                            <div class="empty-state-illustration">
                                <div class="empty-state-icon">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                            </div>
                            <h3 class="empty-state-title">${translations[this.currentLanguage].empty.title}</h3>
                            <p class="empty-state-message">${translations[this.currentLanguage].empty.message}</p>
                        </div>
                    `;
                    this.updateDynamicTranslations();
                    return;
                }

                // Add filter-transition class for staggered animations
                container.classList.add('filter-transition');

                container.innerHTML = this.todos.map((todo, index) => {
                    const staggerClass = `stagger-${(index % 5) + 1}`;
                    return this.renderTodoItem(todo).replace('fade-in', `filtering-in ${staggerClass}`);
                }).join('');

                this.updateDynamicTranslations();

                // Setup drag and drop for reordering
                this.setupTodoReorderDragDrop();

                // Remove filter-transition class after animations
                setTimeout(() => {
                    container.classList.remove('filter-transition');
                    container.querySelectorAll('.todo-item').forEach(item => {
                        item.classList.remove('filtering-in');
                        item.classList.forEach(cls => {
                            if (cls.startsWith('stagger-')) item.classList.remove(cls);
                        });
                    });
                }, 500);
            }

            renderTodoItem(todo) {
                const priorityClass = `priority-${todo.priority}`;
                const priorityText = {
                    'high': translations[this.currentLanguage].priority.high,
                    'medium': translations[this.currentLanguage].priority.medium,
                    'low': translations[this.currentLanguage].priority.low
                }[todo.priority];

                const categoryText = {
                    'work': translations[this.currentLanguage].categories.work,
                    'personal': translations[this.currentLanguage].categories.personal,
                    'study': translations[this.currentLanguage].categories.study,
                    'health': translations[this.currentLanguage].categories.health,
                    'general': translations[this.currentLanguage].categories.general
                }[todo.category];

                const isSelected = this.selectedTasks.has(String(todo.id));

                return `
                    <div class="todo-item ${todo.completed ? 'completed' : ''} ${isSelected ? 'selected' : ''} fade-in" data-todo-id="${todo.id}" draggable="true">
                        <div class="todo-checkbox-wrapper ${isSelected ? 'checked' : ''}" onclick="todoApp.toggleTaskSelection(${todo.id})"></div>
                        <input type="checkbox" class="todo-checkbox" ${isSelected ? 'checked' : ''} onchange="todoApp.toggleTaskSelection(${todo.id})">
                        <div class="todo-header">
                            <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                <div class="todo-title" title="${this.escapeHtml(todo.title)}">${this.escapeHtml(todo.title)}</div>
                                ${todo.description ? `<div class="todo-description" title="${this.escapeHtml(todo.description)}">${this.escapeHtml(todo.description)}</div>` : ''}
                                <div style="margin-top: 8px; position: relative;">
                                    <button class="btn btn-sm btn-secondary move-folder-btn" data-todo-id="${todo.id}" style="font-size:0.95em; padding:4px 12px;">
                                        <i class="fas fa-random"></i> ${translations[this.currentLanguage].folders.title}
                                    </button>
                                </div>
                            </div>
                            <div class="todo-actions">
                                <button class="btn btn-sm ${todo.added_to_today ? 'btn-warning' : 'btn-secondary'}"
                                        onclick="todoApp.toggleAddToToday(${todo.id})"
                                        title="${todo.added_to_today ? 'Remove from Today' : 'Add to Today'}">
                                    <i class="fas ${todo.added_to_today ? 'fa-calendar-minus' : 'fa-calendar-plus'}"></i>
                                    ${todo.added_to_today ? translations[this.currentLanguage].today.remove : translations[this.currentLanguage].today.add}
                                </button>
                                <button class="btn btn-sm ${todo.completed ? 'btn-secondary' : 'btn-success'}"
                                        onclick="todoApp.toggleTodo(${todo.id})">
                                    <i class="fas ${todo.completed ? 'fa-undo' : 'fa-check'}"></i>
                                    ${todo.completed ? translations[this.currentLanguage].actions.uncomplete : translations[this.currentLanguage].actions.complete}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="todoApp.deleteTodo(${todo.id})">
                                    <i class="fas fa-trash"></i>
                                    ${translations[this.currentLanguage].actions.delete}
                                </button>
                            </div>
                        </div>
                        <div class="todo-meta">
                            <span class="priority-badge ${priorityClass}">${priorityText}</span>
                            <span class="category-badge">${categoryText}</span>
                            <span class="folder-badge" style="background-color: ${todo.folder_color}">${todo.folder_name}</span>
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">
                                <i class="fas fa-clock"></i>
                                ${this.formatDate(todo.created_at)}
                            </small>
                        </div>
                    </div>
                `;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                const localeMap = {
                    'en': 'en-US',
                    'ar': 'ar-SA',
                    'es': 'es-ES'
                };
                return date.toLocaleDateString(localeMap[this.currentLanguage] || 'en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            getArchiveDateLabel(dateString) {
                const date = new Date(dateString);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                // Reset time to compare dates only
                const compareDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const compareToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const compareYesterday = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());

                if (compareDate.getTime() === compareToday.getTime()) {
                    return translations[this.currentLanguage]?.archive?.today || 'Today';
                } else if (compareDate.getTime() === compareYesterday.getTime()) {
                    return translations[this.currentLanguage]?.archive?.yesterday || 'Yesterday';
                } else {
                    const localeMap = {
                        'en': 'en-US',
                        'ar': 'ar-SA',
                        'es': 'es-ES'
                    };
                    return date.toLocaleDateString(localeMap[this.currentLanguage] || 'en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');

                // Remove any existing notifications of the same type to avoid clutter
                const existingNotifications = container.querySelectorAll(`.notification.${type}`);
                existingNotifications.forEach(n => {
                    n.classList.add('hiding');
                    setTimeout(() => n.remove(), 400);
                });

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;

                // Create enhanced notification structure
                notification.innerHTML = `
                    <span class="notification-icon"></span>
                    <span class="notification-content">${message}</span>
                    <button class="notification-close" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                `;

                container.appendChild(notification);

                // Add close button functionality
                const closeBtn = notification.querySelector('.notification-close');
                closeBtn.addEventListener('click', () => {
                    notification.classList.add('hiding');
                    setTimeout(() => notification.remove(), 400);
                });

                // Show notification with slight delay for animation
                requestAnimationFrame(() => {
                    setTimeout(() => notification.classList.add('show'), 50);
                });

                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.classList.add('hiding');
                        setTimeout(() => notification.remove(), 400);
                    }
                }, 3000);
            }

            // Initialize particle effects
            setupParticles() {
                const container = document.getElementById('particles-container');
                if (!container) return;

                const particleCount = 20;
                const colors = [
                    'var(--accent-color)',
                    'var(--success-color)',
                    'var(--warning-color)',
                    'var(--text-tertiary)'
                ];

                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';

                    const size = Math.random() * 8 + 4;
                    const left = Math.random() * 100;
                    const delay = Math.random() * 20;
                    const duration = Math.random() * 20 + 15;
                    const color = colors[Math.floor(Math.random() * colors.length)];

                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.left = `${left}%`;
                    particle.style.animationDelay = `${delay}s`;
                    particle.style.animationDuration = `${duration}s`;
                    particle.style.background = color;

                    container.appendChild(particle);
                }

                // Setup mascot
                this.setupMascot();
            }

            // ============================================
            // MASCOT CHARACTER
            // ============================================
            setupMascot() {
                this.mascotState = {
                    visible: true,
                    emotion: 'happy',
                    speechTimer: null
                };

                const mascot = document.getElementById('mascot');
                const mascotToggle = document.getElementById('mascot-toggle');
                const mascotContainer = document.getElementById('mascot-container');

                // Mascot click interaction
                mascot?.addEventListener('click', () => this.mascotInteract());

                // Toggle button
                mascotToggle?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleMascot();
                });

                // Show initial greeting after a delay
                setTimeout(() => {
                    this.mascotSpeak('hello');
                }, 2000);

                // Random mascot comments
                this.startMascotIdleBehavior();
            }

            toggleMascot() {
                const container = document.getElementById('mascot-container');
                const toggleBtn = document.getElementById('mascot-toggle');
                this.mascotState.visible = !this.mascotState.visible;

                if (this.mascotState.visible) {
                    container.classList.remove('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    this.mascotSpeak('happy');
                } else {
                    container.classList.add('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                }
            }

            mascotInteract() {
                const reactions = ['happy', 'excited', 'thinking'];
                const reaction = reactions[Math.floor(Math.random() * reactions.length)];
                this.setMascotEmotion(reaction);

                const messages = {
                    happy: ['happy', 'hello'],
                    excited: ['excited', 'task_complete'],
                    thinking: ['thinking']
                };

                const msgArray = messages[reaction];
                this.mascotSpeak(msgArray[Math.floor(Math.random() * msgArray.length)]);

                // Create heart effect
                this.createMascotHearts(3);

                // Reset emotion after 2 seconds
                setTimeout(() => this.setMascotEmotion('happy'), 2000);
            }

            setMascotEmotion(emotion) {
                const mascot = document.getElementById('mascot');
                if (!mascot) return;

                // Remove all emotion classes
                mascot.classList.remove('happy', 'excited', 'thinking', 'sleepy');

                if (emotion && emotion !== 'happy') {
                    mascot.classList.add(emotion);
                }

                this.mascotState.emotion = emotion;
            }

            mascotSpeak(key) {
                const speech = document.getElementById('mascot-speech');
                if (!speech) return;

                const t = translations[this.currentLanguage];
                const message = t.mascot[key] || t.mascot.hello;

                speech.textContent = message;
                speech.classList.add('show');

                // Clear previous timer
                if (this.mascotState.speechTimer) {
                    clearTimeout(this.mascotState.speechTimer);
                }

                // Hide after 3 seconds
                this.mascotState.speechTimer = setTimeout(() => {
                    speech.classList.remove('show');
                }, 3000);
            }

            createMascotHearts(count = 1) {
                const mascot = document.getElementById('mascot');
                if (!mascot) return;

                const container = document.getElementById('mascot-container');
                const rect = mascot.getBoundingClientRect();

                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const heart = document.createElement('div');
                        heart.className = 'mascot-heart';
                        heart.textContent = ['❤️', '💜', '💖', '✨'][Math.floor(Math.random() * 4)];
                        heart.style.left = `${Math.random() * 40 + 20}px`;
                        heart.style.top = '20px';
                        container.appendChild(heart);

                        setTimeout(() => heart.remove(), 1000);
                    }, i * 100);
                }
            }

            startMascotIdleBehavior() {
                // mascot comments based on time and progress
                setInterval(() => {
                    if (!this.mascotState.visible) return;

                    const hour = new Date().getHours();
                    let message = 'hello';

                    if (hour < 12) {
                        message = 'day_start';
                    } else if (hour > 22) {
                        message = 'sleepy';
                        this.setMascotEmotion('sleepy');
                    }

                    // Random chance to speak
                    if (Math.random() > 0.7) {
                        this.mascotSpeak(message);
                    }
                }, 60000); // Every minute
            }

            mascotReactToProgress(percentage) {
                if (!this.mascotState.visible) return;

                if (percentage >= 100) {
                    this.setMascotEmotion('excited');
                    this.mascotSpeak('excited');
                    this.createMascotHearts(5);
                } else if (percentage >= 75) {
                    this.setMascotEmotion('happy');
                    this.mascotSpeak('happy');
                    this.createMascotHearts(2);
                } else if (percentage >= 50) {
                    this.setMascotEmotion('happy');
                    this.createMascotHearts(1);
                }
            }

            // ============================================
            // ENHANCED CELEBRATION ANIMATIONS
            // ============================================

            // Enhanced emoji burst on task completion
            createEmojiBurst(x, y) {
                const container = document.getElementById('emoji-burst-container');
                if (!container) return;

                const emojis = ['🎉', '⭐', '✨', '🌟', '💫', '🎊', '👏', '💪', '🔥', '💯'];

                for (let i = 0; i < 12; i++) {
                    const emoji = document.createElement('div');
                    emoji.className = 'emoji-particle';
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.left = `${x + (Math.random() - 0.5) * 100}px`;
                    emoji.style.top = `${y}px`;
                    emoji.style.animationDelay = `${i * 0.05}s`;

                    container.appendChild(emoji);

                    setTimeout(() => emoji.remove(), 1500);
                }
            }

            // Rainbow confetti for day completion
            createRainbowConfetti() {
                const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#1dd1a1'];

                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'rainbow-confetti';
                        confetti.style.left = `${Math.random() * 100}vw`;
                        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                        confetti.style.animationDuration = `${2 + Math.random() * 2}s`;

                        document.body.appendChild(confetti);

                        // Trigger animation
                        requestAnimationFrame(() => confetti.classList.add('animate'));

                        setTimeout(() => confetti.remove(), 4000);
                    }, i * 50);
                }
            }

            // Day complete celebration overlay
            showDayCompleteCelebration(taskCount, streak) {
                const overlay = document.getElementById('day-complete-overlay');
                const tasksEl = document.getElementById('day-complete-tasks');
                const streakEl = document.getElementById('day-complete-streak');
                const closeBtn = document.getElementById('day-complete-btn');

                if (!overlay) return;

                tasksEl.textContent = taskCount;
                streakEl.textContent = streak;

                // Show overlay
                overlay.classList.add('show');

                // Create confetti
                this.createRainbowConfetti();

                // Make mascot excited
                this.setMascotEmotion('excited');
                this.mascotSpeak('excited');

                // Close button handler
                const closeHandler = () => {
                    overlay.classList.remove('show');
                    closeBtn.removeEventListener('click', closeHandler);
                    this.setMascotEmotion('happy');
                };

                closeBtn.addEventListener('click', closeHandler);

                // Auto-close after 5 seconds
                setTimeout(() => {
                    if (overlay.classList.contains('show')) {
                        closeHandler();
                    }
                }, 5000);
            }

            // Update streak counter
            updateStreak(streak) {
                const streakCounter = document.getElementById('streak-counter');
                const streakNumber = document.getElementById('streak-number');

                if (!streakCounter || !streakNumber) return;

                if (streak > 0) {
                    streakCounter.style.display = 'flex';
                    streakNumber.textContent = streak;
                } else {
                    streakCounter.style.display = 'none';
                }
            }
        }

        // Initialize the app when the page loads
        let todoApp;
        document.addEventListener('DOMContentLoaded', () => {
            todoApp = new TodoApp();
        });
    </script>
</body>
</html> 