<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster - Task Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'ArabicCustom';
            src: url('/mainfont.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'ArabicCustom', 'Inter', sans-serif;
        }

        body[data-lang="ar"], body[lang="ar"] {
            direction: rtl;
        }

        body[data-lang="ar"] .header,
        body[data-lang="ar"] .stats-bar,
        body[data-lang="ar"] .folders-header,
        body[data-lang="ar"] .controls,
        body[data-lang="ar"] .filters {
            text-align: right;
        }

        body[data-lang="ar"] .filter-group {
            flex-direction: row;
        }

        body[data-lang="ar"] .todo-header {
            flex-direction: row;
        }

        body[data-lang="ar"] .todo-actions {
            margin-left: 0;
            margin-right: auto;
        }

        body[data-lang="ar"] .move-folder-global-dropdown {
            right: auto;
            left: 0;
        }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fafafa;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #86868b;
            --border-color: #e5e5e7;
            --border-color-light: #f0f0f2;
            --accent-color: #0071e3;
            --accent-hover: #0077ed;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            position: relative;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .language-switcher {
            display: none;
            position: absolute;
            top: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 4px;
        }

        .language-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.15s ease;
        }

        .language-btn:hover {
            color: var(--text-primary);
        }

        .language-btn.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .telegram-enabled {
            color: var(--success-color);
        }

        .telegram-disabled {
            color: var(--danger-color);
        }

        .telegram-pending {
            color: var(--warning-color);
        }

        .view-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 4px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .view-tab {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .view-tab:hover {
            color: var(--text-primary);
        }

        .view-tab.active {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .today-badge {
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .today-badge:empty {
            display: none;
        }

        .main-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .stats-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 20px 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 24px;
        }

        .stat-item {
            padding: 0;
            background: none;
            text-align: center;
        }

        .stat-number {
            font-size: 1.75rem;
            font-weight: 600;
            display: block;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .controls {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
            font-size: 0.85rem;
        }

        select, input[type="text"], textarea {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            transition: all 0.15s ease;
            background: var(--bg-secondary);
            min-width: 120px;
            max-width: 100%;
            color: var(--text-primary);
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        select:hover, input[type="text"]:hover, textarea:hover {
            border-color: var(--text-tertiary);
        }

        select:focus, input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .add-todo-form {
            display: grid;
            grid-template-columns: repeat(5, 1fr) auto;
            gap: 12px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .folders-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        .folders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .folders-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .folder-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }

        .folder-card:hover {
            border-color: var(--accent-color);
        }

        .folder-card.active {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .folder-card.active .folder-name {
            color: var(--accent-color);
        }

        .folder-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--text-tertiary);
        }

        .folder-card.active .folder-icon {
            color: var(--accent-color);
        }

        .folder-name, .todo-title, .todo-description {
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: unset !important;
            display: block !important;
            word-break: break-word;
            max-width: 100%;
        }
        .folder-name {
            max-width: 180px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        .todo-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .todo-description {
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .folder-count {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .folder-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
        }

        .folder-card:hover .folder-actions {
            display: block;
        }

        .folder-actions button {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--danger-color);
        }

        .folder-actions button:hover {
            border-color: var(--danger-color);
        }

        .add-folder-btn {
            background: var(--bg-secondary);
            border: 1px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .add-folder-btn:hover {
            border-color: var(--text-tertiary);
            color: var(--text-primary);
        }

        .todos-container {
            padding: 24px;
        }

        .todo-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.15s ease;
            position: relative;
        }

        .todo-item:hover {
            border-color: var(--accent-color);
        }

        .todo-item.completed {
            background: var(--bg-tertiary);
        }

        .todo-item.completed .todo-title {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .todo-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .priority-badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .priority-high {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger-color);
        }

        .priority-medium {
            background: rgba(255, 149, 0, 0.1);
            color: var(--warning-color);
        }

        .priority-low {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
        }

        .category-badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .folder-badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            background: var(--accent-color);
            color: white;
        }

        .todo-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 2px solid var(--border-color-light);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: 10% auto;
            padding: 24px;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 440px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close {
            color: var(--text-tertiary);
            font-size: 24px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all 0.15s ease;
        }

        .close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .add-todo-form {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .todo-header {
                flex-direction: column;
                gap: 8px;
            }

            .todo-actions {
                margin-left: 0;
                justify-content: flex-end;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .folders-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }

            /* Responsive Kanban */
            .kanban-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .suggested-tasks-container {
                flex-direction: column;
            }

            .suggested-task-card {
                min-width: 100%;
                max-width: 100%;
            }

            .kanban-column {
                max-height: none;
            }

            .view-tabs {
                flex-wrap: wrap;
            }

            .view-tab {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 600px) {
            .todo-title, .todo-description {
                font-size: 1rem;
                max-width: 100%;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.info {
            background: var(--accent-color);
        }

        /* Limitar ancho del select de carpetas en el formulario de tareas */
        #todo-folder {
            max-width: 170px;
            min-width: 100px;
            width: 100%;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            display: block;
        }
        /* Truncar visualmente las opciones del select */
        #todo-folder option {
            max-width: 170px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Asegurar que el dropdown de mover tarea esté por encima de la tarjeta y otros elementos */
        .move-folder-dropdown {
            z-index: 9999 !important;
            pointer-events: none;
        }
        .move-folder-dropdown[style*='display: block'],
        .move-folder-dropdown[style*='display:block'] {
            pointer-events: auto;
        }
        /* Evitar que el overflow de la tarjeta o contenedores oculte el menú */
        .todo-item, .todos-container {
            overflow: visible !important;
        }

        /* ============ MULTI-SELECT STYLES ============ */

        /* Selection mode overlay */
        .selection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 1000;
            display: none;
            user-select: none;
        }

        .selection-overlay.active {
            display: block;
        }

        /* Selection box */
        .selection-box {
            position: fixed;
            border: 2px solid var(--accent-color);
            background: rgba(0, 113, 227, 0.1);
            pointer-events: none;
            z-index: 1001;
            display: none;
            border-radius: 4px;
        }

        .selection-box.active {
            display: block;
        }

        /* Checkbox for task selection */
        .todo-checkbox {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .todo-item:hover .todo-checkbox,
        .todo-item.selected .todo-checkbox,
        .selection-mode .todo-checkbox {
            opacity: 1;
        }

        /* Custom checkbox appearance */
        .todo-checkbox-wrapper {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            cursor: pointer;
            z-index: 9;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .todo-checkbox-wrapper:hover {
            border-color: var(--accent-color);
        }

        .todo-checkbox-wrapper.checked {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .todo-checkbox-wrapper.checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 12px;
        }

        /* Selected task styling */
        .todo-item.selected {
            border-color: var(--accent-color);
            background: rgba(0, 113, 227, 0.05);
        }

        .todo-item.selected .todo-checkbox-wrapper {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .todo-item.selected .todo-checkbox-wrapper::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 12px;
        }

        /* Adjust todo item padding for checkbox */
        .todo-item {
            padding-left: 48px;
        }

        /* Bulk action toolbar */
        .bulk-action-toolbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 1002;
            transition: transform 0.3s ease;
        }

        .bulk-action-toolbar.visible {
            transform: translateX(-50%) translateY(0);
        }

        .bulk-action-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .bulk-action-count {
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .bulk-action-buttons {
            display: flex;
            gap: 8px;
        }

        .bulk-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .bulk-action-btn.move {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .bulk-action-btn.move:hover {
            background: var(--bg-primary);
            border-color: var(--accent-color);
        }

        .bulk-action-btn.delete {
            background: var(--danger-color);
            color: white;
        }

        .bulk-action-btn.delete:hover {
            opacity: 0.9;
        }

        .bulk-action-btn.clear {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 8px;
        }

        .bulk-action-btn.clear:hover {
            color: var(--text-primary);
        }

        /* Bulk move dropdown */
        .bulk-move-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 8px;
            min-width: 200px;
            background: var(--bg-secondary);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            z-index: 1003;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
            display: none;
        }

        .bulk-move-dropdown.visible {
            display: block;
        }

        .bulk-move-dropdown .folder-option {
            padding: 10px 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bulk-move-dropdown .folder-option:hover {
            background: var(--bg-tertiary);
        }

        .bulk-move-dropdown .folder-option .folder-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Selection mode for Kanban */
        .kanban-card .todo-checkbox-wrapper {
            top: 8px;
            left: 8px;
        }

        .kanban-card .todo-checkbox {
            top: 8px;
            left: 8px;
        }

        .kanban-card {
            padding-left: 36px;
        }

        .kanban-card.selected {
            border-color: var(--accent-color);
            background: rgba(0, 113, 227, 0.05);
        }

        /* Suggested task selection */
        .suggested-task-card .todo-checkbox-wrapper {
            top: 8px;
            left: 8px;
        }

        .suggested-task-card .todo-checkbox {
            top: 8px;
            left: 8px;
        }

        .suggested-task-card {
            padding-left: 36px;
        }

        .suggested-task-card.selected {
            border-color: var(--accent-color);
            background: rgba(0, 113, 227, 0.05);
        }

        /* Select all checkbox */
        .select-all-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .select-all-container .todo-checkbox-wrapper {
            position: static;
        }

        .select-all-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
        }

        /* Menú flotante global para mover tarea */
        .move-folder-global-dropdown {
            position: absolute;
            left: 0;
            top: 0;
            min-width: 180px;
            background: var(--bg-secondary);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            z-index: 99999;
            max-height: 260px;
            overflow-y: auto;
            padding: 4px;
            animation: fadeIn 0.15s;
        }
        .move-folder-global-dropdown .move-folder-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: background 0.15s;
            white-space: nowrap;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .move-folder-global-dropdown .move-folder-option:hover {
            background: var(--bg-tertiary);
        }

        /* Kanban Board Styles */
        .kanban-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            padding: 24px;
            background: var(--bg-tertiary);
            align-items: start;
        }

        .suggested-tasks-section {
            grid-column: 1 / -1;
            margin-bottom: 8px;
        }

        .suggested-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .suggested-tasks-header h3 {
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .suggested-tasks-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 8px 4px;
            min-height: 120px;
        }

        .suggested-task-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px;
            min-width: 240px;
            max-width: 280px;
            cursor: grab;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .suggested-task-card:hover {
            border-color: var(--accent-color);
        }

        .suggested-task-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .suggested-task-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .suggested-task-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .suggested-task-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .suggested-task-badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
        }

        .suggested-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.9rem;
        }

        .kanban-column {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            min-height: 400px;
            overflow: visible;
            position: relative;
        }

        .kanban-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .kanban-header h3 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kanban-header .count {
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .kanban-cards {
            padding: 12px;
            background: var(--bg-tertiary);
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }

        .kanban-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px;
            margin-bottom: 0;
            cursor: grab;
            transition: all 0.15s ease;
        }

        .kanban-card:hover {
            border-color: var(--accent-color);
        }

        .kanban-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .kanban-column.drag-over .kanban-cards {
            background: var(--bg-primary);
        }

        .kanban-card-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .kanban-card-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .kanban-card-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .kanban-card-badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Archive View Styles */
        .archive-container {
            padding: 24px;
        }

        .archive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .archive-header h2 {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .archive-actions {
            display: flex;
            gap: 8px;
        }

        .archive-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .archive-empty i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .archive-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--success-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.15s ease;
        }

        .archive-item:hover {
            border-color: var(--success-color);
        }

        .archive-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .archive-item-title {
            font-weight: 500;
            color: var(--text-primary);
            text-decoration: line-through;
            opacity: 0.6;
        }

        .archive-item-actions {
            display: flex;
            gap: 8px;
        }

        .archive-item-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Notes Styles */
        .notes-container {
            padding: 24px;
        }

        .notes-header {
            margin-bottom: 20px;
        }

        .notes-header h2 {
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .add-note-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 24px;
        }

        .note-input {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 12px;
            font-family: inherit;
            font-size: 0.95rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
        }

        .note-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .note-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            position: relative;
        }

        .note-content {
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 12px;
        }

        .note-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .note-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .note-buttons {
            display: flex;
            gap: 8px;
        }

        .note-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
        }

        .note-btn-copy {
            background: var(--primary-color);
            color: white;
        }

        .note-btn-copy:hover {
            opacity: 0.9;
        }

        .note-btn-delete {
            background: #ef4444;
            color: white;
        }

        .note-btn-delete:hover {
            background: #dc2626;
        }

        .notes-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .notes-empty i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.4;
        }
    </style>
</head>
<body data-lang="ar">
    <div class="container">
        <div class="header">
            <div class="language-switcher">
                <button class="language-btn" data-lang="en">EN</button>
                <button class="language-btn active" data-lang="ar">عربي</button>
            </div>
            <h1><i class="fas fa-tasks"></i> <span data-i18n="title">برنامج المهندس</span></h1>
        </div>

        <div class="view-tabs">
            <button class="view-tab active" data-view="all-tasks" onclick="todoApp.switchView('all-tasks')">
                <i class="fas fa-list"></i>
                <span data-i18n="views.all_tasks">All Tasks</span>
            </button>
            <button class="view-tab" data-view="today" onclick="todoApp.switchView('today')">
                <i class="fas fa-calendar-day"></i>
                <span data-i18n="views.today">Today</span>
                <span class="today-badge" id="today-badge">0</span>
            </button>
            <button class="view-tab" data-view="archive" onclick="todoApp.switchView('archive')">
                <i class="fas fa-archive"></i>
                <span data-i18n="views.archive">Archive</span>
            </button>
            <button class="view-tab" data-view="notes" onclick="todoApp.switchView('notes')">
                <i class="fas fa-sticky-note"></i>
                <span data-i18n="views.notes">Notes</span>
            </button>
        </div>

        <div class="main-content">
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-number" id="total-todos">0</span>
                    <span class="stat-label" data-i18n="stats.total">Total</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="completed-todos">0</span>
                    <span class="stat-label" data-i18n="stats.completed">Completed</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="pending-todos">0</span>
                    <span class="stat-label" data-i18n="stats.pending">Pending</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="completion-rate">0%</span>
                    <span class="stat-label" data-i18n="stats.progress">Progress</span>
                </div>
            </div>

            <div class="folders-section">
                <div class="folders-header">
                    <h3 data-i18n="folders.title">Folders</h3>
                    <button class="btn btn-primary" onclick="todoApp.showAddFolderModal()">
                        <i class="fas fa-folder-plus"></i>
                        <span data-i18n="folders.add">Add Folder</span>
                    </button>
                </div>
                <div class="folders-grid" id="folders-grid">
                    <!-- Folders will be loaded here -->
                </div>
            </div>

            <div class="controls">
                <div class="filters">
                    <div class="filter-group">
                        <label data-i18n="filters.status">Status:</label>
                        <select id="status-filter">
                            <option value="all" data-i18n="filters.all">All</option>
                            <option value="pending" data-i18n="filters.pending">Pending</option>
                            <option value="completed" data-i18n="filters.completed">Completed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label data-i18n="filters.category">Category:</label>
                        <select id="category-filter">
                            <option value="all" data-i18n="filters.all">All</option>
                            <option value="work" data-i18n="categories.work">Work</option>
                            <option value="personal" data-i18n="categories.personal">Personal</option>
                            <option value="study" data-i18n="categories.study">Study</option>
                            <option value="health" data-i18n="categories.health">Health</option>
                            <option value="general" data-i18n="categories.general">General</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label data-i18n="filters.folder">Folder:</label>
                        <select id="folder-filter">
                            <option value="all" data-i18n="filters.all">All</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label data-i18n="filters.search">Search:</label>
                        <input type="text" id="search-input" data-i18n-placeholder="filters.search_placeholder">
                    </div>
                </div>

                <form class="add-todo-form" id="add-todo-form">
                    <div class="form-group">
                        <label data-i18n="form.title">Title</label>
                        <textarea id="todo-title" rows="1" data-i18n-placeholder="form.title_placeholder" required maxlength="500" style="resize: none; overflow: hidden; min-height: 38px;"></textarea>
                    </div>
                    <div class="form-group">
                        <label data-i18n="form.description">Description</label>
                        <textarea id="todo-description" rows="3" data-i18n-placeholder="form.description_placeholder" maxlength="5000"></textarea>
                    </div>
                    <div class="form-group">
                        <label data-i18n="form.priority">Priority</label>
                        <select id="todo-priority">
                            <option value="low" data-i18n="priority.low">Low</option>
                            <option value="medium" selected data-i18n="priority.medium">Medium</option>
                            <option value="high" data-i18n="priority.high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="form.category">Category</label>
                        <select id="todo-category">
                            <option value="general" selected data-i18n="categories.general">General</option>
                            <option value="work" data-i18n="categories.work">Work</option>
                            <option value="personal" data-i18n="categories.personal">Personal</option>
                            <option value="study" data-i18n="categories.study">Study</option>
                            <option value="health" data-i18n="categories.health">Health</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="form.folder">Folder</label>
                        <select id="todo-folder">
                            <option value="1" selected>General</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        <span data-i18n="form.add">Add</span>
                    </button>
                </form>
            </div>

            <div class="todos-container" id="todos-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p data-i18n="loading">Loading tasks...</p>
                </div>
            </div>

            <!-- Kanban Board for Today View -->
            <div class="kanban-container" id="kanban-container" style="display: none;">
                <!-- Suggested Tasks Section -->
                <div class="suggested-tasks-section">
                    <div class="suggested-tasks-header">
                        <h3><i class="fas fa-lightbulb" style="color: var(--warning-color);"></i> <span data-i18n="suggested.title">Suggested Tasks</span></h3>
                        <small style="color: var(--text-secondary);"><i class="fas fa-info-circle"></i> <span data-i18n="suggested.hint">Drag tasks to Kanban columns to add them to Today</span></small>
                    </div>
                    <div class="suggested-tasks-container" id="suggested-tasks-container">
                        <!-- Suggested tasks will be loaded here -->
                    </div>
                </div>

                <!-- Kanban Columns -->
                <div class="kanban-column" data-status="todo">
                    <div class="kanban-header">
                        <h3><i class="fas fa-clipboard-list"></i> <span data-i18n="kanban.todo">To Do</span></h3>
                        <span class="count" id="kanban-todo-count">0</span>
                    </div>
                    <div class="kanban-cards" id="kanban-todo">
                        <!-- Kanban cards will be loaded here -->
                    </div>
                </div>
                <div class="kanban-column" data-status="doing">
                    <div class="kanban-header">
                        <h3><i class="fas fa-spinner"></i> <span data-i18n="kanban.doing">Doing</span></h3>
                        <span class="count" id="kanban-doing-count">0</span>
                    </div>
                    <div class="kanban-cards" id="kanban-doing">
                        <!-- Kanban cards will be loaded here -->
                    </div>
                </div>
                <div class="kanban-column" data-status="done">
                    <div class="kanban-header">
                        <h3><i class="fas fa-check-circle"></i> <span data-i18n="kanban.done">Done</span></h3>
                        <span class="count" id="kanban-done-count">0</span>
                    </div>
                    <div class="kanban-cards" id="kanban-done">
                        <!-- Kanban cards will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Archive View -->
            <div class="archive-container" id="archive-container" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p data-i18n="loading">Loading archived tasks...</p>
                </div>
            </div>

            <!-- Notes View -->
            <div class="notes-container" id="notes-container" style="display: none;">
                <div class="notes-header">
                    <h2 data-i18n="notes.title">My Notes</h2>
                </div>

                <!-- Add Note Form -->
                <div class="add-note-section">
                    <textarea id="note-content" class="note-input" rows="4" data-i18n-placeholder="notes.placeholder" maxlength="10000"></textarea>
                    <button class="btn btn-primary" onclick="todoApp.addNote()">
                        <i class="fas fa-plus"></i> <span data-i18n="notes.add">Add Note</span>
                    </button>
                </div>

                <!-- Notes List -->
                <div class="notes-list" id="notes-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p data-i18n="loading">Loading notes...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Folder Modal -->
    <div id="add-folder-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="folders.add_title">Add New Folder</h3>
                <span class="close" onclick="todoApp.closeModal('add-folder-modal')">&times;</span>
            </div>
            <form id="add-folder-form">
                <div class="form-group">
                    <label data-i18n="folders.name">Folder Name</label>
                    <input type="text" id="folder-name" required maxlength="40">
                </div>
                <div class="form-group">
                    <label data-i18n="folders.color">Color</label>
                    <input type="color" id="folder-color" value="#667eea">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="todoApp.closeModal('add-folder-modal')" data-i18n="common.cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-i18n="common.save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification-container"></div>

    <!-- Multi-Select Elements -->
    <div class="selection-overlay" id="selection-overlay"></div>
    <div class="selection-box" id="selection-box"></div>

    <!-- Bulk Action Toolbar -->
    <div class="bulk-action-toolbar" id="bulk-action-toolbar">
        <div class="bulk-action-info">
            <span class="bulk-action-count" id="selected-count">0</span>
            <span id="selected-text">tasks selected</span>
        </div>
        <div class="bulk-action-buttons">
            <button class="bulk-action-btn move" id="bulk-move-btn">
                <i class="fas fa-folder"></i> Move
            </button>
            <button class="bulk-action-btn delete" id="bulk-delete-btn">
                <i class="fas fa-trash"></i> Delete
            </button>
            <button class="bulk-action-btn clear" id="bulk-clear-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <!-- Bulk Move Dropdown -->
        <div class="bulk-move-dropdown" id="bulk-move-dropdown">
            <!-- Folders will be populated here -->
        </div>
    </div>

    <script>
        // Language translations
        const translations = {
            en: {
                title: "TaskMaster",
                subtitle: "Manage your tasks efficiently and organized",
                views: {
                    all_tasks: "All Tasks",
                    today: "Today",
                    archive: "Archive",
                    notes: "Notes"
                },
                notes: {
                    title: "My Notes",
                    add: "Add Note",
                    placeholder: "Write your note here...",
                    empty: "No notes yet",
                    empty_message: "Create your first note above",
                    copy: "Copy",
                    copied: "Copied!",
                    delete: "Delete"
                },
                kanban: {
                    todo: "To Do",
                    doing: "Doing",
                    done: "Done"
                },
                today: {
                    add: "Add to Today",
                    remove: "Remove"
                },
                suggested: {
                    title: "Suggested Tasks",
                    hint: "Drag tasks to Kanban columns to add them to Today",
                    empty: "No suggested tasks available"
                },
                shortcuts: {
                    hint: "Press <strong>Ctrl+N</strong> to add task • <strong>Ctrl+R</strong> to refresh"
                },
                archive: {
                    title: "Archived Tasks",
                    empty: "No archived tasks",
                    empty_message: "Completed tasks will appear here",
                    unarchive: "Unarchive"
                },
                stats: {
                    total: "Total",
                    completed: "Completed",
                    pending: "Pending",
                    progress: "Progress"
                },
                folders: {
                    title: "Folders",
                    add: "Add Folder",
                    add_title: "Add New Folder",
                    name: "Folder Name",
                    color: "Color"
                },
                filters: {
                    status: "Status:",
                    category: "Category:",
                    folder: "Folder:",
                    search: "Search:",
                    search_placeholder: "Search tasks...",
                    all: "All",
                    pending: "Pending",
                    completed: "Completed"
                },
                categories: {
                    work: "Work",
                    personal: "Personal",
                    study: "Study",
                    health: "Health",
                    general: "General"
                },
                priority: {
                    low: "Low",
                    medium: "Medium",
                    high: "High"
                },
                form: {
                    title: "Title",
                    title_placeholder: "What do you need to do?",
                    description: "Description",
                    description_placeholder: "Optional description",
                    priority: "Priority",
                    category: "Category",
                    folder: "Folder",
                    add: "Add"
                },
                actions: {
                    complete: "Complete",
                    uncomplete: "Uncomplete",
                    delete: "Delete",
                    toggle: "Toggle"
                },
                common: {
                    cancel: "Cancel",
                    save: "Save",
                    loading: "Loading tasks...",
                    tasks: "tasks"
                },
                empty: {
                    title: "No tasks",
                    message: "Add your first task to get started!"
                },
                errors: {
                    no_folders: "You must create at least one folder before adding tasks",
                    no_folders_title: "No folders available",
                    no_folders_message: "Create your first folder to start adding tasks!"
                },
                confirmations: {
                    delete_folder: "Are you sure you want to delete this folder? All tasks inside this folder will also be deleted."
                },
                success: {
                    folder_deleted: "Folder and all its tasks deleted successfully"
                }
            },
            ar: {
                title: "المهندس",
                // subtitle: "إدارة مهامك بكفاءة وتنظيم",
                views: {
                    all_tasks: "جميع المهام",
                    today: "اليوم",
                    archive: "الأرشيف",
                    notes: "الملاحظات"
                },
                notes: {
                    title: "ملاحظاتي",
                    add: "إضافة ملاحظة",
                    placeholder: "اكتب ملاحظتك هنا...",
                    empty: "لا توجد ملاحظات",
                    empty_message: "أنشئ أول ملاحظة أعلاه",
                    copy: "نسخ",
                    copied: "تم النسخ!",
                    delete: "حذف"
                },
                kanban: {
                    todo: "للإنجاز",
                    doing: "قيد التنفيذ",
                    done: "مكتمل"
                },
                today: {
                    add: "إضافة لليوم",
                    remove: "إزالة"
                },
                suggested: {
                    title: "مهام مقترحة",
                    hint: "اسحب المهام إلى أعمدة كانبان لإضافتها إلى اليوم",
                    empty: "لا توجد مهام مقترحة"
                },
                archive: {
                    title: "المهام المؤرشفة",
                    empty: "لا توجد مهام مؤرشفة",
                    empty_message: "المهام المكتملة ستظهر هنا",
                    unarchive: "إلغاء الأرشفة"
                },
                stats: {
                    total: "الإجمالي",
                    completed: "مكتمل",
                    pending: "قيد الانتظار",
                    progress: "التقدم"
                },
                folders: {
                    title: "المجلدات",
                    add: "إضافة مجلد",
                    add_title: "إضافة مجلد جديد",
                    name: "اسم المجلد",
                    color: "اللون"
                },
                filters: {
                    status: "الحالة:",
                    category: "الفئة:",
                    folder: "المجلد:",
                    search: "بحث:",
                    search_placeholder: "البحث في المهام...",
                    all: "الكل",
                    pending: "قيد الانتظار",
                    completed: "مكتمل"
                },
                categories: {
                    work: "العمل",
                    personal: "شخصي",
                    study: "دراسة",
                    health: "صحة",
                    general: "عام"
                },
                priority: {
                    low: "منخفض",
                    medium: "متوسط",
                    high: "مرتفع"
                },
                form: {
                    title: "العنوان",
                    title_placeholder: "ماذا تريد إنجازه؟",
                    description: "الوصف",
                    description_placeholder: "وصف اختياري",
                    priority: "الأولوية",
                    category: "الفئة",
                    folder: "المجلد",
                    add: "إضافة"
                },
                actions: {
                    complete: "إكمال",
                    uncomplete: "إلغاء الإكمال",
                    delete: "حذف",
                    toggle: "تبديل"
                },
                common: {
                    cancel: "إلغاء",
                    save: "حفظ",
                    loading: "جاري تحميل المهام...",
                    tasks: "مهام"
                },
                empty: {
                    title: "لا توجد مهام",
                    message: "أضف مهمتك الأولى للبدء!"
                },
                errors: {
                    no_folders: "يجب إنشاء مجلد واحد على الأقل قبل إضافة المهام",
                    no_folders_title: "لا توجد مجلدات",
                    no_folders_message: "أنشئ أول مجلد لك لبدء إضافة المهام!"
                },
                confirmations: {
                    delete_folder: "هل أنت متأكد من حذف هذا المجلد؟ سيتم حذف جميع المهام داخل هذا المجلد أيضاً."
                },
                success: {
                    folder_deleted: "تم حذف المجلد وجميع مهامه بنجاح"
                }
            }
        };

        class TodoApp {
            constructor() {
                this.todos = [];
                this.folders = [];
                this.currentLanguage = 'ar';
                this.currentView = 'today';
                this.lastCreatedFolderId = null;
                this.filters = {
                    status: 'all',
                    category: 'all',
                    folder: 'all',
                    search: ''
                };
                this.quickAddMode = false;
                // Multi-select properties
                this.selectedTasks = new Set();
                this.isSelecting = false;
                this.selectionStart = { x: 0, y: 0 };
                this.init();
            }

            init() {
                this.setupLanguageSwitcher();
                this.setLanguage(this.currentLanguage);
                this.bindEvents();
                this.setupKeyboardShortcuts();
                this.setupAutoResizeTextarea();
                this.setupMultiSelect();
                this.checkTelegramStatus();
                this.loadFolders();
                this.loadStats();
                // Start with Today view
                this.switchView('today');
            }

            setupAutoResizeTextarea() {
                const titleTextarea = document.getElementById('todo-title');

                const autoResize = () => {
                    titleTextarea.style.height = 'auto';
                    titleTextarea.style.height = Math.min(titleTextarea.scrollHeight, 120) + 'px';
                };

                titleTextarea.addEventListener('input', autoResize);
            }

            async checkTelegramStatus() {
                try {
                    const response = await fetch('/api/telegram/status');
                    const status = await response.json();

                    const icon = document.getElementById('telegram-status-icon');
                    const text = document.getElementById('telegram-status-text');

                    if (status.enabled && status.configured && status.library_installed) {
                        icon.className = 'fas fa-robot telegram-enabled';
                        text.textContent = 'Telegram bot connected';
                    } else if (!status.enabled) {
                        icon.className = 'fas fa-robot telegram-disabled';
                        text.textContent = 'Telegram bot disabled (see telegram_config.json)';
                    } else if (!status.configured) {
                        icon.className = 'fas fa-robot telegram-pending';
                        text.textContent = 'Configure bot token in telegram_config.json';
                    } else if (!status.library_installed) {
                        icon.className = 'fas fa-robot telegram-pending';
                        text.textContent = 'Install: pip install pyTelegramBotAPI';
                    }
                } catch (error) {
                    console.log('Could not check Telegram status');
                }
            }

            async refreshCurrentView() {
                // Show loading notification
                this.showNotification('Refreshing...', 'info');

                // Import Telegram tasks first
                try {
                    const response = await fetch('/api/telegram/import', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    if (result.imported > 0) {
                        this.showNotification(`Imported ${result.imported} tasks from Telegram!`, 'success');
                    }
                } catch (error) {
                    console.log('Could not import Telegram tasks');
                }

                // Reload current view
                if (this.currentView === 'today') {
                    await this.loadTodayTodos();
                } else if (this.currentView === 'archive') {
                    await this.loadArchivedTodos();
                } else {
                    await this.loadTodos();
                }

                // Reload stats and folders
                await this.loadStats();
                await this.loadFolders();

                this.showNotification('Refreshed!', 'success');
            }

            setupKeyboardShortcuts() {
                // Ctrl+N to quick add task (works with any keyboard layout)
                // Ctrl+R to refresh and import Telegram tasks
                document.addEventListener('keydown', (e) => {
                    // Use e.code for physical key detection (works with Arabic, etc.)
                    if (e.ctrlKey && e.code === 'KeyN') {
                        e.preventDefault();
                        this.openQuickAdd();
                    }
                    // Ctrl+R to refresh (works with any keyboard layout)
                    if (e.ctrlKey && e.code === 'KeyR') {
                        e.preventDefault();
                        this.refreshCurrentView();
                    }
                    // Escape to exit quick add mode or clear selection
                    if (e.key === 'Escape') {
                        if (this.quickAddMode) {
                            this.closeQuickAdd();
                        }
                        if (this.selectedTasks.size > 0) {
                            this.clearSelection();
                        }
                    }
                });
            }

            // ============ MULTI-SELECT FUNCTIONS ============

            setupMultiSelect() {
                const selectionOverlay = document.getElementById('selection-overlay');
                const selectionBox = document.getElementById('selection-box');
                const bulkMoveBtn = document.getElementById('bulk-move-btn');
                const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
                const bulkClearBtn = document.getElementById('bulk-clear-btn');
                const bulkMoveDropdown = document.getElementById('bulk-move-dropdown');

                let isDragging = false;
                let dragStart = { x: 0, y: 0 };

                // Mouse down on overlay - start box selection
                selectionOverlay.addEventListener('mousedown', (e) => {
                    if (e.button === 0) { // Left click only
                        isDragging = true;
                        dragStart = { x: e.clientX, y: e.clientY };
                        selectionBox.style.left = e.clientX + 'px';
                        selectionBox.style.top = e.clientY + 'px';
                        selectionBox.style.width = '0px';
                        selectionBox.style.height = '0px';
                        selectionBox.classList.add('active');
                    }
                });

                // Mouse move - update selection box
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const currentX = e.clientX;
                    const currentY = e.clientY;

                    const left = Math.min(dragStart.x, currentX);
                    const top = Math.min(dragStart.y, currentY);
                    const width = Math.abs(currentX - dragStart.x);
                    const height = Math.abs(currentY - dragStart.y);

                    selectionBox.style.left = left + 'px';
                    selectionBox.style.top = top + 'px';
                    selectionBox.style.width = width + 'px';
                    selectionBox.style.height = height + 'px';

                    // Check which tasks are under the selection box
                    this.checkTaskSelection(left, top, width, height);
                });

                // Mouse up - end box selection
                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        selectionBox.classList.remove('active');
                        selectionBox.style.width = '0px';
                        selectionBox.style.height = '0px';
                    }
                });

                // Bulk move button
                bulkMoveBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.showBulkMoveDropdown();
                });

                // Bulk delete button
                bulkDeleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.bulkDeleteSelected();
                });

                // Clear selection button
                bulkClearBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.clearSelection();
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.bulk-action-toolbar')) {
                        bulkMoveDropdown.classList.remove('visible');
                    }
                });

                // Enable selection mode when Ctrl key is held on task containers
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        selectionOverlay.classList.add('active');
                    }
                });

                document.addEventListener('keyup', (e) => {
                    if (!e.ctrlKey && !e.metaKey) {
                        selectionOverlay.classList.remove('active');
                    }
                });
            }

            checkTaskSelection(left, top, width, height) {
                const selectableItems = document.querySelectorAll('.todo-item, .kanban-card, .suggested-task-card');

                selectableItems.forEach(item => {
                    const rect = item.getBoundingClientRect();
                    const itemCenterX = rect.left + rect.width / 2;
                    const itemCenterY = rect.top + rect.height / 2;

                    const isInside = (
                        itemCenterX >= left &&
                        itemCenterX <= left + width &&
                        itemCenterY >= top &&
                        itemCenterY <= top + height
                    );

                    const todoId = item.dataset.todoId;
                    if (todoId) {
                        if (isInside && !this.selectedTasks.has(todoId)) {
                            this.selectTask(todoId, item);
                        } else if (!isInside && this.selectedTasks.has(todoId) && !item.classList.contains('manually-selected')) {
                            this.deselectTask(todoId, item);
                        }
                    }
                });
            }

            toggleTaskSelection(todoId) {
                const item = document.querySelector(`[data-todo-id="${todoId}"]`);
                if (!item) return;

                if (this.selectedTasks.has(todoId)) {
                    this.deselectTask(todoId, item);
                } else {
                    this.selectTask(todoId, item, true);
                }
            }

            selectTask(todoId, item = null, isManual = false) {
                this.selectedTasks.add(todoId);
                if (!item) {
                    item = document.querySelector(`[data-todo-id="${todoId}"]`);
                }
                if (item) {
                    item.classList.add('selected');
                    if (isManual) {
                        item.classList.add('manually-selected');
                    }
                }
                this.updateBulkToolbar();
            }

            deselectTask(todoId, item = null) {
                this.selectedTasks.delete(todoId);
                if (!item) {
                    item = document.querySelector(`[data-todo-id="${todoId}"]`);
                }
                if (item) {
                    item.classList.remove('selected', 'manually-selected');
                    // Uncheck the checkbox
                    const checkbox = item.querySelector('.todo-checkbox');
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                }
                this.updateBulkToolbar();
            }

            clearSelection() {
                this.selectedTasks.forEach(todoId => {
                    const item = document.querySelector(`[data-todo-id="${todoId}"]`);
                    if (item) {
                        item.classList.remove('selected', 'manually-selected');
                        const checkbox = item.querySelector('.todo-checkbox');
                        if (checkbox) {
                            checkbox.checked = false;
                        }
                    }
                });
                this.selectedTasks.clear();
                this.updateBulkToolbar();
            }

            updateBulkToolbar() {
                const toolbar = document.getElementById('bulk-action-toolbar');
                const count = document.getElementById('selected-count');
                const text = document.getElementById('selected-text');

                count.textContent = this.selectedTasks.size;

                if (this.selectedTasks.size > 0) {
                    toolbar.classList.add('visible');
                    text.textContent = this.selectedTasks.size === 1 ? 'task selected' : 'tasks selected';
                } else {
                    toolbar.classList.remove('visible');
                }
            }

            showBulkMoveDropdown() {
                const dropdown = document.getElementById('bulk-move-dropdown');
                dropdown.innerHTML = '';

                if (this.folders.length === 0) {
                    dropdown.innerHTML = '<div style="padding: 12px; color: var(--text-secondary);">No folders available</div>';
                } else {
                    this.folders.forEach(folder => {
                        const option = document.createElement('div');
                        option.className = 'folder-option';
                        option.innerHTML = `
                            <span class="folder-color-dot" style="background: ${folder.color}"></span>
                            <span>${this.escapeHtml(folder.name)}</span>
                        `;
                        option.addEventListener('click', () => {
                            this.bulkMoveSelected(folder.id);
                        });
                        dropdown.appendChild(option);
                    });
                }

                dropdown.classList.add('visible');
            }

            async bulkDeleteSelected() {
                if (this.selectedTasks.size === 0) return;

                const count = this.selectedTasks.size;
                const confirmMsg = count === 1
                    ? 'Are you sure you want to delete this task?'
                    : `Are you sure you want to delete ${count} tasks?`;

                if (!confirm(confirmMsg)) return;

                try {
                    // Use batch delete endpoint
                    const response = await fetch('/api/todos/batch', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: Array.from(this.selectedTasks) })
                    });

                    if (response.ok) {
                        this.clearSelection();
                        this.showNotification(`${count} task(s) deleted successfully`, 'success');

                        // Reload current view
                        if (this.currentView === 'today') {
                            this.loadTodayTodos();
                        } else if (this.currentView === 'archive') {
                            this.loadArchivedTodos();
                        } else {
                            this.loadTodos();
                        }

                        this.loadStats();
                        this.loadFolders();
                    } else {
                        throw new Error('Error deleting tasks');
                    }
                } catch (error) {
                    this.showNotification('Error deleting tasks', 'error');
                }
            }

            async bulkMoveSelected(folderId) {
                if (this.selectedTasks.size === 0) return;

                try {
                    // Use batch move endpoint
                    const response = await fetch('/api/todos/batch/move', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ids: Array.from(this.selectedTasks),
                            folder_id: parseInt(folderId)
                        })
                    });

                    if (response.ok) {
                        this.clearSelection();
                        document.getElementById('bulk-move-dropdown').classList.remove('visible');
                        this.showNotification(`${this.selectedTasks.size} task(s) moved successfully`, 'success');

                        // Reload current view
                        if (this.currentView === 'today') {
                            this.loadTodayTodos();
                        } else if (this.currentView === 'archive') {
                            this.loadArchivedTodos();
                        } else {
                            this.loadTodos();
                        }

                        this.loadFolders();
                        this.loadStats();
                    } else {
                        throw new Error('Error moving tasks');
                    }
                } catch (error) {
                    this.showNotification('Error moving tasks', 'error');
                }
            }

            // ============ END MULTI-SELECT FUNCTIONS ============

            openQuickAdd() {
                this.quickAddMode = true;
                const previousView = this.currentView;

                // Show the add form
                const todosContainer = document.getElementById('todos-container');
                const kanbanContainer = document.getElementById('kanban-container');
                const archiveContainer = document.getElementById('archive-container');
                const controlsSection = document.querySelector('.controls');
                const foldersSection = document.querySelector('.folders-section');

                // Hide other views
                kanbanContainer.style.display = 'none';
                archiveContainer.style.display = 'none';

                // Show All Tasks view with controls
                todosContainer.style.display = 'block';
                controlsSection.style.display = 'block';
                foldersSection.style.display = 'block';

                // Clear the form and focus on title
                document.getElementById('add-todo-form').reset();
                document.getElementById('todo-priority').value = 'medium';
                document.getElementById('todo-category').value = 'general';

                const titleInput = document.getElementById('todo-title');
                titleInput.focus();

                // Add enter key listener to submit
                const submitHandler = (e) => {
                    if (e.key === 'Enter' && titleInput.value.trim()) {
                        e.preventDefault();
                        this.addTodo();
                        this.closeQuickAdd();
                        // Return to previous view
                        this.switchView(previousView);
                    }
                };

                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.closeQuickAdd();
                        this.switchView(previousView);
                    }
                };

                titleInput.addEventListener('keydown', submitHandler);
                titleInput.addEventListener('keydown', escapeHandler);

                // Store handlers to remove them later
                this.quickAddHandlers = { submitHandler, escapeHandler, titleInput };
            }

            closeQuickAdd() {
                this.quickAddMode = false;
                if (this.quickAddHandlers) {
                    const { submitHandler, escapeHandler, titleInput } = this.quickAddHandlers;
                    titleInput.removeEventListener('keydown', submitHandler);
                    titleInput.removeEventListener('keydown', escapeHandler);
                    this.quickAddHandlers = null;
                }
            }

            switchView(view) {
                this.currentView = view;

                // Update tab styling
                document.querySelectorAll('.view-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.view === view);
                });

                // Get containers
                const todosContainer = document.getElementById('todos-container');
                const kanbanContainer = document.getElementById('kanban-container');
                const archiveContainer = document.getElementById('archive-container');
                const notesContainer = document.getElementById('notes-container');
                const controlsSection = document.querySelector('.controls');
                const foldersSection = document.querySelector('.folders-section');

                if (view === 'today') {
                    // Show Kanban board
                    todosContainer.style.display = 'none';
                    kanbanContainer.style.display = 'grid';
                    archiveContainer.style.display = 'none';
                    notesContainer.style.display = 'none';
                    controlsSection.style.display = 'none';
                    foldersSection.style.display = 'none';
                    this.loadTodayTodos();
                } else if (view === 'archive') {
                    // Show archive
                    todosContainer.style.display = 'none';
                    kanbanContainer.style.display = 'none';
                    archiveContainer.style.display = 'block';
                    notesContainer.style.display = 'none';
                    controlsSection.style.display = 'none';
                    foldersSection.style.display = 'none';
                    this.loadArchivedTodos();
                } else if (view === 'notes') {
                    // Show notes
                    todosContainer.style.display = 'none';
                    kanbanContainer.style.display = 'none';
                    archiveContainer.style.display = 'none';
                    notesContainer.style.display = 'block';
                    controlsSection.style.display = 'none';
                    foldersSection.style.display = 'none';
                    this.loadNotes();
                } else {
                    // Show all tasks
                    todosContainer.style.display = 'block';
                    kanbanContainer.style.display = 'none';
                    archiveContainer.style.display = 'none';
                    notesContainer.style.display = 'none';
                    controlsSection.style.display = 'block';
                    foldersSection.style.display = 'block';
                    this.loadTodos();
                    // Auto-focus on title input for quick task entry
                    setTimeout(() => {
                        const titleInput = document.getElementById('todo-title');
                        if (titleInput) {
                            titleInput.focus();
                        }
                    }, 100);
                }
            }

            async loadTodayTodos() {
                try {
                    // Load Today tasks for Kanban
                    const response = await fetch('/api/todos/today');
                    const todos = await response.json();
                    this.renderKanban(todos);
                    this.updateTodayBadge(todos.length);

                    // Load suggested tasks (tasks NOT in Today)
                    const suggestedResponse = await fetch('/api/todos?include_archived=false');
                    let allTasks = await suggestedResponse.json();
                    // Filter out tasks that are already in Today
                    const suggestedTasks = allTasks.filter(t => !t.added_to_today && !t.completed && !t.archived);
                    this.renderSuggestedTasks(suggestedTasks);
                } catch (error) {
                    this.showNotification('Error loading Today tasks', 'error');
                }
            }

            updateTodayBadge(count) {
                const badge = document.getElementById('today-badge');
                if (badge) {
                    badge.textContent = count;
                    // Hide badge if count is 0
                    if (count === 0) {
                        badge.style.display = 'none';
                    } else {
                        badge.style.display = 'inline-block';
                    }
                }
            }

            renderSuggestedTasks(tasks) {
                const container = document.getElementById('suggested-tasks-container');

                if (tasks.length === 0) {
                    container.innerHTML = `<div class="suggested-empty" data-i18n="suggested.empty">No suggested tasks available</div>`;
                    this.updateDynamicTranslations();
                    return;
                }

                container.innerHTML = tasks.map(todo => this.createSuggestedTaskCard(todo)).join('');
                this.setupSuggestedTasksDragDrop();
            }

            createSuggestedTaskCard(todo) {
                const priorityClass = `priority-${todo.priority}`;
                const priorityText = {
                    'high': translations[this.currentLanguage].priority.high,
                    'medium': translations[this.currentLanguage].priority.medium,
                    'low': translations[this.currentLanguage].priority.low
                }[todo.priority];

                const isSelected = this.selectedTasks.has(String(todo.id));

                return `
                    <div class="suggested-task-card ${isSelected ? 'selected' : ''}" draggable="true" data-todo-id="${todo.id}">
                        <div class="todo-checkbox-wrapper ${isSelected ? 'checked' : ''}" onclick="event.stopPropagation(); todoApp.toggleTaskSelection(${todo.id})"></div>
                        <input type="checkbox" class="todo-checkbox" ${isSelected ? 'checked' : ''} onchange="event.stopPropagation(); todoApp.toggleTaskSelection(${todo.id})">
                        <div class="suggested-task-title">${this.escapeHtml(todo.title)}</div>
                        ${todo.description ? `<div class="suggested-task-description">${this.escapeHtml(todo.description)}</div>` : ''}
                        <div class="suggested-task-meta">
                            <span class="suggested-task-badge ${priorityClass}">${priorityText}</span>
                            <span class="suggested-task-badge" style="background: ${todo.folder_color}; color: white;">${todo.folder_name}</span>
                        </div>
                    </div>
                `;
            }

            setupSuggestedTasksDragDrop() {
                const cards = document.querySelectorAll('.suggested-task-card');

                cards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        card.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', card.dataset.todoId);
                        e.dataTransfer.setData('suggested-task', 'true');
                    });

                    card.addEventListener('dragend', () => {
                        card.classList.remove('dragging');
                    });
                });
            }

            async loadArchivedTodos() {
                try {
                    const response = await fetch('/api/todos/archived');
                    const todos = await response.json();
                    this.renderArchived(todos);
                } catch (error) {
                    this.showNotification('Error loading archived tasks', 'error');
                }
            }

            renderKanban(todos) {
                const columns = {
                    todo: document.getElementById('kanban-todo'),
                    doing: document.getElementById('kanban-doing'),
                    done: document.getElementById('kanban-done')
                };

                // Clear columns
                Object.values(columns).forEach(col => col.innerHTML = '');

                // Group todos by kanban_status
                const todosByStatus = {
                    todo: todos.filter(t => t.kanban_status === 'todo'),
                    doing: todos.filter(t => t.kanban_status === 'doing'),
                    done: todos.filter(t => t.kanban_status === 'done')
                };

                // Render cards
                Object.keys(todosByStatus).forEach(status => {
                    const statusTodos = todosByStatus[status];
                    statusTodos.forEach(todo => {
                        const card = this.createKanbanCard(todo);
                        columns[status].appendChild(card);
                    });
                    // Update counts
                    document.getElementById(`kanban-${status}-count`).textContent = statusTodos.length;
                });

                // Setup drag and drop
                this.setupKanbanDragDrop();
            }

            createKanbanCard(todo) {
                const card = document.createElement('div');
                card.className = 'kanban-card';
                card.draggable = true;
                card.dataset.todoId = todo.id;

                const isSelected = this.selectedTasks.has(String(todo.id));

                if (isSelected) {
                    card.classList.add('selected');
                }

                const priorityClass = `priority-${todo.priority}`;
                const priorityText = {
                    'high': translations[this.currentLanguage].priority.high,
                    'medium': translations[this.currentLanguage].priority.medium,
                    'low': translations[this.currentLanguage].priority.low
                }[todo.priority];

                card.innerHTML = `
                    <div class="todo-checkbox-wrapper ${isSelected ? 'checked' : ''}" onclick="event.stopPropagation(); todoApp.toggleTaskSelection(${todo.id})"></div>
                    <input type="checkbox" class="todo-checkbox" ${isSelected ? 'checked' : ''} onchange="event.stopPropagation(); todoApp.toggleTaskSelection(${todo.id})">
                    <div class="kanban-card-title">${this.escapeHtml(todo.title)}</div>
                    ${todo.description ? `<div class="kanban-card-description">${this.escapeHtml(todo.description)}</div>` : ''}
                    <div class="kanban-card-meta">
                        <span class="kanban-card-badge ${priorityClass}">${priorityText}</span>
                        <span class="kanban-card-badge" style="background: ${todo.folder_color}; color: white;">${todo.folder_name}</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); todoApp.removeFromToday(${todo.id})" style="font-size: 0.8rem; padding: 4px 10px;">
                            <i class="fas fa-calendar-minus"></i> ${translations[this.currentLanguage].today.remove}
                        </button>
                    </div>
                `;

                return card;
            }

            setupKanbanDragDrop() {
                const cards = document.querySelectorAll('.kanban-card');
                const columnsInner = document.querySelectorAll('.kanban-cards');
                const columns = document.querySelectorAll('.kanban-column');

                cards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        card.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', card.dataset.todoId);
                    });

                    card.addEventListener('dragend', () => {
                        card.classList.remove('dragging');
                        document.querySelectorAll('.kanban-column').forEach(col => {
                            col.classList.remove('drag-over');
                        });
                    });
                });

                // Add drop listeners to both the cards area and the entire column
                columns.forEach(column => {
                    column.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        column.classList.add('drag-over');
                    });

                    column.addEventListener('dragleave', (e) => {
                        // Only remove drag-over if leaving the column entirely
                        if (!column.contains(e.relatedTarget)) {
                            column.classList.remove('drag-over');
                        }
                    });

                    column.addEventListener('drop', (e) => {
                        e.preventDefault();
                        column.classList.remove('drag-over');

                        const todoId = e.dataTransfer.getData('text/plain');
                        const isSuggestedTask = e.dataTransfer.getData('suggested-task') === 'true';
                        const newStatus = column.dataset.status;

                        if (isSuggestedTask) {
                            this.addSuggestedTaskToToday(todoId, newStatus);
                        } else {
                            this.updateKanbanStatus(todoId, newStatus);
                        }
                    });
                });

                // Also keep listeners on the cards area for better coverage
                columnsInner.forEach(columnInner => {
                    columnInner.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        columnInner.closest('.kanban-column').classList.add('drag-over');
                    });

                    columnInner.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation(); // Prevent bubbling to column
                        columnInner.closest('.kanban-column').classList.remove('drag-over');

                        const todoId = e.dataTransfer.getData('text/plain');
                        const isSuggestedTask = e.dataTransfer.getData('suggested-task') === 'true';
                        const newStatus = columnInner.closest('.kanban-column').dataset.status;

                        if (isSuggestedTask) {
                            this.addSuggestedTaskToToday(todoId, newStatus);
                        } else {
                            this.updateKanbanStatus(todoId, newStatus);
                        }
                    });
                });
            }

            async addSuggestedTaskToToday(todoId, status) {
                try {
                    // First add to Today
                    await fetch(`/api/todos/${todoId}/add-to-today`, {
                        method: 'PUT'
                    });

                    // Then set Kanban status
                    const response = await fetch(`/api/todos/${todoId}/kanban-status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });

                    if (response.ok) {
                        this.loadTodayTodos();
                        this.loadStats();
                        this.showNotification('Task added to Today', 'success');
                    }
                } catch (error) {
                    this.showNotification('Error adding task', 'error');
                }
            }

            async updateKanbanStatus(todoId, status) {
                try {
                    const response = await fetch(`/api/todos/${todoId}/kanban-status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });

                    if (response.ok) {
                        this.loadTodayTodos();
                        this.loadStats();
                        this.showNotification('Task status updated', 'success');
                    }
                } catch (error) {
                    this.showNotification('Error updating status', 'error');
                }
            }

            renderArchived(todos) {
                const container = document.getElementById('archive-container');

                if (todos.length === 0) {
                    container.innerHTML = `
                        <div class="archive-empty">
                            <i class="fas fa-archive"></i>
                            <h3 data-i18n="archive.empty">No archived tasks</h3>
                            <p data-i18n="archive.empty_message">Completed tasks will appear here</p>
                        </div>
                    `;
                    this.updateDynamicTranslations();
                    return;
                }

                let html = '<div class="archive-header"><h2><i class="fas fa-archive"></i> <span data-i18n="archive.title">Archived Tasks</span></h2></div>';

                todos.forEach(todo => {
                    html += `
                        <div class="archive-item">
                            <div class="archive-item-header">
                                <div class="archive-item-title">${this.escapeHtml(todo.title)}</div>
                                <div class="archive-item-actions">
                                    <button class="btn btn-sm btn-success" onclick="todoApp.unarchiveTodo(${todo.id})">
                                        <i class="fas fa-undo"></i> <span data-i18n="archive.unarchive">Unarchive</span>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="todoApp.deleteTodo(${todo.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            ${todo.description ? `<div style="color: var(--text-secondary); margin: 8px 0;">${this.escapeHtml(todo.description)}</div>` : ''}
                            <div class="archive-item-meta">
                                <span><i class="fas fa-folder"></i> ${todo.folder_name}</span>
                                <span><i class="fas fa-clock"></i> ${this.formatDate(todo.updated_at)}</span>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                this.updateDynamicTranslations();
            }

            async unarchiveTodo(todoId) {
                try {
                    const response = await fetch(`/api/todos/${todoId}/unarchive`, {
                        method: 'PUT'
                    });

                    if (response.ok) {
                        this.loadArchivedTodos();
                        this.showNotification('Task unarchived successfully', 'success');
                    }
                } catch (error) {
                    this.showNotification('Error unarchiving task', 'error');
                }
            }

            async toggleAddToToday(todoId) {
                const todo = this.todos.find(t => t.id === todoId);
                const isAdding = !todo.added_to_today;

                try {
                    const endpoint = isAdding
                        ? `/api/todos/${todoId}/add-to-today`
                        : `/api/todos/${todoId}/remove-from-today`;

                    const response = await fetch(endpoint, { method: 'PUT' });

                    if (response.ok) {
                        this.loadTodos();
                        this.loadStats();
                        this.showNotification(
                            isAdding ? 'Added to Today' : 'Removed from Today',
                            'success'
                        );
                    }
                } catch (error) {
                    this.showNotification('Error updating task', 'error');
                }
            }

            async removeFromToday(todoId) {
                try {
                    const response = await fetch(`/api/todos/${todoId}/remove-from-today`, {
                        method: 'PUT'
                    });

                    if (response.ok) {
                        this.loadTodayTodos();
                        this.loadStats();
                        this.showNotification('Removed from Today', 'success');
                    }
                } catch (error) {
                    this.showNotification('Error removing task', 'error');
                }
            }

            setupLanguageSwitcher() {
                const langButtons = document.querySelectorAll('.language-btn');
                langButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const lang = btn.dataset.lang;
                        this.setLanguage(lang);
                        
                        // Update active button
                        langButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                });
            }

            setLanguage(lang) {
                this.currentLanguage = lang;
                document.documentElement.lang = lang;
                document.body.setAttribute('data-lang', lang);
                
                // Update all translatable elements
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.dataset.i18n;
                    const keys = key.split('.');
                    let value = translations[lang];
                    keys.forEach(k => {
                        value = value[k];
                    });
                    if (value) {
                        element.textContent = value;
                    }
                });

                // Update placeholders
                document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                    const key = element.dataset.i18nPlaceholder;
                    const keys = key.split('.');
                    let value = translations[lang];
                    keys.forEach(k => {
                        value = value[k];
                    });
                    if (value) {
                        element.placeholder = value;
                    }
                });

                // Update dynamic content that was created after page load
                this.updateDynamicTranslations();
            }

            updateDynamicTranslations() {
                // Update "Add Folder" button in folders grid
                const addFolderBtn = document.querySelector('.add-folder-btn div');
                if (addFolderBtn) {
                    addFolderBtn.textContent = translations[this.currentLanguage].folders.add;
                }

                // Update folder count text
                document.querySelectorAll('.folder-count').forEach(element => {
                    const count = element.textContent.split(' ')[0];
                    element.textContent = `${count} ${translations[this.currentLanguage].common.tasks}`;
                });

                // Update empty state messages
                const emptyState = document.querySelector('.empty-state');
                if (emptyState && this.todos.length === 0 && this.folders.length > 0) {
                    const title = emptyState.querySelector('h3');
                    const message = emptyState.querySelector('p');
                    if (title) title.textContent = translations[this.currentLanguage].empty.title;
                    if (message) message.textContent = translations[this.currentLanguage].empty.message;
                }

                // Update no folders message
                const noFoldersState = document.querySelector('.empty-state');
                if (noFoldersState && this.folders.length === 0) {
                    const title = noFoldersState.querySelector('h3');
                    const message = noFoldersState.querySelector('p');
                    if (title) title.textContent = translations[this.currentLanguage].errors.no_folders_title;
                    if (message) message.textContent = translations[this.currentLanguage].errors.no_folders_message;
                }
            }

            bindEvents() {
                // Form submission (handles both button click and Enter key)
                document.getElementById('add-todo-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTodo();
                });

                // Add folder form
                document.getElementById('add-folder-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addFolder();
                });

                // Filters (EN TIEMPO REAL)
                document.getElementById('status-filter').addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.loadTodos();
                });

                document.getElementById('category-filter').addEventListener('change', (e) => {
                    this.filters.category = e.target.value;
                    this.loadTodos();
                });

                document.getElementById('folder-filter').addEventListener('change', (e) => {
                    this.filters.folder = e.target.value;
                    this.loadTodos();
                });

                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.filters.search = e.target.value;
                    this.loadTodos();
                });

                // Global menu for moving a task between folders
                document.getElementById('todos-container').addEventListener('click', (e) => {
                    if (e.target.classList.contains('move-folder-btn')) {
                        const todoId = e.target.getAttribute('data-todo-id');
                        const btn = e.target;
                        // Remove any open menus
                        document.querySelectorAll('.move-folder-global-dropdown').forEach(d => d.remove());
                        // Build the menu
                        const todo = this.todos.find(t => t.id == todoId);
                        const folders = this.folders.filter(f => f.id !== todo.folder_id);
                        const menu = document.createElement('div');
                        menu.className = 'move-folder-global-dropdown';
                        menu.setAttribute('data-todo-id', todoId); // Store the todoId in the menu
                        if (folders.length === 0) {
                            menu.innerHTML = `<div style='padding:8px 18px; color:#aaa;'>${translations[this.currentLanguage].folders.title}</div>`;
                        } else {
                            menu.innerHTML = folders.map(folder =>
                                `<div class='move-folder-option' data-folder-id='${folder.id}'>${this.escapeHtml(folder.name)}</div>`
                            ).join('');
                        }
                        document.body.appendChild(menu);
                        // Position the menu
                        const rect = btn.getBoundingClientRect();
                        let top = rect.bottom + window.scrollY;
                        let left = rect.left + window.scrollX;
                        // If menu overflows bottom, show above
                        if (top + menu.offsetHeight > window.innerHeight + window.scrollY) {
                            top = rect.top + window.scrollY - menu.offsetHeight;
                        }
                        // If menu overflows right, adjust
                        if (left + menu.offsetWidth > window.innerWidth + window.scrollX) {
                            left = window.innerWidth + window.scrollX - menu.offsetWidth - 10;
                        }
                        menu.style.top = top + 'px';
                        menu.style.left = left + 'px';
                    }
                });
                // Listen globally for clicks on move-folder-option
                document.body.addEventListener('click', (e) => {
                    if (e.target.classList.contains('move-folder-option')) {
                        // Read the todoId directly from the parent menu
                        const menu = e.target.closest('.move-folder-global-dropdown');
                        const todoId = menu ? menu.getAttribute('data-todo-id') : null;
                        const newFolderId = e.target.getAttribute('data-folder-id');
                        if (todoId && newFolderId) {
                            this.moveTodoToFolder(todoId, newFolderId);
                        }
                        document.querySelectorAll('.move-folder-global-dropdown').forEach(d => d.remove());
                        e.stopPropagation();
                    }
                });
                // Removed previousMenuBtnId mousedown event, no longer needed
                // Cerrar menú al hacer click fuera
                document.body.addEventListener('mousedown', (e) => {
                    if (!e.target.classList.contains('move-folder-global-dropdown') && !e.target.classList.contains('move-folder-option') && !e.target.classList.contains('move-folder-btn')) {
                        document.querySelectorAll('.move-folder-global-dropdown').forEach(d => d.remove());
                    }
                });
            }

            async loadFolders() {
                try {
                    const response = await fetch('/api/folders');
                    this.folders = await response.json();
                    this.renderFolders();
                    this.updateFolderSelects();
                    this.updateDynamicTranslations();
                } catch (error) {
                    this.showNotification('Error loading folders', 'error');
                }
            }

            renderFolders() {
                const grid = document.getElementById('folders-grid');
                grid.innerHTML = '';

                this.folders.forEach(folder => {
                    const folderCard = document.createElement('div');
                    folderCard.className = 'folder-card';
                    folderCard.style.borderLeftColor = folder.color;
                    folderCard.style.borderLeftWidth = '4px';
                    folderCard.onclick = () => this.selectFolder(folder.id);

                    // Truncar el nombre del folder una letra antes (máx 13) y tooltip
                    let folderNameDisplay = folder.name;
                    if (folderNameDisplay.length > 13) {
                        folderNameDisplay = folderNameDisplay.slice(0, 12) + '...';
                    }

                    // Calcular progreso visual
                    const total = folder.todo_count;
                    const completed = folder.completed_count || 0;
                    const pending = total - completed;
                    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

                    folderCard.innerHTML = `
                        <div class="folder-icon" style="color: ${folder.color}">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="folder-name" title="${this.escapeHtml(folder.name)}">${this.escapeHtml(folderNameDisplay)}</div>
                        <div class="folder-progress-bar" style="background: var(--border-color); border-radius: var(--radius-sm); height: 6px; margin: 8px 0 6px 0; width: 100%; overflow: hidden;">
                            <div style="width: ${percent}%; height: 100%; background: var(--accent-color); border-radius: var(--radius-sm);"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85em;">
                            <span title="${percent}% completed"><i class='fas fa-check-circle' style='color:var(--success-color);'></i> ${percent}%</span>
                            <span title="${pending} pending"><i class='fas fa-tasks' style='color:var(--danger-color);'></i> ${pending}</span>
                        </div>
                        <div class="folder-count">${folder.todo_count} ${translations[this.currentLanguage].common.tasks}</div>
                        <div class="folder-actions">
                            <button onclick="event.stopPropagation(); todoApp.deleteFolder(${folder.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

                    grid.appendChild(folderCard);
                });

                // Add "Add Folder" card
                const addCard = document.createElement('div');
                addCard.className = 'add-folder-btn';
                addCard.onclick = () => this.showAddFolderModal();
                addCard.innerHTML = `
                    <i class="fas fa-plus" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <div>${translations[this.currentLanguage].folders.add}</div>
                `;
                grid.appendChild(addCard);
            }

            updateFolderSelects() {
                const todoFolderSelect = document.getElementById('todo-folder');
                const filterFolderSelect = document.getElementById('folder-filter');
                const addTodoForm = document.getElementById('add-todo-form');

                // Clear existing options except "All" for filter
                todoFolderSelect.innerHTML = '';
                filterFolderSelect.innerHTML = '<option value="all">All</option>';

                if (this.folders.length === 0) {
                    // No folders available
                    todoFolderSelect.innerHTML = '<option value="" disabled>No folders available</option>';
                    filterFolderSelect.innerHTML = '<option value="all">All</option>';
                    
                    // Disable the form
                    addTodoForm.style.opacity = '0.5';
                    addTodoForm.style.pointerEvents = 'none';
                    
                    // Show message in todos container
                    const container = document.getElementById('todos-container');
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h3>${translations[this.currentLanguage].errors.no_folders_title}</h3>
                            <p>${translations[this.currentLanguage].errors.no_folders_message}</p>
                        </div>
                    `;
                } else {
                    // Enable the form
                    addTodoForm.style.opacity = '1';
                    addTodoForm.style.pointerEvents = 'auto';

                    this.folders.forEach(folder => {
                        const todoOption = document.createElement('option');
                        todoOption.value = folder.id;
                        todoOption.textContent = folder.name;
                        todoFolderSelect.appendChild(todoOption);

                        const filterOption = document.createElement('option');
                        filterOption.value = folder.id;
                        filterOption.textContent = folder.name;
                        filterFolderSelect.appendChild(filterOption);
                    });
                }
            }

            selectFolder(folderId) {
                // Update folder filter
                document.getElementById('folder-filter').value = folderId;
                this.filters.folder = folderId;

                // Also update the folder select in the add-todo form
                document.getElementById('todo-folder').value = folderId;

                this.loadTodos();

                // Update visual selection
                document.querySelectorAll('.folder-card').forEach(card => {
                    card.classList.remove('active');
                });
                event.currentTarget.classList.add('active');
            }

            showAddFolderModal() {
                document.getElementById('add-folder-modal').style.display = 'block';
            }

            closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            async addFolder() {
                const name = document.getElementById('folder-name').value.trim();
                const color = document.getElementById('folder-color').value;

                if (!name) return;

                try {
                    const response = await fetch('/api/folders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            color
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.lastCreatedFolderId = data.id; // Store the new folder ID

                        document.getElementById('folder-name').value = '';
                        document.getElementById('folder-color').value = '#667eea';
                        this.closeModal('add-folder-modal');
                        await this.loadFolders();

                        // Auto-select the newly created folder
                        document.getElementById('todo-folder').value = this.lastCreatedFolderId;

                        this.showNotification('Folder created successfully', 'success');
                    } else {
                        throw new Error('Error creating folder');
                    }
                } catch (error) {
                    this.showNotification('Error creating folder', 'error');
                }
            }

            async deleteFolder(folderId) {
                if (!confirm(translations[this.currentLanguage].confirmations.delete_folder)) return;

                try {
                    const response = await fetch(`/api/folders/${folderId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        this.loadFolders();
                        this.loadTodos();
                        this.loadStats();
                        this.showNotification(translations[this.currentLanguage].success.folder_deleted, 'success');
                    } else {
                        throw new Error('Error deleting folder');
                    }
                } catch (error) {
                    this.showNotification('Error deleting folder', 'error');
                }
            }

            async loadTodos() {
                try {
                    const params = new URLSearchParams();
                    if (this.filters.status !== 'all') params.append('status', this.filters.status);
                    if (this.filters.category !== 'all') params.append('category', this.filters.category);
                    if (this.filters.folder !== 'all') params.append('folder', this.filters.folder);
                    if (this.filters.search) params.append('search', this.filters.search);

                    const response = await fetch(`/api/todos?${params}`);
                    let todos = await response.json();

                    // Filter out tasks that are in "Today" - they should only show in Today view
                    todos = todos.filter(t => !t.added_to_today);

                    this.todos = todos;
                    this.renderTodos();
                } catch (error) {
                    this.showNotification('Error loading tasks', 'error');
                }
            }

            async loadStats() {
                try {
                    const response = await fetch('/api/stats');
                    const stats = await response.json();
                    
                    document.getElementById('total-todos').textContent = stats.total;
                    document.getElementById('completed-todos').textContent = stats.completed;
                    document.getElementById('pending-todos').textContent = stats.pending;
                    
                    const completionRate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
                    document.getElementById('completion-rate').textContent = `${completionRate}%`;
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }

            async addTodo() {
                const title = document.getElementById('todo-title').value.trim();
                const description = document.getElementById('todo-description').value.trim();
                const priority = document.getElementById('todo-priority').value;
                const category = document.getElementById('todo-category').value;
                const folderId = document.getElementById('todo-folder').value;

                if (!title) return;

                // Validar que existan carpetas
                if (this.folders.length === 0) {
                    this.showNotification(translations[this.currentLanguage].errors.no_folders, 'error');
                    return;
                }

                try {
                    const response = await fetch('/api/todos', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title,
                            description,
                            priority,
                            category,
                            folder_id: parseInt(folderId)
                        })
                    });

                    if (response.ok) {
                        // Preserve current folder selection instead of resetting to '1'
                        const currentFolderId = document.getElementById('todo-folder').value;

                        document.getElementById('add-todo-form').reset();
                        document.getElementById('todo-priority').value = 'medium';
                        document.getElementById('todo-category').value = 'general';

                        // Reset title textarea height
                        document.getElementById('todo-title').style.height = 'auto';

                        // Load folders and stats
                        await this.loadTodos();
                        await this.loadStats();
                        await this.loadFolders();

                        // Restore folder selection AFTER loadFolders() rebuilds the dropdown
                        document.getElementById('todo-folder').value = currentFolderId;

                        // Keep focus on title input for quick task entry
                        document.getElementById('todo-title').focus();

                        this.showNotification('Task added successfully', 'success');
                    } else {
                        throw new Error('Error adding task');
                    }
                } catch (error) {
                    this.showNotification('Error adding task', 'error');
                }
            }

            async toggleTodo(id) {
                // Find the task to check if it's currently completed
                const todo = this.todos.find(t => t.id === id);

                if (!todo || todo.completed) {
                    // If already completed or task not found, use toggle (for unarchive scenario)
                    try {
                        const response = await fetch(`/api/todos/${id}/toggle`, {
                            method: 'PUT'
                        });

                        if (response.ok) {
                            this.loadTodos();
                            this.loadStats();
                            this.loadFolders();
                        } else {
                            throw new Error('Error updating task');
                        }
                    } catch (error) {
                        this.showNotification('Error updating task', 'error');
                    }
                } else {
                    // Task is not completed - mark as completed AND archive
                    try {
                        const response = await fetch(`/api/todos/${id}/archive`, {
                            method: 'PUT'
                        });

                        if (response.ok) {
                            this.loadTodos();
                            this.loadStats();
                            this.loadFolders();
                            this.showNotification('Task completed and archived', 'success');
                        } else {
                            throw new Error('Error updating task');
                        }
                    } catch (error) {
                        this.showNotification('Error updating task', 'error');
                    }
                }
            }

            async deleteTodo(id) {
                try {
                    const response = await fetch(`/api/todos/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        this.loadTodos();
                        this.loadStats();
                        this.loadFolders();
                        this.showNotification('Task deleted successfully', 'success');
                    } else {
                        throw new Error('Error deleting task');
                    }
                } catch (error) {
                    this.showNotification('Error deleting task', 'error');
                }
            }

            // ============= NOTES FUNCTIONS =============

            async loadNotes() {
                try {
                    const response = await fetch('/api/notes');
                    const notes = await response.json();
                    this.renderNotes(notes);
                } catch (error) {
                    this.showNotification('Error loading notes', 'error');
                }
            }

            renderNotes(notes) {
                const container = document.getElementById('notes-list');

                if (notes.length === 0) {
                    container.innerHTML = `
                        <div class="notes-empty">
                            <i class="fas fa-sticky-note"></i>
                            <p data-i18n="notes.empty">No notes yet</p>
                            <p data-i18n="notes.empty_message" style="font-size: 0.9rem; margin-top: 8px;">Create your first note above</p>
                        </div>
                    `;
                    this.updateDynamicTranslations();
                    return;
                }

                container.innerHTML = notes.map(note => `
                    <div class="note-card">
                        <div class="note-content">${this.escapeHtml(note.content)}</div>
                        <div class="note-actions">
                            <span class="note-date">${this.formatDate(note.created_at)}</span>
                            <div class="note-buttons">
                                <button class="note-btn note-btn-copy" onclick="todoApp.copyNote(${note.id}, this)" data-note-content="${this.escapeHtml(note.content).replace(/"/g, '&quot;')}">
                                    <i class="fas fa-copy"></i>
                                    <span data-i18n="notes.copy">Copy</span>
                                </button>
                                <button class="note-btn note-btn-delete" onclick="todoApp.deleteNote(${note.id})">
                                    <i class="fas fa-trash"></i>
                                    <span data-i18n="notes.delete">Delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                this.updateDynamicTranslations();
            }

            async addNote() {
                const content = document.getElementById('note-content').value.trim();

                if (!content) {
                    this.showNotification('Please enter a note', 'error');
                    return;
                }

                try {
                    const response = await fetch('/api/notes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content })
                    });

                    if (response.ok) {
                        document.getElementById('note-content').value = '';
                        this.loadNotes();
                        this.showNotification('Note added successfully', 'success');
                    } else {
                        throw new Error('Error adding note');
                    }
                } catch (error) {
                    this.showNotification('Error adding note', 'error');
                }
            }

            async deleteNote(id) {
                try {
                    const response = await fetch(`/api/notes/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        this.loadNotes();
                        this.showNotification('Note deleted successfully', 'success');
                    } else {
                        throw new Error('Error deleting note');
                    }
                } catch (error) {
                    this.showNotification('Error deleting note', 'error');
                }
            }

            async copyNote(id, button) {
                // Get note content from data attribute
                const content = button.getAttribute('data-note-content');

                if (!content) {
                    this.showNotification('Error copying note', 'error');
                    return;
                }

                // Try modern clipboard API first, fallback to older method
                if (navigator.clipboard && window.isSecureContext) {
                    try {
                        await navigator.clipboard.writeText(content);
                        this.showCopyFeedback(button);
                        return;
                    } catch (err) {
                        // Fall through to fallback method
                    }
                }

                // Fallback method using textarea
                this.fallbackCopy(content, button);
            }

            fallbackCopy(text, button) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                textarea.style.top = '-999999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        this.showCopyFeedback(button);
                    } else {
                        this.showNotification('Error copying note', 'error');
                    }
                } catch (err) {
                    this.showNotification('Error copying note', 'error');
                }

                document.body.removeChild(textarea);
            }

            showCopyFeedback(button) {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> <span data-i18n="notes.copied">Copied!</span>';
                button.style.background = '#22c55e';

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
            }

            async moveTodoToFolder(todoId, newFolderId) {
                // Usar el endpoint PUT /api/todos/<id> con folder_id
                try {
                    const response = await fetch(`/api/todos/${todoId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folder_id: parseInt(newFolderId) })
                    });
                    if (response.ok) {
                        this.loadTodos();
                        this.loadFolders();
                        this.loadStats();
                        this.showNotification('Task moved successfully', 'success');
                    } else {
                        throw new Error('Error moving task');
                    }
                } catch (error) {
                    this.showNotification('Error moving task', 'error');
                }
            }

            renderTodos() {
                const container = document.getElementById('todos-container');
                
                if (this.todos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <h3>${translations[this.currentLanguage].empty.title}</h3>
                            <p>${translations[this.currentLanguage].empty.message}</p>
                        </div>
                    `;
                    this.updateDynamicTranslations();
                    return;
                }

                container.innerHTML = this.todos.map(todo => this.renderTodoItem(todo)).join('');
                this.updateDynamicTranslations();
            }

            renderTodoItem(todo) {
                const priorityClass = `priority-${todo.priority}`;
                const priorityText = {
                    'high': translations[this.currentLanguage].priority.high,
                    'medium': translations[this.currentLanguage].priority.medium,
                    'low': translations[this.currentLanguage].priority.low
                }[todo.priority];

                const categoryText = {
                    'work': translations[this.currentLanguage].categories.work,
                    'personal': translations[this.currentLanguage].categories.personal,
                    'study': translations[this.currentLanguage].categories.study,
                    'health': translations[this.currentLanguage].categories.health,
                    'general': translations[this.currentLanguage].categories.general
                }[todo.category];

                const isSelected = this.selectedTasks.has(String(todo.id));

                return `
                    <div class="todo-item ${todo.completed ? 'completed' : ''} ${isSelected ? 'selected' : ''} fade-in" data-todo-id="${todo.id}">
                        <div class="todo-checkbox-wrapper ${isSelected ? 'checked' : ''}" onclick="todoApp.toggleTaskSelection(${todo.id})"></div>
                        <input type="checkbox" class="todo-checkbox" ${isSelected ? 'checked' : ''} onchange="todoApp.toggleTaskSelection(${todo.id})">
                        <div class="todo-header">
                            <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                <div class="todo-title" title="${this.escapeHtml(todo.title)}">${this.escapeHtml(todo.title)}</div>
                                ${todo.description ? `<div class="todo-description" title="${this.escapeHtml(todo.description)}">${this.escapeHtml(todo.description)}</div>` : ''}
                                <div style="margin-top: 8px; position: relative;">
                                    <button class="btn btn-sm btn-secondary move-folder-btn" data-todo-id="${todo.id}" style="font-size:0.95em; padding:4px 12px;">
                                        <i class="fas fa-random"></i> ${translations[this.currentLanguage].folders.title}
                                    </button>
                                </div>
                            </div>
                            <div class="todo-actions">
                                <button class="btn btn-sm ${todo.added_to_today ? 'btn-warning' : 'btn-secondary'}"
                                        onclick="todoApp.toggleAddToToday(${todo.id})"
                                        title="${todo.added_to_today ? 'Remove from Today' : 'Add to Today'}">
                                    <i class="fas ${todo.added_to_today ? 'fa-calendar-minus' : 'fa-calendar-plus'}"></i>
                                    ${todo.added_to_today ? translations[this.currentLanguage].today.remove : translations[this.currentLanguage].today.add}
                                </button>
                                <button class="btn btn-sm ${todo.completed ? 'btn-secondary' : 'btn-success'}"
                                        onclick="todoApp.toggleTodo(${todo.id})">
                                    <i class="fas ${todo.completed ? 'fa-undo' : 'fa-check'}"></i>
                                    ${todo.completed ? translations[this.currentLanguage].actions.uncomplete : translations[this.currentLanguage].actions.complete}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="todoApp.deleteTodo(${todo.id})">
                                    <i class="fas fa-trash"></i>
                                    ${translations[this.currentLanguage].actions.delete}
                                </button>
                            </div>
                        </div>
                        <div class="todo-meta">
                            <span class="priority-badge ${priorityClass}">${priorityText}</span>
                            <span class="category-badge">${categoryText}</span>
                            <span class="folder-badge" style="background-color: ${todo.folder_color}">${todo.folder_name}</span>
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">
                                <i class="fas fa-clock"></i>
                                ${this.formatDate(todo.created_at)}
                            </small>
                        </div>
                    </div>
                `;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                const localeMap = {
                    'en': 'en-US',
                    'ar': 'ar-SA',
                    'es': 'es-ES'
                };
                return date.toLocaleDateString(localeMap[this.currentLanguage] || 'en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                container.appendChild(notification);
                
                // Show notification
                setTimeout(() => notification.classList.add('show'), 100);
                
                // Remove notification after 3 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => container.removeChild(notification), 300);
                }, 3000);
            }
        }

        // Initialize the app when the page loads
        let todoApp;
        document.addEventListener('DOMContentLoaded', () => {
            todoApp = new TodoApp();
        });
    </script>
</body>
</html> 